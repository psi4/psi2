      SUBROUTINE HAMAT(HM,TM,IOFF,JT1C,IOUT,DROL,HA11,HA22,HA12)
      IMPLICIT REAL*8 (A-H,O-Z)
C
      integer numij,norbs,nbset,ndf
      INTEGER IOFF(NUMIJ),JT1C(1),IOUT(NORBS),DROL(NORBS)
      REAL*8 TM(NUMIJ,NBSET),HM(NUMIJ),HA11(NDF),HA22(NDF),HA12(NDF)
      REAL*8 H11,H12,H22
      COMMON /TAPES/ NOUT,ICHK,IT30,IT42,IT47,IT52,IT58,IT94,IT96,IT98
      COMMON /DIMSG/ ISYMRB,NUMIJ,NBF,NMAX,NBFORB,NSYM,NDF,NORBS
      COMMON /POINT/ FOCC(5),IPOINT(5),JPOINT(5),NSORB(5)
      COMMON /FUNCS/ IOCC,JOCC,KOCC,NTYPES,NBSET,NAT
      COMMON /IEXT/ IPRINT,IGRP,ICIDIP
      COMMON /CALCJ/ ICALT,IDERT,ICIT
      COMMON /OCCS/ NSPE,NSA,NSB,NALP,NOP,NDOC,LFERM,NUOC,IJIND,IJIND3
      COMMON /TYPES/ NTYDOC,NTYUOC
      COMMON /TCSCF/ DERC1,DERC2,CI1,CI2,H11,H12,H22,ONE,ITCSCF
      DATA A0,A1S2,A2,A4 / 0.0D+00 , 0.5D+00 , 2.0D+00 , 4.0D+00 /
    1 FORMAT(//,2X,' HA MATRICES'/)
    2 FORMAT(//,2X,I5,5F15.8)
    3 FORMAT(//,2X,' HA11 MATRIX'/)
    4 FORMAT(//,2X,' HA22 MATRIX'/)
    5 FORMAT(//,2X,' HA12 MATRIX'/)
    6 FORMAT(//,2X,' D1N MATRIX'/)
    7 FORMAT(//,2X,' D1E MATRIX'/)
    8 FORMAT(//,2X,' D1W MATRIX'/)
    9 FORMAT(//,2X,' EGRAD MATRIX'/)
C
      IF(DABS(CI1).GT.DABS(CI2)) THEN
C
       IHA = JT1C(NDF+1)
       IEA = 2*NDF + NBSET*NDF
       ISEA = JT1C(IEA) + INTOWP(NUMIJ)
       DO 115 IDF=1,NDF
        IEA = IEA + 1
C
c       WRITE(*,*)' IN HAMAT READING HM AT ',IHA
        CALL WREADW(IT94,HM,INTOWP(NUMIJ),IHA,IHA)
c       CALL PRINT(HM,NUMIJ,NORBS,NOUT)
C
        DO 315 IBSET = 1,NBSET
         ITA = 2*NDF + (IDF-1)*NBSET + IBSET
         CALL WREADW(IT94,TM(1,IBSET),INTOWP(NUMIJ),JT1C(ITA),JUNK)
c        WRITE(*,*)' TM MATRIX IN FAMAT2 FOR DEGREE ',IDF,' AND SET ',
c    1               ibset
c        CALL PRINT(TM(1,IBSET),NUMIJ,NORBS,NOUT)
  315   CONTINUE
C
        ELEC1 = A0
        DO 110 I = LFERM,NDOC
         II = IOFF(I+1)
         ELEC1 = ELEC1 + HM(II)*A2
  110   CONTINUE
        ELEC2 = A0
        DO 111 I = LFERM,NDOC
         II = IOFF(I+1)
         ELEC2 = ELEC2 + TM(II,1)*A2 - TM(II,2)
  111   CONTINUE
C
        M = NSB
        N = NSA
        MM = IOFF(M+1)
        NN = IOFF(N+1)
        AH11 = HM(MM)*A2 + TM(MM,3)
        AH22 = HM(NN)*A2 + TM(NN,5)
        AH12 = TM(MM,6)
        DO 112 I = LFERM,NDOC
         II = IOFF(I+1)
         AH11 = AH11 + TM(II,3)*A4 - TM(II,4)*A2
         AH22 = AH22 + TM(II,5)*A4 - TM(II,6)*A2
  112   CONTINUE
        HA11(IDF) = ELEC1 + ELEC2 + AH11
        HA22(IDF) = ELEC1 + ELEC2 + AH22
        HA12(IDF) = AH12
CTJL    IF(IPRNT.LE.3) GO TO 115
CTJL    WRITE(6,2) IDF,ELEC1,ELEC2,AH11,AH22,AH12
  115  CONTINUE
C
C      IF(IPRNT.LE.2) GO TO 201
c      WRITE(6,3)
c      CALL MATOUT(HA11,3,NAT,3,NAT,6)
c      WRITE(6,4)
c      CALL MATOUT(HA22,3,NAT,3,NAT,6)
c      WRITE(6,5)
c      CALL MATOUT(HA12,3,NAT,3,NAT,6)
C
      ELSE
C
       IHA = JT1C(NDF+1)
       IEA = 2*NDF + NBSET*NDF
       ISEA = JT1C(IEA) + INTOWP(NUMIJ)
       DO 215 IDF=1,NDF
        IEA = IEA + 1
C
c       WRITE(*,*)' IN HAMAT READING HM AT ',IHA
        CALL WREADW(IT94,HM,INTOWP(NUMIJ),IHA,IHA)
c       CALL PRINT(HM,NUMIJ,NORBS,NOUT)
C
        DO 415 IBSET = 1,NBSET
         ITA = 2*NDF + (IDF-1)*NBSET + IBSET
         CALL WREADW(IT94,TM(1,IBSET),INTOWP(NUMIJ),JT1C(ITA),JUNK)
c        WRITE(*,*)' TM MATRIX IN FAMAT2 FOR DEGREE ',IDF,' AND SET ',
c    1               ibset
c        CALL PRINT(TM(1,IBSET),NUMIJ,NORBS,NOUT)
  415   CONTINUE
C
        ELEC1 = A0
        DO 210 I = LFERM,NDOC
         II = IOFF(I+1)
         ELEC1 = ELEC1 + HM(II)*A2
  210   CONTINUE
        ELEC2 = A0
        DO 211 I = LFERM,NDOC
         II = IOFF(I+1)
         ELEC2 = ELEC2 + TM(II,1)*A2 - TM(II,2)
  211   CONTINUE
C
        N = NSB
        M = NSA
        MM = IOFF(M+1)
        NN = IOFF(N+1)
        AH11 = HM(MM)*A2 + TM(MM,3)
        AH22 = HM(NN)*A2 + TM(NN,5)
        AH12 = TM(MM,6)
        DO 212 I = LFERM,NDOC
         II = IOFF(I+1)
         AH11 = AH11 + TM(II,3)*A4 - TM(II,4)*A2
         AH22 = AH22 + TM(II,5)*A4 - TM(II,6)*A2
  212   CONTINUE
        HA22(IDF) = ELEC1 + ELEC2 + AH11
        HA11(IDF) = ELEC1 + ELEC2 + AH22
        HA12(IDF) = AH12
CTJL    IF(IPRNT.LE.3) GO TO 215
CTJL    WRITE(6,2) IDF,ELEC1,ELEC2,AH11,AH22,AH12
  215  CONTINUE
C
C      IF(IPRNT.LE.2) GO TO 201
c      WRITE(6,3)
c      CALL MATOUT(HA11,3,NAT,3,NAT,6)
c      WRITE(6,4)
c      CALL MATOUT(HA22,3,NAT,3,NAT,6)
c      WRITE(6,5)
c      CALL MATOUT(HA12,3,NAT,3,NAT,6)
      END IF
C
C   CALCULATE SCF DERIVATIVES FOR A TEST
C 201 C1SQ = FOCC(2)*A1S2
C     C2SQ = FOCC(3)*A1S2
C     MN = M + IOFF(N)
C     C12P = BETA(MN)*A2
C     C1 = DSQRT(C1SQ)
C     C2 = DSQRT(C2SQ)
C     IF(BETA(MN).LT.ZERO) C2=-C2
C     DO 120 IABC=1,N3N
C     D1E(IABC) = H11A(IABC)*C1SQ + H22A(IABC)*C2SQ + H12A(IABC)*C12P
C     D1T(IABC) = D1E(IABC) + D1W(IABC)
C     E1T(IABC) = D1T(IABC)
C 120 CONTINUE
C     IF(IPRNT.LE.2) GO TO 202
C***  WRITE(6,6)
C***  CALL MATOUT(D1N,3,NATOMS,3,NATOMS,6)
C     WRITE(6,7)
C     CALL MATOUT(D1E,3,NATOMS,3,NATOMS,6)
C     WRITE(6,8)
C     CALL MATOUT(D1W,3,NATOMS,3,NATOMS,6)
C     WRITE(6,9)
C     CALL MATOUT(D1T,3,NATOMS,3,NATOMS,6)
C
C 202 CONTINUE
C     CALL SREW(ITAP44)
C     CALL SREW(JTAPE1)
      RETURN
      end
