      SUBROUTINE FAMAT2(EPA,BUF,HM,TM,IOFF,JT1C,IOUT,DROL,LSTEPA,ALPHA,
     1 BETA)
      IMPLICIT REAL*8 (A-H,O-Z)
C
      integer numij,norbs,nbset
      INTEGER IOFF(NUMIJ),JT1C(1),IOUT(NORBS),DROL(NORBS)
      REAL*8 EPA(NORBS,NORBS),TM(NUMIJ,NBSET),HM(NUMIJ)
      REAL*8 LSTEPA(NUMIJ),ALPHA(NUMIJ),BETA(NUMIJ),BUF(NUMIJ)
      COMMON /TAPES/ NOUT,ICHK,IT30,IT42,IT47,IT52,IT58,IT94,IT96,IT98
      COMMON /DIMSG/ ISYMRB,NUMIJ,NBF,NMAX,NBFORB,NSYM,NDF,NORBS
      COMMON /POINT/ FOCC(5),IPOINT(5),JPOINT(5),NSORB(5)
      COMMON /FUNCS/ IOCC,JOCC,KOCC,NTYPES,NBSET,NAT
      COMMON /IEXT/ IPRINT,IGRP,ICIDIP
      COMMON /CALCJ/ ICALT,IDERT,ICIT
      COMMON /OCCS/ NSPE,NSA,NSB,NALP,NOP,NDOC,LFERM,NUOC,IJIND,IJIND3
      COMMON /TYPES/ NTYDOC,NTYUOC
C
      DATA A0,A1S2 / 0.0D+00 , 0.5D+00 /
C
C   CALL BACK HM AND TM MATRICES AND FORM FA MATRICES
C   SEE EQS.(15) AND (32)
C
      IHA = JT1C(NDF+1)
      IEA = 2*NDF + NBSET*NDF
      ISEA = JT1C(IEA) + INTOWP(NUMIJ)
C
      NUMORB = NTYDOC + NTYUOC + 2
      IF(NUMORB.NE.NBF) THEN
       WRITE(*,*) ' NUMBER OF ORBITALS DOES NOT ADD UP IN FAMAT2 '
       WRITE(*,*) ' NUMORB,NBF ',NUMORB,NBF
       CALL MABORT
      END IF
C
      DO 1 IDF=1,NDF
       IEA = IEA + 1
       CALL ZERO(EPA,NORBS*NORBS)
CTJL   WRITE(*,*)' IN FAMAT2 READING HM AT ',IHA
C      CALL MATOUT(EPA,NORBS,NORBS,NORBS,NORBS,NOUT)
       CALL WREADW(IT94,HM,INTOWP(NUMIJ),IHA,IHA)
CTJL   CALL PRINT(HM,NUMIJ,NORBS,NOUT)
C
       DO 2 IBSET = 1,NBSET
        ITA = 2*NDF + (IDF-1)*NBSET + IBSET
CTJL    WRITE(*,*)' IDF,IBSET,ITA,JT1C ',IDF,IBSET,ITA,JT1C(ITA)
        CALL WREADW(IT94,TM(1,IBSET),INTOWP(NUMIJ),JT1C(ITA),JUNK)
CTJL    WRITE(*,*)' TM MATRIX IN FAMAT2 FOR DEGREE ',IDF,' AND SET ',IBSET
CTJL    CALL PRINT(TM(1,IBSET),NUMIJ,NORBS,NOUT)
  2    CONTINUE
C
C   STORE DERIVATIVE LAGRANGIAN MATRICES
       DO 3 ITYP = 1,NTYPES
        IMIN = JPOINT(ITYP)
        IMAX = JPOINT(ITYP+1) - 1
        FAC = FOCC(ITYP)*A1S2
        DO 5 IYY = IMIN,IMAX
         IBF = DROL(IYY)
         IORB = IOUT(IBF)
         DO 6 JORB = 1,NBF
          IJ = IOFF(MAX0(IORB,JORB)) + MIN0(IORB,JORB)
          VALU = HM(IJ)*FAC
          DO 4 KTYP = 1,NTYPES
           KYY = JPOINT(KTYP)
           KBF = DROL(KYY)
           KORB = IOUT(KBF)
           IK = IOFF(MAX0(IORB,KORB)) + MIN0(IORB,KORB)
CTJL       WRITE(*,*) ' I,J,K,A,B,TMA '
CTJL       WRITE(*,*)IORB,JORB,KORB,ALPHA(IK),BETA(IK),TM(IJ,KTYP*2-1)
           VALU = VALU + ALPHA(IK)*TM(IJ,KTYP*2-1)
     1            + BETA(IK)*TM(IJ,KTYP*2)
  4       CONTINUE
          EPA(IORB,JORB) = VALU
  6      CONTINUE
  5     CONTINUE
  3    CONTINUE
C
       JT1C(IEA) = ISEA
       CALL WWRITW(IT94,EPA,INTOWP(NORBS*NORBS),ISEA,ISEA)
CTJL   WRITE(6,*) ' EPA MATRIX FOR DEGREE OF FREEDOM ',IDF
CTJL   CALL MATOUT(EPA,NBF,NBF,NBF,NBF,6)
  1   CONTINUE
C
C   STORE DERIVATIVE AVERAGED FOCK
      CALL RFILE(IT96)
      ISEA = 1
      IADHA = JT1C(NDF+1)
CTJL  IADTA = JT1C(2*NDF+(NBSET-1)*NDF+1)
      DO 15 IDF=1,NDF
       IADTA = JT1C(2*NDF+IDF*NBSET)
       CALL WREADW(IT94,HM,INTOWP(NUMIJ),IADHA,IADHA)
       CALL WREADW(IT94,TM,INTOWP(NUMIJ),IADTA,IADTA)
CTJL   CALL ZERO(TM,NUMIJ)
       DO 14 I=1,NUMIJ
        BUF(I)=HM(I)+TM(I,1)
  14   CONTINUE
CTJL   WRITE(6,*) ' EAVF MATRIX FOR DEGREE OF FREEDOM ',IDF
CTJL   CALL PRINT(BUF,NUMIJ,NBF,6)
       CALL WWRITW(IT96,BUF,INTOWP(NUMIJ),ISEA,ISEA)
  15  CONTINUE
C
      RETURN
      END
