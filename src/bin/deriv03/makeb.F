      SUBROUTINE MAKEB(B,D,DT,Q4)
      IMPLICIT REAL*8 (A-H,O-Z)
      COMMON/BASIS/NBASIS,NBFAO,NBATRI,NBATR2
      COMMON/CALCS/ISTYPE,ICTYPE,IRAMAN,IAFOCK,IDFOCK,IDINT
      COMMON/CENTR/NCENTR
      COMMON/COUPL/ALP(5,5),BET(5,5)
      COMMON/FUNCS/NTYPES,NTYPEP,NTREAD,NATOM,N3N,NATRI,NSYM
      COMMON/PARA3/NATMS(4),NPASS
      COMMON/PARA4/MMIJ,MMKL,ISAME(100)
ctph  COMMON/POSIX/IPOS(100),JPOS(100),KPOS(100),LPOS(100),IMUL(100)
      COMMON/POSIX/IPOS(225),JPOS(225),KPOS(225),LPOS(225),IMUL(225)
      COMMON/SIGNS/IOFF(256),IPRNT
      COMMON/TOLER/DLIM
      DIMENSION B(NBATRI,N3N,NTREAD),D(NBATRI,NTYPEP),DT(NBATRI)
      DIMENSION M(6),DENS(6),NUMC(4)
      EQUIVALENCE (DENS(1),DIJ),(DENS(2),DKL),(DENS(3),DJL)
      EQUIVALENCE (DENS(4),DIL),(DENS(5),DIK),(DENS(6),DJK)
      EQUIVALENCE (M(1),MKL),(M(2),MIJ),(M(3),MIK)
      EQUIVALENCE (M(4),MJK),(M(5),MJL),(M(6),MIL)
      DATA NUMC/4,3,3,2/
      DATA ZERO,HALF,TWO,FOUR / 0.0D+00 , 0.5D+00 , 2.0D+00 , 4.0D+00 /
C
      NCENTR=NUMC(NPASS)
C
      NN=0
      DO 110 II=1,MMIJ
      IT=IPOS(II)
      JT=JPOS(II)
      NFAC=IMUL(II)
      DO 109 JJ=1,MMKL
      KT=KPOS(JJ)
      LT=LPOS(JJ)
      NN=NN+1
      IJT=IOFF(MAX0(IT,JT))+MIN0(IT,JT)
      KLT=IOFF(MAX0(KT,LT))+MIN0(KT,LT)
      IF(IJT.LT.KLT) GO TO 301
      I=MAX0(IT,JT)
      J=MIN0(IT,JT)
      K=MAX0(KT,LT)
      L=MIN0(KT,LT)
      GO TO 302
  301 CONTINUE
      I=MAX0(KT,LT)
      J=MIN0(KT,LT)
      K=MAX0(IT,JT)
      L=MIN0(IT,JT)
C
  302 CONTINUE
      MIJ=IOFF(MAX0(I,J))+MIN0(I,J)
      MKL=IOFF(MAX0(K,L))+MIN0(K,L)
      MIK=IOFF(MAX0(I,K))+MIN0(I,K)
      MJL=IOFF(MAX0(J,L))+MIN0(J,L)
      MIL=IOFF(MAX0(I,L))+MIN0(I,L)
      MJK=IOFF(MAX0(J,K))+MIN0(J,K)
C
      FACT=Q4
      IF(I.EQ.J) FACT=FACT*HALF
      IF(K.EQ.L) FACT=FACT*HALF
C
C     ----- THIS FACTOR OF TWO IS NEEDED BECAUSE ONLY GENERATE
C               ONE OF TWO POSSIBLE DERIVATIVES OF [II,KL]     -----
C
      FACT=FACT*DFLOAT(NFAC)
C
      GO TO (201,203,203,203,204,204),ISTYPE
      STOP ' WRONG ISTYPE '
C
C     ----- CLOSED SHELL SINGLET -----
C
  201 CONTINUE
      FAC4=FACT*FOUR
      DIJ=DT(MIJ)*FAC4
      DKL=DT(MKL)*FAC4
      DJL=-DT(MJL)*FACT
      DIL=-DT(MIL)*FACT
      DIK=-DT(MIK)*FACT
      DJK=-DT(MJK)*FACT
C
      CALL MBMAT(B,DENS,M,NN,1)
      GO TO 205
C
C     ----- HIGH-SPIN OPEN-SHELL -----
C
C*202 CONTINUE
C---TEMPORARILY COMMENTED OUT---USE GENERAL OPEN-SHELL FORMALISM
C*    FAC2=FACT+FACT
C*    FAC4=FAC2+FAC2
C*    DIJ=DT(MIJ)*FAC4
C*    DKL=DT(MKL)*FAC4
C*    DJL=-D(MJL,1)*FAC2
C*    DIL=-D(MIL,1)*FAC2
C*    DIK=-D(MIK,1)*FAC2
C*    DJK=-D(MJK,1)*FAC2
C*
C*    CALL MBMAT(B,DENS,M,NN,1)
C*
C*    DJL=D(MJL,2)*FAC2
C*    DIL=D(MIL,2)*FAC2
C*    DIK=D(MIK,2)*FAC2
C*    DJK=D(MJK,2)*FAC2
C*
C*    CALL MBMAT2(B,DENS,M,NN,2)
C*    GO TO 205
C
C     ----- OPEN-SHELL SINGLET AND GENERAL OPEN SHELL -----
C
  203 CONTINUE
c12-1-88  Put in part needed for CI gradient  (GRSCF)
      IF(ICTYPE.EQ.2) THEN
        DIJ = DT(MIJ) * FACT * 4.0D0
        DKL = DT(MKL) * FACT * 4.0D0
        DJL = -DT(MJL) * FACT
        DIL = -DT(MIL) * FACT
        DIK = -DT(MIK) * FACT
        DJK = -DT(MJK) * FACT
ctph  write(6,*) 'dt  mij ',dt(mij)
        CALL MBMAT(B,DENS,M,NN,NTYPEP)
ctph    FACT = FACT + FACT
      ENDIF
C   FOR OCCUPIED SPACE
      FAC2=FACT+FACT
      DO 102 ITYP=1,NTYPES
      DIJ=ZERO
      DKL=ZERO
      DJL=ZERO
      DIL=ZERO
      DIK=ZERO
      DJK=ZERO
      DO 101 JTYP=1,NTYPES
ctph  write(6,*) 'd alp bet mij ityp jtyp',d(mij,jtyp),alp(ityp,jtyp),
ctph +           bet(ityp,jtyp),mij,ityp,jtyp
      DIJ=DIJ+D(MIJ,JTYP)*ALP(ITYP,JTYP)
      DKL=DKL+D(MKL,JTYP)*ALP(ITYP,JTYP)
      DJL=DJL+D(MJL,JTYP)*BET(ITYP,JTYP)
      DIL=DIL+D(MIL,JTYP)*BET(ITYP,JTYP)
      DIK=DIK+D(MIK,JTYP)*BET(ITYP,JTYP)
      DJK=DJK+D(MJK,JTYP)*BET(ITYP,JTYP)
  101 CONTINUE
      DIJ=DIJ*FAC2
      DKL=DKL*FAC2
      DJL=DJL*FACT
      DIL=DIL*FACT
      DIK=DIK*FACT
      DJK=DJK*FACT
C
      CALL MBMAT(B,DENS,M,NN,ITYP)
  102 CONTINUE
C
C   FOR CORES AND VIRTUALS
      IF(NTYPES.EQ.1) GO TO 205
      IF(IAFOCK.EQ.0) GO TO 205
      FAC4=FAC2+FAC2
      DIJ=DT(MIJ)*FAC4
      DKL=DT(MKL)*FAC4
      DJL=-DT(MJL)*FACT
      DIL=-DT(MIL)*FACT
      DIK=-DT(MIK)*FACT
      DJK=-DT(MJK)*FACT
C
      CALL MBMAT(B,DENS,M,NN,NTREAD)
      GO TO 205
C
C     ----- TWO-CONFIGURATION SCF (GVB) -----
C
  204 CONTINUE
C   FOR OCCUPIED SPACE
      FAC2=FACT+FACT
      DO 103 ITYP=1,NTYPES
      DIJ=D(MIJ,ITYP)*FAC2
      DKL=D(MKL,ITYP)*FAC2
      DJL=D(MJL,ITYP)*FACT
      DIL=D(MIL,ITYP)*FACT
      DIK=D(MIK,ITYP)*FACT
      DJK=D(MJK,ITYP)*FACT
C
      CALL MBMATC(B,DENS,M,NN,ITYP)
  103 CONTINUE
C
C   FOR CORES AND VIRTUALS
      IF(IAFOCK.EQ.0) GO TO 205
      FAC4=FAC2+FAC2
      DIJ=DT(MIJ)*FAC4
      DKL=DT(MKL)*FAC4
      DJL=-DT(MJL)*FACT
      DIL=-DT(MIL)*FACT
      DIK=-DT(MIK)*FACT
      DJK=-DT(MJK)*FACT
C
      CALL MBMAT(B,DENS,M,NN,NTREAD)
C
  205 CONTINUE
C
  109 CONTINUE
  110 CONTINUE
C
      RETURN
      END
