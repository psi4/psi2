      SUBROUTINE DENS30(DENS,DENT,EIG,OCC,EAO)
      IMPLICIT REAL*8 (A-H,O-Z)
cets030691
#include <error.h>
      integer ip, prcntr
      COMMON/BASIS/NBASIS,NBFAO,NBATRI,NBATR2,NTRI,NTRI2
      COMMON/CALCS/ISTYPE,ICTYPE,IRAMAN,IAFOCK,IDFOCK,IDINT
      COMMON/FUNCS/NTYPES,NTYPEP,NTREAD,NATOM,N3N,NATRI,NSYM
      COMMON/OPEN1/NUNIQ,LOPN(5),MOPN(5,5)
      COMMON/SIGNS/IOFF(256),IPRNT
      COMMON/START/FOCC(10),NSORB(10),NSTR(10),NEND(10),MOTYP(256)
      COMMON/TOLER/DLIM
      DIMENSION DENS(NBATRI,NTYPEP),DENT(NBATRI)
      DIMENSION EIG(NBASIS),OCC(NBASIS),EAO(NBFAO,NBASIS)
      DATA ZERO,ONE,TWO / 0.0D+00 , 1.0D+00 , 2.0D+00 /
    1 FORMAT(//,2X,' PARAMETERS'/
     * 2X,' NBASIS = ',I8/
     * 2X,' NBFAO  = ',I8/
     * 2X,' NBATRI = ',I8/
     * 2X,' NATOM  = ',I8/
     * 2X,' N3N    = ',I8/
     * 2X,' NATRI  = ',I8/
     * 2X,' IOCC   = ',I8/
     * 2X,' JOCC   = ',I8/
     * 2X,' KOCC   = ',I8/
     * 2X,' NTYPES = ',I8/
     * 2X,' NTYPEP = ',I8/
     * 2X,' ISTYPE = ',I8/
     * 2X,' ICTYPE = ',I8/
     * 2X,' NDERIV = ',I8/
     * 2X,' IAFOCK = ',I8/
     * 2X,' IDFOCK = ',I8/
     * 2X,' IDINT  = ',I8/
     * 2X,' IPRNT  = ',I8/)
    2 FORMAT(//,2X,' TOTAL DENSITY MATRIX'/)
    3 FORMAT(//,2X,' SHELL DENSITY MATRIX, ITYP = ',I5/)
    4 FORMAT(//,2X,' AVERAGE DENSITY MATRIX'/)
C
cets030691      IF(IPRNT.GT.3)
      ip = prcntr('IS_ON DEBUG')
      if(ip.eq.1) WRITE(6,1) NBASIS,NBFAO,NBATRI,NATOM,N3N,
     1  NATRI,IOCC,JOCC,KOCC,NTYPES,NTYPEP,ISTYPE,ICTYPE,
     2  IRAMAN,IAFOCK,IDFOCK,IDINT,IPRNT
C
C   FORM THE TOTAL DENSITY MATRIX
      IJ=0
      DO 102 I=1,NBFAO
      DO 102 J=1,I
      IJ=IJ+1
      VALU=ZERO
      DO 101 K=1,NBASIS
      IF(OCC(K).LE.ZERO) GO TO 101
      VALU=VALU+EAO(I,K)*EAO(J,K)*OCC(K)
  101 CONTINUE
      DENT(IJ)=VALU
  102 CONTINUE
c
cets030691      IF(IPRNT.LE.3) GO TO 201
      ip = prcntr('IS_ON DEBUG')
      if(ip.eq.1) then
        write(6,*)' in dens30. this is an scf calculation!'
        write(6,*)' density matrix is'
        WRITE(6,2)
        CALL PRINT(DENT,NBATRI,NBFAO,6)
      endif
  201 CONTINUE
c     
      GO TO (310,301,302,303,304,305),ISTYPE
C
C   HIGH-SPIN OPEN-SHELL SCF
  301 CONTINUE
      NDENTS=2
      IJ=0
      DO 104 I=1,NBFAO
      DO 104 J=1,I
      IJ=IJ+1
      VALC=ZERO
      VALO=ZERO
      DO 103 K=1,NBASIS
      FAC=OCC(K)
      IF(FAC.EQ.ZERO) GO TO 103
      PROD=EAO(I,K)*EAO(J,K)
      IF(FAC.EQ.ONE) GO TO 202
      VALC=VALC+PROD
      GO TO 103
  202 CONTINUE
      VALO=VALO+PROD
  103 CONTINUE
      DENS(IJ,1)=VALC*TWO
      DENS(IJ,2)=VALO
  104 CONTINUE
      GO TO 310
C
C   OPEN-SHELL SINGLET SCF
  302 CONTINUE
      NDENTS=4
      IJ=0
      DO 106 I=1,NBFAO
      DO 106 J=1,I
      IJ=IJ+1
      VALC=ZERO
      VALO=ZERO
      VALO1=ZERO
      VALO2=ZERO
      II=0
      DO 105 K=1,NBASIS
      FAC=OCC(K)
      IF(FAC.EQ.ZERO) GO TO 105
      PROD=EAO(I,K)*EAO(J,K)
      IF(FAC.EQ.ONE) GO TO 203
      VALC=VALC+PROD
      GO TO 105
  203 CONTINUE
      VALO=VALO+PROD
      II=II+1
      IF(II.GE.2) GO TO 204
      VALO1=VALO1+PROD
      GO TO 105
  204 CONTINUE
      VALO2=VALO2+PROD
  105 CONTINUE
      DENS(IJ,1)=VALC*TWO
      DENS(IJ,2)=VALO
      DENS(IJ,3)=VALO1
      DENS(IJ,4)=VALO2
  106 CONTINUE
      GO TO 310
C
C   GENERAL OPEN-SHELL SCF
C   FOR CLOSED SHELL
  303 CONTINUE
      NDENTS=NUNIQ+1
      IJ=0
      DO 108 I=1,NBFAO
      DO 108 J=1,I
      IJ=IJ+1
      VALU=ZERO
      DO 107 K=1,NBASIS
      FAC=OCC(K)
      IF(FAC.NE.TWO) GO TO 107
      VALU=VALU+EAO(I,K)*EAO(J,K)
  107 CONTINUE
      DENS(IJ,1)=VALU*TWO
  108 CONTINUE
C
C   FOR OPEN-SHELLS
      IF(NUNIQ.EQ.0) GO TO 310
      DO 115 ITYP=1,NUNIQ
      ITT=ITYP+1
      COEF=FOCC(ITT)
      NN=LOPN(ITYP)
      IJ=0
      DO 114 I=1,NBFAO
      DO 114 J=1,I
      IJ=IJ+1
      II=0
      VALU=ZERO
      DO 113 K=1,NBASIS
      FAC=OCC(K)
      IF(FAC.EQ.ZERO.OR.FAC.EQ.TWO) GO TO 113
      II=II+1
      IF(FAC.NE.COEF) GO TO 113
      DO 112 L=1,NN
      IF(MOPN(ITYP,L).NE.II) GO TO 112
      VALU=VALU+EAO(I,K)*EAO(J,K)
  112 CONTINUE
  113 CONTINUE
      DENS(IJ,ITT)=VALU*COEF*TWO
  114 CONTINUE
  115 CONTINUE
       GO TO 307
C
C   TWO-CONFIGURATION SCF---GRSCF FORMALISM
  304 CONTINUE
      NDENTS=3
      DO 118 ITYP=1,NTYPES
      FAC=FOCC(ITYP)
      IJ=0
      DO 117 I=1,NBFAO
      DO 117 J=1,I
      IJ=IJ+1
      VALU=ZERO
      DO 116 K=1,NBASIS
      IF(FAC.NE.OCC(K)) GO TO 116
      VALU=VALU+EAO(I,K)*EAO(J,K)
  116 CONTINUE
      DENS(IJ,ITYP)=VALU*TWO
  117 CONTINUE
  118 CONTINUE
      GO TO 307
C
C   TWO-CONFIGURATION SCF
  305 CONTINUE
      NDENTS=4
      IJ=0
      DO 120 I=1,NBFAO
      DO 120 J=1,I
      IJ=IJ+1
      VALC=ZERO
      VALO=ZERO
      VALO1=ZERO
      VALO2=ZERO
      II=0
      DO 119 K=1,NBASIS
      FAC=OCC(K)
      IF(FAC.EQ.ZERO) GO TO 119
      PROD=EAO(I,K)*EAO(J,K)
      IF(FAC.NE.TWO) GO TO 206
      VALC=VALC+PROD
      GO TO 119
  206 CONTINUE
      VALO=VALO+PROD*FAC
      II=II+1
      IF(II.GE.2) GO TO 207
      VALO1=VALO1+PROD*FAC
      GO TO 119
  207 CONTINUE
      VALO2=VALO2+PROD*FAC
  119 CONTINUE
      DENS(IJ,1)=VALC*TWO
      DENS(IJ,2)=VALO
      DENS(IJ,3)=VALO1
      DENS(IJ,4)=VALO2
  120 CONTINUE
C
C   FORM THE DENSITY MATRIX FOR THE AVERAGED FOCK
  307 CONTINUE
C     IF(IAFOCK.EQ.0) GO TO 310
C     NDENTS=NDENTS+1
C     IJ=0
C     DO 122 I=1,NBFAO
C     DO 122 J=1,I
C     IJ=IJ+1
C     VALU=ZERO
C     DO 121 K=1,NBASIS
C     KTYP=MOTYP(K)
C     FAC=FOCC(KTYP)
C     VALU=VALU+EAO(I,K)*EAO(J,K)*FAC
C 121 CONTINUE
C     DENS(IJ,NTYPEP)=VALU
C 122 CONTINUE
C     IF(IPRNT.LE.3) GO TO 310
C     WRITE(6,3)
C     CALL PRINT(DENS(1,NTYPEP),NBATRI,NBFAO,6)
C
C
  310 CONTINUE
cets030691      IF(IPRNT.LE.3) GO TO 210
      ip = prcntr('IS_ON DEBUG')
      if(ip.eq.1) then
        DO 125 ITYP=1,NDENTS
          WRITE(6,3) ITYP
          CALL PRINT(DENS(1,ITYP),NBATRI,NBFAO,6)
  125   CONTINUE
      endif
C
  210 CONTINUE
      RETURN
      END
