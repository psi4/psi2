      SUBROUTINE PHIMAT(BXY,CXY,BXYZ,CXYZ,F3Q,EE)
C   THE CALCULATION OF PHI MATRICES
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION BXY(3,3,N3N),CXY(3,3,N3N)
      DIMENSION BXYZ(3,3,3,N3N),CXYZ(3,3,3,N3N)
      DIMENSION F3Q(N3N,N3N,N3N),EE(N3N,N3N)
      COMMON/VIB101/NATOM,N3N,NATRI,ILIN,NVIB
      COMMON/VIB102/ITHREE,IFOUR,N3TOT,N4TOT
      COMMON/VIB106/ROTAA(3),ROTGC(3),ROTCM(3),ROTMH(3)
      COMMON/VIB108/IAXIS(3),NDEG(150),NDAB(150,5),IMAG(150)
      COMMON/VIB203/IOFF(150),IPRNT
      COMMON/VIB204/SQM(150),ROOT(150),FREQ(150)
      COMMON/VIB205/IFREQ,NFRQ(150)
      COMMON/VIB207/TABCD(3,3,3,3),PABC(3,3,3)
      DATA WLIMIT / 1.0D-02 /
      DATA RLIMIT / 1.0D-05 /
      DATA PH,AVN / 6.626176D+00 , 6.022045D+00 /
      DATA PI,CL / 3.1415926536D+00 , 2.99792458D+00 /
      DATA A00,HALF,ONE,TWO / 0.0D+00 , 0.5D+00 , 1.0D+00 , 2.0D+00 /
    1 FORMAT(//,2X,' ****************************'/
     1          2X,' ***THE PHI (ABC) MATRICES***'/
     2          2X,' ****************************')
    2 FORMAT(//,2X,' PHI (A) MATIRX (IN D-08 CM-1)',
     1         13X,' PHI (B) MATRIX (IN D-08 CM-1)',
     2         13X,' PHI (C) MATRIX (IN D-08 CM-1)'/)
C
      WRITE(6,1)
      IXX=1
      IYY=2
      IZZ=3
C
C   FORM PHI MATRIX
      CALL ZERO(PABC,3*3*3)
C
C   PHI(IA,IA,IA) ELEMENTS
      DO 105 IA=1,3
      IAA=IAXIS(IA)
      VALU1=A00
      VALU2=A00
      VALU3=A00
      VALU4=A00
      DO 101 IB=1,3
      IBB=IAXIS(IB)
      IF(ROTCM(IBB).LE.RLIMIT) GO TO 101
      FACT1=TABCD(IA,IA,IA,IB)**2
      VALU1=VALU1+FACT1/ROTCM(IBB)
  101 CONTINUE
      DO 102 IVIB=1,NVIB
      FRQI=FREQ(IVIB)
      FACT2=CXYZ(IA,IA,IA,IVIB)**2
      VALU2=VALU2-FRQI*FACT2
  102 CONTINUE
      DO 103 IVIB=1,NVIB
      DO 103 JVIB=1,NVIB
      DO 103 KVIB=1,NVIB
      FACT3=CXY(IA,IA,IVIB)*CXY(IA,IA,JVIB)*CXY(IA,IA,KVIB)
      VALU3=VALU3+FACT3*F3Q(IVIB,JVIB,KVIB)
  103 CONTINUE
      DO 104 IB=1,3
      IBB=IAXIS(IB)
      IF(IA.EQ.IB) GO TO 104
      FACT4=TABCD(IA,IA,IA,IB)**2
      ROTAB=ROTCM(IAA)-ROTCM(IBB)
      IF(DABS(ROTAB).LE.RLIMIT) GO TO 104
      VALU4=VALU4+FACT4/ROTAB
  104 CONTINUE
      VALUT=(VALU1*3.0D+00/16.0D+00)+VALU2*TWO
     1      +VALU3/6.0D+00+VALU4/4.0D+00
      PABC(IA,IA,IA)=VALUT
  105 CONTINUE
C
C   PHI(IA,IA,IB) ELEMENTS
      DO 110 IA=1,3
      DO 110 IB=1,3
      IAA=IAXIS(IA)
      IBB=IAXIS(IB)
      IF(IA.EQ.IB) GO TO 110
      VALU1=A00
      VALU2=A00
      VALU3=A00
      VALU4=A00
      VALU5=A00
      VALU6=A00
      DO 106 IC=1,3
      ICC=IAXIS(IC)
      IF(ROTCM(ICC).LE.RLIMIT) GO TO 106
      FAC1=TABCD(IA,IA,IB,IC)+TABCD(IA,IB,IA,IC)*TWO
      FAC2=TABCD(IB,IB,IA,IC)+TABCD(IA,IB,IB,IC)*TWO
      FACT1=FAC1*FAC1+TABCD(IA,IA,IA,IC)*FAC2*TWO
      VALU1=VALU1+FACT1/ROTCM(ICC)
  106 CONTINUE
      DO 107 IVIB=1,NVIB
      FRQI=FREQ(IVIB)
      FACT2=CXYZ(IA,IA,IB,IVIB)**2
     1     +CXYZ(IA,IA,IA,IVIB)*CXYZ(IA,IB,IB,IVIB)*TWO
      VALU2=VALU2-FACT2*FRQI
  107 CONTINUE
      DO 108 IVIB=1,NVIB
      DO 108 JVIB=1,NVIB
      DO 108 KVIB=1,NVIB
      FACT3=CXY(IA,IA,IVIB)*(CXY(IA,IA,JVIB)*CXY(IB,IB,KVIB)
     1                      +CXY(IA,IB,JVIB)*CXY(IA,IB,KVIB)*4.0D+00)
      VALU3=VALU3+FACT3*F3Q(IVIB,JVIB,KVIB)
  108 CONTINUE
      ROTAB=ROTCM(IAA)-ROTCM(IBB)
      IF(DABS(ROTAB).LE.RLIMIT) GO TO 201
      FACT4=TABCD(IA,IA,IA,IB)*(TABCD(IB,IB,IB,IA)*4.0D+00
     1                         -TABCD(IA,IA,IA,IB)*3.0D+00)
      VALU4=FACT4/ROTAB
  201 CONTINUE
      DO 109 IC=1,3
      ICC=IAXIS(IC)
      IF(IC.EQ.IA) GO TO 109
      IF(IC.EQ.IB) GO TO 109
      ROTAC=ROTCM(IAA)-ROTCM(ICC)
      ROTAC2=ROTAC*ROTAC
      ROTAB=ROTCM(IAA)-ROTCM(IBB)
      IF(DABS(ROTAC).LE.RLIMIT) GO TO 202
      FACT5=ROTAC*(TABCD(IB,IB,IA,IC)+TABCD(IB,IA,IB,IC)*TWO)
     1     +ROTAB*(TABCD(IC,IC,IC,IA)-TABCD(IA,IA,IA,IC))
      VALU5=VALU5+(FACT5*TABCD(IA,IA,IA,IC))/ROTAC2
  202 CONTINUE
      ROTBC=ROTCM(IBB)-ROTCM(ICC)
      ROTBC2=ROTBC*ROTBC
      IF(DABS(ROTBC).LE.RLIMIT) GO TO 109
      FACT6=ROTBC*(TABCD(IA,IA,IB,IC)+TABCD(IA,IB,IA,IC)*TWO)
     1     +ROTAB*(TABCD(IB,IB,IB,IC)-TABCD(IC,IC,IC,IB))*TWO
      VALU6=VALU6+(FACT6*(TABCD(IA,IA,IB,IC)
     1                   +TABCD(IA,IB,IA,IC)*TWO))/ROTBC2
  109 CONTINUE
      VALUT=(VALU1*3.0D+00/32.0D+00)+VALU2+VALU3/4.0D+00
     1      +VALU4/8.0D+00+VALU5/4.0D+00+VALU6/8.0D+00
      PABC(IA,IA,IB)=VALUT
      PABC(IA,IB,IA)=VALUT
      PABC(IB,IA,IA)=VALUT
  110 CONTINUE
C
C   PHI(IA,IB,IC) ELEMENTS
      VALU1=A00
      VALU2=A00
      VALU3=A00
      VALU4=A00
      VALU5=A00
      VALU6=A00
      DO 111 IA=1,3
      IAA=IAXIS(IA)
      IF(ROTCM(IAA).LE.RLIMIT) GO TO 111
      FACT=TABCD(IA,IXX,IYY,IZZ)+TABCD(IA,IYY,IZZ,IXX)
     1    +TABCD(IA,IZZ,IXX,IYY)
      FAC1=FACT*FACT*TWO
      FAC2=(TABCD(IA,IXX,IYY,IYY)+TABCD(IA,IYY,IXX,IYY)*TWO)
     1    *(TABCD(IA,IXX,IZZ,IZZ)+TABCD(IA,IZZ,IXX,IZZ)*TWO)
      FAC3=(TABCD(IA,IYY,IZZ,IZZ)+TABCD(IA,IZZ,IYY,IZZ)*TWO)
     1    *(TABCD(IA,IYY,IXX,IXX)+TABCD(IA,IXX,IYY,IXX)*TWO)
      FAC4=(TABCD(IA,IZZ,IXX,IXX)+TABCD(IA,IXX,IZZ,IXX)*TWO)
     1    *(TABCD(IA,IZZ,IYY,IYY)+TABCD(IA,IYY,IZZ,IYY)*TWO)
      VALU1=VALU1+(FAC1+FAC2+FAC3+FAC4)/ROTCM(IAA)
  111 CONTINUE
      DO 112 IVIB=1,NVIB
      FRQI=FREQ(IVIB)
      FACT2=CXYZ(IXX,IYY,IZZ,IVIB)**2*TWO
     1     +CXYZ(IYY,IYY,IXX,IVIB)*CXYZ(IZZ,IZZ,IXX,IVIB)
     2     +CXYZ(IZZ,IZZ,IYY,IVIB)*CXYZ(IXX,IXX,IYY,IVIB)
     3     +CXYZ(IXX,IXX,IZZ,IVIB)*CXYZ(IYY,IYY,IZZ,IVIB)
      VALU2=VALU2-FRQI*FACT2
  112 CONTINUE
      DO 113 IVIB=1,NVIB
      DO 113 JVIB=1,NVIB
      DO 113 KVIB=1,NVIB
      FACT3=CXY(IXX,IXX,IVIB)*CXY(IYY,IYY,JVIB)*CXY(IZZ,IZZ,KVIB)
     1     +CXY(IXX,IXX,IVIB)*CXY(IYY,IZZ,JVIB)*CXY(IYY,IZZ,KVIB)*TWO
     2     +CXY(IYY,IYY,IVIB)*CXY(IZZ,IXX,JVIB)*CXY(IZZ,IXX,KVIB)*TWO
     3     +CXY(IZZ,IZZ,IVIB)*CXY(IXX,IYY,JVIB)*CXY(IXX,IYY,KVIB)*TWO
     4     +CXY(IYY,IZZ,IVIB)*CXY(IZZ,IXX,JVIB)*CXY(IXX,IYY,KVIB)
     5     *8.0D+00
      VALU3=VALU3+FACT3*F3Q(IVIB,JVIB,KVIB)
  113 CONTINUE
      IAA=IAXIS(1)
      IBB=IAXIS(2)
      ICC=IAXIS(3)
      ROTYZ=ROTCM(IBB)-ROTCM(ICC)
      ROTYZ2=ROTYZ*ROTYZ
      ROTZX=ROTCM(ICC)-ROTCM(IAA)
      ROTZX2=ROTZX*ROTZX
      ROTXY=ROTCM(IAA)-ROTCM(IBB)
      ROTXY2=ROTXY*ROTXY
      IF(DABS(ROTYZ).LE.RLIMIT) GO TO 203
      FACT4=ROTZX*TABCD(IYY,IYY,IYY,IZZ)
     1     +ROTXY*TABCD(IZZ,IZZ,IZZ,IYY)
      VALU4=(TABCD(IYY,IYY,IYY,IZZ)-TABCD(IZZ,IZZ,IZZ,IYY))*FACT4
     1      /ROTYZ2
  203 CONTINUE
      IF(DABS(ROTZX).LE.RLIMIT) GO TO 204
      FACT5=ROTXY*TABCD(IZZ,IZZ,IZZ,IXX)
     1     +ROTYZ*TABCD(IXX,IXX,IXX,IZZ)
      VALU5=(TABCD(IZZ,IZZ,IZZ,IXX)-TABCD(IXX,IXX,IXX,IZZ))*FACT5
     1      /ROTZX2
  204 CONTINUE
      IF(DABS(ROTXY).LE.RLIMIT) GO TO 205
      FACT6=ROTYZ*TABCD(IXX,IXX,IXX,IYY)
     1     +ROTZX*TABCD(IYY,IYY,IYY,IXX)
      VALU6=(TABCD(IXX,IXX,IXX,IYY)-TABCD(IYY,IYY,IYY,IXX))*FACT6
     1      /ROTXY2
  205 CONTINUE
      VALUT=(VALU1*3.0D+00/16.0D+00)+VALU2*TWO+VALU3*HALF
     1     +(VALU4*3.0D+00)/4.0D+00+(VALU5*3.0D+00)/4.0D+00
     2     +(VALU6*3.0D+00)/4.0D+00
      PABC(IXX,IYY,IZZ)=VALUT
      PABC(IXX,IZZ,IYY)=VALUT
      PABC(IYY,IXX,IZZ)=VALUT
      PABC(IYY,IZZ,IXX)=VALUT
      PABC(IZZ,IXX,IYY)=VALUT
      PABC(IZZ,IYY,IXX)=VALUT
C
      DO 115 IA=1,3
      DO 115 IB=1,3
      DO 115 IC=1,3
      PABC(IA,IB,IC)=PABC(IA,IB,IC)*1.0D+08
  115 CONTINUE
      WRITE(6,2)
      CALL MX3OUT(PABC(1,1,1),3,PABC(1,1,2),3,PABC(1,1,3),3,3,6)
      DO 116 IA=1,3
      DO 116 IB=1,3
      DO 116 IC=1,3
      PABC(IA,IB,IC)=PABC(IA,IB,IC)/1.0D+08
  116 CONTINUE
C
      RETURN
      END
