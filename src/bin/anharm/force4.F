      SUBROUTINE FORCE4(ELX,F44,F4X,F4Q,EE,DD,GG)
C   THE FOURTH ORDER ANHARMONICITY ANALYSIS
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION ELX(N3N,N3N)
      DIMENSION F44(N4TOT),F4X(N3N,N3N,N3N,N3N),F4Q(N3N,N3N,N3N,N3N)
      DIMENSION EE(N3N,N3N),DD(N3N,N3N),GG(N3N,N3N)
      COMMON/VIB101/NATOM,N3N,NATRI,ILIN,NVIB
      COMMON/VIB102/ITHREE,IFOUR,N3TOT,N4TOT
      COMMON/VIB105/FACT3,FACT4
      COMMON/VIB203/IOFF(150),IPRNT
      COMMON/VIB204/SQM(150),ROOT(150),FREQ(150)
      COMMON/VIB205/IFREQ,NFRQ(150)
      DATA A00,ONE / 0.0D+00 , 1.0D+00 /
      DATA WLIMIT / 3.0D+00 /
      DATA ITAP24 / 24 /
      DATA A0,HE / 0.52917706D+00 , 4.359813653D+00 /
    1 FORMAT(//,2X,' THE FOURTH ORDER ANHARMONICITY ANALYSIS'/)
    2 FORMAT(2I5)
    3 FORMAT(3F20.10)
    4 FORMAT(//,2X,' **************************************************'
     1        /,2X,' ***FOURTH DERIVATIVES W.R.T. NORMAL COORDINATES***'
     2        /,2X,' **************************************************'
     3        /)
    5 FORMAT(//,2X,' F4X MATRIX (IN HARTREE/BOHR+4), KABC = ',I5/)
    6 FORMAT(//,2X,' F4X MATRIX (IN MDYN/A+3), KABC = ',I5,
     1          5X,' LABC = ',I5/)
    7 FORMAT(//,2X,' LX(T) * F4X * LX MATRIX, KABC = ',I5,
     1          5X,' LABC = ',I5/)
    8 FORMAT(//,2X,' LX(T)*LX(T) * F4X *LX*LX MATRIX, KABC = ',I5,
     1          5X,' LABC = ',I5/)
    9 FORMAT(//,2X,' F4(QI*QJ*QK*QL) MATRIX (IN MDYN/(A+2.AMU-3/2))',
     1 1X,' QVIB (',I3,',',I3,')',2X,',',' IVIB (',I3,',',I3,')'/)
   10 FORMAT(//,2X,' F4(QI*QJ*QK*QL) MATRIX (IN CM-1),',
     1 1X,' QVIB (',I3,',',I3,')',2X,',',' IVIB (',I3,',',I3,')'/)
C
      IF(IPRNT.NE.0)
     *WRITE(6,1)
C
C   FIND CONVERSION FACTORS
C   FUNIT4 IS IN MDYN/A+3
      FUNIT4=HE/(A0*A0*A0*A0)
C
C   READ IN FOURTH DERIVATIVES
      call ffile(itap24,' ',0)
      REWIND ITAP24
      READ(ITAP24,2) NNATOM,NF3
      READ(ITAP24,3) (F44(I),I=1,N4TOT)
      REWIND ITAP24
C
C   TRANSFORM FOURTH DERIVATIVES
C   FROM CARTESIAN TO NORMAL COORDINATE SYSTEM
      WRITE(6,4)
      MABC=0
      DO 101 IABC=1,N3N
      DO 101 JABC=1,IABC
      DO 101 KABC=1,JABC
      DO 101 LABC=1,KABC
      MABC=MABC+1
      VAL=F44(MABC)
C
      F4X(IABC,JABC,KABC,LABC)=VAL
      F4X(IABC,JABC,LABC,KABC)=VAL
      F4X(IABC,KABC,JABC,LABC)=VAL
      F4X(IABC,KABC,LABC,JABC)=VAL
      F4X(IABC,LABC,JABC,KABC)=VAL
      F4X(IABC,LABC,KABC,JABC)=VAL
C
      F4X(JABC,IABC,KABC,LABC)=VAL
      F4X(JABC,IABC,LABC,KABC)=VAL
      F4X(JABC,KABC,IABC,LABC)=VAL
      F4X(JABC,KABC,LABC,IABC)=VAL
      F4X(JABC,LABC,IABC,KABC)=VAL
      F4X(JABC,LABC,KABC,IABC)=VAL
C
      F4X(KABC,IABC,JABC,LABC)=VAL
      F4X(KABC,IABC,LABC,JABC)=VAL
      F4X(KABC,JABC,IABC,LABC)=VAL
      F4X(KABC,JABC,LABC,IABC)=VAL
      F4X(KABC,LABC,IABC,JABC)=VAL
      F4X(KABC,LABC,JABC,IABC)=VAL
C
      F4X(LABC,IABC,JABC,KABC)=VAL
      F4X(LABC,IABC,KABC,JABC)=VAL
      F4X(LABC,JABC,IABC,KABC)=VAL
      F4X(LABC,JABC,KABC,IABC)=VAL
      F4X(LABC,KABC,IABC,JABC)=VAL
      F4X(LABC,KABC,JABC,IABC)=VAL
  101 CONTINUE
C
      DO 105 KABC=1,N3N
      DO 105 LABC=1,N3N
      DO 102 I=1,N3N
      DO 102 J=1,N3N
  102 DD(I,J)=F4X(I,J,KABC,LABC)
      IF(IPRNT.LE.2) GO TO 201
      WRITE(6,5) KABC,LABC
      CALL MATOUT(DD,N3N,N3N,N3N,N3N,6)
  201 CONTINUE
      DO 103 I=1,N3N
      DO 103 J=1,N3N
  103 DD(I,J)=DD(I,J)*FUNIT4
      IF(IPRNT.LE.2) GO TO 202
      WRITE(6,6) KABC,LABC
      CALL MATOUT(DD,N3N,N3N,N3N,N3N,6)
C
  202 CONTINUE
      CALL MTXMPY(ELX,N3N,DD,N3N,EE,N3N,GG,N3N,N3N,5)
      IF(IPRNT.LE.2) GO TO 203
      WRITE(6,7) KABC,LABC
      CALL MATOUT(EE,N3N,N3N,N3N,N3N,6)
  203 CONTINUE
      DO 104 I=1,N3N
      DO 104 J=1,N3N
  104 F4X(I,J,KABC,LABC)=EE(I,J)
  105 CONTINUE
C
      DO 110 KABC=1,N3N
      DO 110 LABC=1,N3N
      DO 106 I=1,N3N
      DO 106 J=1,N3N
  106 DD(I,J)=F4X(KABC,LABC,I,J)
      IF(IPRNT.LE.2) GO TO 204
      WRITE(6,7) KABC,LABC
      CALL MATOUT(DD,N3N,N3N,N3N,N3N,6)
  204 CONTINUE
C
      CALL MTXMPY(ELX,N3N,DD,N3N,EE,N3N,GG,N3N,N3N,5)
      IF(IPRNT.LE.2) GO TO 206
      WRITE(6,8) KABC,LABC
      CALL MATOUT(EE,N3N,N3N,N3N,N3N,6)
  206 CONTINUE
      DO 108 I=1,N3N
      DO 108 J=1,N3N
  108 F4Q(KABC,LABC,I,J)=EE(I,J)
  110 CONTINUE
C
C   SET NUMBER OF ANHARMONICITY SETS
C   REGULARLY NVIB=3N-6(OR 3N-5)
C   IF IFREQ IS NOT EQUAL TO 0 THEN NVIB=IFREQ
      IF(IFREQ.NE.0) NVIB=IABS(IFREQ)
C
      IF(IPRNT.LE.2) GO TO 207
      DO 112 II=1,NVIB
      IVIB=NFRQ(II)
      DO 112 JJ=1,NVIB
      JVIB=NFRQ(JJ)
      WRITE(6,9) II,JJ,IVIB,JVIB
      DO 111 I=1,N3N
      DO 111 J=1,N3N
  111 DD(I,J)=F4Q(I,J,IVIB,JVIB)
      CALL MATOUT(DD,N3N,N3N,N3N,N3N,6)
  112 CONTINUE
C
  207 CONTINUE
      DO 115 III=1,N3N
      WK=FREQ(III)
      DO 115 JJJ=1,N3N
      WL=FREQ(JJJ)
      DO 114 I=1,N3N
      WI=FREQ(I)
      DO 114 J=1,N3N
      WJ=FREQ(J)
      WIJKL=WI*WJ*WK*WL
      IF(DABS(WK).LE.WLIMIT) GO TO 208
      IF(DABS(WL).LE.WLIMIT) GO TO 208
      IF(DABS(WI).LE.WLIMIT) GO TO 208
      IF(DABS(WJ).LE.WLIMIT) GO TO 208
      IF(DABS(WIJKL).LE.WLIMIT) GO TO 208
      SQWS=DSQRT(WIJKL)
      FACT=FACT4/SQWS
      GO TO 209
  208 CONTINUE
      FACT=A00
  209 CONTINUE
      F4Q(I,J,III,JJJ)=F4Q(I,J,III,JJJ)*FACT
  114 CONTINUE
  115 CONTINUE
      DO 120 III=1,NVIB
      IVIB=NFRQ(III)
      DO 120 JJJ=1,NVIB
      JVIB=NFRQ(JJJ)
      WRITE(6,10) III,JJJ,IVIB,JVIB
      DO 116 I=1,NVIB
      II=NFRQ(I)
      DO 116 J=1,NVIB
      JJ=NFRQ(J)
      DD(I,J)=F4Q(II,JJ,IVIB,JVIB)
  116 CONTINUE
      CALL ANHOUT(DD,N3N,N3N,NVIB,NVIB,6)
  120 CONTINUE
C
      RETURN
      END
