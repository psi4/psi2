      SUBROUTINE FORCE3(ELX,F33,F3X,F3Q,EE,DD,GG)
C   THE THIRD ORDER ANHARMONICITY ANALYSIS
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION ELX(N3N,N3N)
      DIMENSION F33(N3TOT),F3X(N3N,N3N,N3N),F3Q(N3N,N3N,N3N)
      DIMENSION EE(N3N,N3N),DD(N3N,N3N),GG(N3N,N3N)
      COMMON/VIB101/NATOM,N3N,NATRI,ILIN,NVIB
      COMMON/VIB102/ITHREE,IFOUR,N3TOT,N4TOT
      COMMON/VIB105/FACT3,FACT4
      COMMON/VIB203/IOFF(150),IPRNT
      COMMON/VIB204/SQM(150),ROOT(150),FREQ(150)
      COMMON/VIB205/IFREQ,NFRQ(150)
      DATA A00 / 0.0D+00 /
      DATA ITAP20 / 20 /
      DATA A0,HE / 0.52917706D+00 , 4.359813653D+00 /
      DATA WLIMIT / 3.0D+00 /
    1 FORMAT(//,2X,' THE THIRD ORDER ANHARMONICITY ANALYSIS'/)
    2 FORMAT(2I5)
    3 FORMAT(3F20.10)
    4 FORMAT(//,2X,' *************************************************'/
     1          2X,' ***THIRD DERIVATIVES W.R.T. NORMAL COORDINATES***'/
     2          2X,' *************************************************')
    5 FORMAT(//,2X,' F3X MATRIX (IN HARTREE/BOHR+3), KABC = ',I5/)
    6 FORMAT(//,2X,' F3X MATRIX (IN MDYN/A+2), KABC = ',I5/)
    7 FORMAT(//,2X,' LX(T) * F3X * LX MATRIX, KABC = ',I5/)
    8 FORMAT(//,2X,' F3(QI*QJ*QK) MATRIX (IN MDYN/(A+2.AMU-3/2)),  QVIB
     1=',I3,2X,', IVIB = ',I3/)
    9 FORMAT(//,2X,' F3(QI*QJ*QK) MATRIX (IN CM-1),  QVIB = ',I3,2X,
     1      ', IVIB = ',I3/)
C
      IF(IPRNT.NE.0)
     *WRITE(6,1)
C
C   FIND CONVERSION FACTORS
C   FUNIT3 IS IN MDYN/A+2
      FUNIT3=HE/(A0*A0*A0)
C
C   READ IN THIRD DERIVATIVES
      call ffile(itap20,' ',0)
      REWIND ITAP20
      READ(ITAP20,2) NNATOM,NF3
      READ(ITAP20,3) (F33(I),I=1,N3TOT)
      REWIND ITAP20
C
C   TRANSFORM THIRD DERIVATIVES
C   FROM CARTESIAN TO NORMAL COORDINATE SYSTEM
      WRITE(6,4)
      LABC=0
      DO 101 IABC=1,N3N
      DO 101 JABC=1,IABC
      DO 101 KABC=1,JABC
      LABC=LABC+1
      VAL=F33(LABC)
      F3X(IABC,JABC,KABC)=VAL
      F3X(IABC,KABC,JABC)=VAL
      F3X(JABC,IABC,KABC)=VAL
      F3X(JABC,KABC,IABC)=VAL
      F3X(KABC,IABC,JABC)=VAL
      F3X(KABC,JABC,IABC)=VAL
  101 CONTINUE
C
      DO 105 KABC=1,N3N
      DO 102 I=1,N3N
      DO 102 J=1,N3N
  102 DD(I,J)=F3X(I,J,KABC)
      IF(IPRNT.LE.2) GO TO 201
      WRITE(6,5) KABC
      CALL MATOUT(DD,N3N,N3N,N3N,N3N,6)
  201 CONTINUE
      DO 103 I=1,N3N
      DO 103 J=1,N3N
  103 DD(I,J)=DD(I,J)*FUNIT3
      IF(IPRNT.LE.2) GO TO 202
      WRITE(6,6) KABC
      CALL MATOUT(DD,N3N,N3N,N3N,N3N,6)
C
  202 CONTINUE
      CALL MTXMPY(ELX,N3N,DD,N3N,EE,N3N,GG,N3N,N3N,5)
      IF(IPRNT.LE.2) GO TO 203
      WRITE(6,7) KABC
      CALL MATOUT(EE,N3N,N3N,N3N,N3N,6)
  203 CONTINUE
      DO 104 I=1,N3N
      DO 104 J=1,N3N
  104 F3X(I,J,KABC)=EE(I,J)
  105 CONTINUE
      DO 107 I=1,N3N
      DO 107 J=1,N3N
      DO 107 K=1,N3N
      VAL=A00
      DO 106 L=1,N3N
  106 VAL=VAL+F3X(I,J,L)*ELX(L,K)
      F3Q(I,J,K)=VAL
  107 CONTINUE
C
C   SET NUMBER OF ANHARMONICITY SETS
C   REGULARLY NVIB=3N-6(OR 3N-5)
C   IF IFREQ IS NOT EQUAL TO 0 THEN NVIB=IFREQ
      IF(IFREQ.NE.0) NVIB=IABS(IFREQ)
C
      IF(IPRNT.LE.1) GO TO 204
      DO 109 II=1,NVIB
      IVIB=NFRQ(II)
      WRITE(6,8) II,IVIB
      DO 108 I=1,N3N
      DO 108 J=1,N3N
  108 DD(I,J)=F3Q(I,J,IVIB)
      CALL MATOUT(DD,N3N,N3N,N3N,N3N,6)
  109 CONTINUE
C
  204 CONTINUE
      DO 112 III=1,N3N
      WK=FREQ(III)
      DO 111 I=1,N3N
      WI=FREQ(I)
      DO 111 J=1,N3N
      WJ=FREQ(J)
      WIJK=WI*WJ*WK
      IF(DABS(WK).LE.WLIMIT) GO TO 205
      IF(DABS(WI).LE.WLIMIT) GO TO 205
      IF(DABS(WJ).LE.WLIMIT) GO TO 205
      IF(DABS(WIJK).LE.WLIMIT) GO TO 205
      SQWS=DSQRT(WIJK)
      FACT=FACT3/SQWS
      GO TO 206
  205 CONTINUE
      FACT=A00
  206 CONTINUE
      F3Q(I,J,III)=F3Q(I,J,III)*FACT
  111 CONTINUE
  112 CONTINUE
      DO 114 III=1,NVIB
      IVIB=NFRQ(III)
      WRITE(6,9) III,IVIB
      DO 113 I=1,NVIB
      II=NFRQ(I)
      DO 113 J=1,NVIB
      JJ=NFRQ(J)
      DD(I,J)=F3Q(II,JJ,IVIB)
  113 CONTINUE
      CALL ANHOUT(DD,N3N,N3N,NVIB,NVIB,6)
  114 CONTINUE
C
      RETURN
      END
