      SUBROUTINE VIBFX(FX,ELX,ELXM,UX,EPX,EPXM,EE,VALU,FV1,FV2,FXM,DD,
     1                 CC)
C   THE NORMAL COORDINATE ANALYSIS FOR CARTESIAN COORDINATE SYSTEM
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION FX(N3N,N3N),ELX(N3N,N3N),ELXM(N3N,N3N)
      DIMENSION UX(N3N,N3N),EPX(N3N,N3N),EPXM(N3N,N3N)
      DIMENSION EE(N3N,N3N),DD(N3N,N3N),CC(1)
      DIMENSION VALU(N3N),FV1(N3N),FV2(N3N),FXM(NATRI)
      DIMENSION IATOMX(10)
      COMMON/VIB101/NATOM,N3N,NATRI,ILIN,NVIB
      COMMON/VIB107/ITOP,IVSGL,IVDBL,IVTRP
      COMMON/VIB108/IAXIS(3),NDEG(150),NDAB(150,5),IMAG(150)
      COMMON/VIB201/CHG(50),X(50),Y(50),Z(50),W(50)
      COMMON/VIB203/IOFF(150),IPRNT
      COMMON/VIB204/SQM(150),ROOT(150),FREQ(150)
      DATA A00,ONE / 0.0D+00 , 1.0D+00 /
      DATA DLIMIT / 1.0D-01 /
      DATA ELIMIT / 1.0D-04 /
      DATA WLIMIT / 3.0D+00 /
      DATA XLIMIT / 1.0D-05 /
    1 FORMAT(//,2X,' THE NORMAL COORDINATE ANALYSIS BY FX MATRIX METHOD'
     1/)
    2 FORMAT(//,2X,' SECULAR EQUATIONS'/2X,' FXM MATRIX'/)
    3 FORMAT(//,2X,' *****************************'/
     1          2X,' ***VIBRATIONAL FREQUENCIES***'/
     2          2X,' *****************************')
    4 FORMAT(//,2X,' LX MATRIX'/)
    5 FORMAT(//,2X,' LX * LX(T) = M(-1)'/)
    6 FORMAT(//,2X,' LAMDA = LX(T) * FX * LX'/)
    7 FORMAT(//,2X,' LX'' MATRIX'/)
    8 FORMAT(//,2X,' LX'' * LX''(T) = M(-1)'/)
    9 FORMAT(//,2X,' LXM'' MATRIX'/)
   10 FORMAT(//,2X,' LXM'' * LXM''(T) = E'/)
   11 FORMAT(//,2X,' ANALYSIS OF VIBRATIONAL MODES'//
     1          2X,' NO.OF NON-DEGENERATE MODES    = ',I5/
     1          2X,' NO.OF DOUBLY-DEGENERATE MODES = ',I5/
     2          2X,' NO.OF TRIPLY-DEGENERATE MODES = ',I5/
     3          2X,' NO.OF TOTAL VIBRATIONAL MODES = ',I5/)
   12 FORMAT(//,2X,' ROTATED LXM'' MATRIX'/)
C
      IF(IPRNT.NE.0)
     *WRITE(6,1)
C
C   THE FORMATION OF THE SECULAR EQUATION
      DO 101 I=1,NATOM
  101 SQM(I)=DSQRT(W(I))
      DO 102 I=1,N3N
      II=I/3
      IF(I.GT.3*II) II=II+1
      DO 102 J=I,N3N
      JJ=J/3
      IF(J.GT.3*JJ) JJ=JJ+1
      IJ=I+IOFF(J)
      FXM(IJ)=(ONE/SQM(II))*FX(I,J)*(ONE/SQM(JJ))
  102 CONTINUE
      WRITE(6,2)
      CALL PRINT(FXM,NATRI,N3N,6)
C
C   THE NORMAL COORDINATE ANALYSIS
      WRITE(6,3)
      IF(ITOP.EQ.2) THEN
        NAA=IOFF(NATOM+1)
        IC1=1
        IC2=IC1+NAA
        IC3=IC2+NATOM
        IC4=IC3+NATOM*NATOM
        ICMAX=IC4+N3N
C
C...................                         FXMX    VALUX   ELXMX...
        CALL NORMLI(ELXM,EE,VALU,FV1,FV2,FXM,CC(IC1),CC(IC2),CC(IC3),
C...................NORD........
     1              CC(IC4),NAA)
      ELSE
        CALL NORMFX(ELXM,EE,VALU,FV1,FV2,FXM)
      END IF
C
C   THE CALCULATION OF LX MATRIX
      DO 103 I=1,N3N
      II=I/3
      IF(I.GT.3*II) II=II+1
      DO 103 J=1,N3N
      ELX(I,J)=(ONE/SQM(II))*ELXM(I,J)
  103 CONTINUE
      WRITE(6,4)
      CALL FRQOUT(ELX,FREQ,N3N,N3N,N3N,N3N,6)
      IF(IPRNT.LE.2) GO TO 201
      CALL MTXMPY(ELX,N3N,ELX,N3N,EE,N3N,EE,N3N,N3N,3)
      WRITE(6,5)
      CALL MATOUT(EE,N3N,N3N,N3N,N3N,6)
C
C   TRANSFORM FX MATRIX FOR A TEST
      CALL MTXMPY(ELX,N3N,FX,N3N,EE,N3N,DD,N3N,N3N,5)
      WRITE(6,6)
      CALL MATOUT(EE,N3N,N3N,N3N,N3N,6)
C
C   THE CALCULATION OF LX' MATRIX
C==============================================
C===FOR ASYMMETRIC TOP AND  LINEAR MOLECULES===
C==============================================
  201 CONTINUE
      CALL MTXMPY(UX,N3N,ELX,N3N,EPX,N3N,33,N3N,N3N,2)
      WRITE(6,7)
      CALL FRQOUT(EPX,FREQ,N3N,N3N,N3N,N3N,6)
      CALL MTXMPY(EPX,N3N,EPX,N3N,EE,N3N,EE,N3N,N3N,3)
      WRITE(6,8)
      CALL MATOUT(EE,N3N,N3N,N3N,N3N,6)
C
C   THE CALCULATION OF LXM' MATRIX
      DO 104 I=1,N3N
      II=I/3
      IF(I.GT.3*II) II=II+1
      DO 104 J=1,N3N
      EPXM(I,J)=EPX(I,J)*SQM(II)
  104 CONTINUE
      WRITE(6,9)
      CALL FRQOUT(EPXM,FREQ,N3N,N3N,N3N,N3N,6)
      CALL MTXMPY(EPXM,N3N,EPXM,N3N,EE,N3N,EE,N3N,N3N,3)
      WRITE(6,10)
      CALL MATOUT(EE,N3N,N3N,N3N,N3N,6)
C
C   FIND DEGENERACY OF NORMAL MODES
  202 CONTINUE
      DO 105 I=1,N3N
      NDEG(I)=0
      DO 105 J=1,5
      NDAB(I,J)=0
  105 CONTINUE
      DO 107 I=1,NVIB
      FRQI=FREQ(I)
      IF(DABS(FRQI).LE.WLIMIT) GO TO 107
      II=0
      DO 106 J=1,NVIB
      FRQJ=FREQ(J)
      IF(DABS(FRQJ).LE.WLIMIT) GO TO 106
      IF(DABS(FRQI-FRQJ).GT.DLIMIT) GO TO 106
      II=II+1
      NDAB(I,II)=J
  106 CONTINUE
      NDEG(I)=II
  107 CONTINUE
C
C   FIND NUMBERS OF DEGENERATE PAIRS
      IVDBL=0
      IVTRP=0
      DO 108 I=1,N3N
      IF(NDEG(I).EQ.2) IVDBL=IVDBL+1
      IF(NDEG(I).EQ.3) IVTRP=IVTRP+1
  108 CONTINUE
      IVDBL=IVDBL/2
      IVTRP=IVTRP/3
      IVSGL=NVIB-IVDBL*2-IVTRP*3
      WRITE(6,11) IVSGL,IVDBL,IVTRP,NVIB
C
      IF(ITOP.EQ.2) GO TO 205
      IF(IVDBL.EQ.0) GO TO 205
C
C   ROTATE EIGENVECTORS FOR DEGENERATE MODES
C==================================
C===FOR A SYMMETRIC TOP MOLECULE===
C==================================
C   FIND ALL ATOMS ON THE C3V AXIS
      II=0
      DO 110 I=1,NATOM
      XYSUM=X(I)*X(I)+Y(I)*Y(I)
      IF(XYSUM.GT.XLIMIT) GO TO 110
      II=II+1
      IATOMX(II)=I
      WRITE(6,*) ' I,II,IATOMX',I,II,IATOMX(II)
  110 CONTINUE
      IAXTOT=II
      WRITE(6,*) ' IAXTOT',IAXTOT
C
      IASAV=0
      DO 120 IVIB=1,NVIB
      NN=NDEG(IVIB)
      IF(NN.NE.2) GO TO 120
      IA=NDAB(IVIB,1)
      IB=NDAB(IVIB,2)
      IF(IASAV.EQ.IA) GO TO 120
      IASAV=IA
      DO 111 I=1,IAXTOT
      IAX=(IATOMX(I)-1)*3+1
      EP1=EPXM(IAX,IA)
      EP2=EPXM(IAX,IB)
      DNORM=DSQRT(EP1*EP1+EP2*EP2)
      IF(DNORM.LT.ELIMIT) GO TO 111
      XNORM=ONE/DNORM
      EP1=-EP1*XNORM
      EP2= EP2*XNORM
      GO TO 203
  111 CONTINUE
  203 CONTINUE
      DO 113 I=1,N3N
      FV1(I)=EPXM(I,IA)
      FV2(I)=EPXM(I,IB)
  113 CONTINUE
      DO 114 I=1,N3N
      EPXM(I,IA)=EP1*FV1(I)-EP2*FV2(I)
      EPXM(I,IB)=EP2*FV1(I)+EP1*FV2(I)
  114 CONTINUE
      TESTX=EPXM(IAX,IA)+EPXM(IAX+1,IA)
      IF(TESTX.LT.A00) THEN
        DO 115 I=1,N3N
        EPXM(I,IA)=-EPXM(I,IA)
  115   CONTINUE
      END IF
      TESTX=EPXM(IAX,IB)+EPXM(IAX+1,IB)
      IF(TESTX.LT.A00) THEN
        DO 116 I=1,N3N
        EPXM(I,IB)=-EPXM(I,IB)
  116   CONTINUE
      END IF
  120 CONTINUE
      WRITE(6,12)
      CALL FRQOUT(EPXM,FREQ,N3N,N3N,N3N,N3N,6)
      CALL MTXMPY(EPXM,N3N,EPXM,N3N,EE,N3N,EE,N3N,N3N,3)
      WRITE(6,10)
      CALL MATOUT(EE,N3N,N3N,N3N,N3N,6)
C
C   THE CALCULATION OF LX' MATRIX
      DO 121 I=1,N3N
      II=I/3
      IF(I.GT.3*II) II=II+1
      DO 121 J=1,N3N
      EPX(I,J)=(ONE/SQM(II))*EPXM(I,J)
  121 CONTINUE
      WRITE(6,7)
      CALL FRQOUT(EPX,FREQ,N3N,N3N,N3N,N3N,6)
      CALL MTXMPY(EPX,N3N,EPX,N3N,EE,N3N,EE,N3N,N3N,3)
      WRITE(6,8)
      CALL MATOUT(EE,N3N,N3N,N3N,N3N,6)
      DO 122 I=1,N3N
      DO 122 J=1,N3N
      ELX(I,J)=EPX(I,J)
  122 CONTINUE
C
  205 CONTINUE
      RETURN
      END
