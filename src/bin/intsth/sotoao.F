      SUBROUTINE SOTOAO(NC,NF,MCONS,ITRNAO,NSOT,NSO,USOTAO,MGCS,
     1  MAORDS,NIR,NCT,NRCR,LA,IGC,LMNP1,ISOTAO)
C
C         BRL        21 JULY 1983                      PWS
C
C  MODULE TO FORM THE SO-TO-AO TRANSFORMATION MATRIX GIVEN PITZER
C  ARRAYS. USOTAO(AO,SO) IS THE TRANSFORMATAION MATRIX.
C
      IMPLICIT REAL*8 (A-H,O-Z)
C
      COMMON /OUT/    IOUT,ICHECK,IFLAG3,NSECT,NINTS
      COMMON /TAPE30/ I10(200),ITAP30
      COMMON /PSIZE/  MSU,KAORDS,MCONSU,MGCSU,MSTU,MRU,MCSU,MCTU,MCONU,
     1                MCU,MSFU,MGU,MSFRU,MNSFU,MPRU,MCXU,MCCU,MBLU,MRCRU
      COMMON /INFOA/  NAT,NUM,NQ,NX,NE,NA,NB
      REAL*8 IGC(MCTU,MCSU,MGCSU),USOTAO(NUM,MSFRU)
      INTEGER NC(MSU),NF(MSU),MCONS(MCONSU),ITRNAO(MSFRU)
      INTEGER NSOT(MSTU),NSO(MSTU),MGCS(MGCSU),MAORDS(KAORDS)
      INTEGER NIR(MGCSU),NCT(MSU),NRCR(MCONSU),LA(MRU,KAORDS)
      INTEGER LMNP1(MCONSU),ISOTAO(1)
C
C
      DO 130 J=1,MSFRU
        DO 120 I=1,NUM
          USOTAO(I,J)=0.0D+00
  120   CONTINUE
  130 CONTINUE
C
      NSOT(1)=0
      DO 140 I=2,MSTU
        NSOT(I)=NSOT(I-1)+NSO(I-1)
  140 CONTINUE
C
      ISFXO=0
      ISFP=0
      IBFAO=0
C
      DO 230 IS=1,MSU
        ICU=NC(IS)
        IFU=NF(IS)
        DO 220 I=1,ICU
          ISFX=ISFXO
          ISF=ISFP
          IF (IFU.EQ.0) GO TO 220
          DO 210 J=1,IFU
            ISF=ISF+1
            ICONS=MCONS(ISF)
            NBU=(LMNP1(ICONS)*(LMNP1(ICONS)+1)/2)
            DO 200 IRCR=1,NRCR(ICONS)
            ISFT=ISFX+(I-1)*NBU
            ISFX=ISFX+NBU*ICU
            DO 190 K=1,NBU
              IBFAO=IBFAO+1
              ISFT=ISFT+1
              ITRNAO(ISFT)=IBFAO
  190       CONTINUE
  200       CONTINUE
  210     CONTINUE
  220     CONTINUE
           ISFXO=ISFX
           ISFP=ISFP+IFU
  230 CONTINUE
C
C
C
      ISF=0
      ISFR=0
      ISFTX=0
      DO 280 IS=1,MSU
        IFU=NF(IS)
        IF (IFU.LE.0) GO TO 275
        DO 270 I=1,IFU
          ISF=ISF+1
          IGCS=MGCS(ISF)
          IAORD=MAORDS(IGCS)
          IRU=NIR(IAORD)
          ICTU=NCT(ISF)
          DO 260 IRCR=1,NRCR(MCONS(ISF))
          ICS=0
          DO 250 J=1,IRU
            ISFR=ISFR+1
            ISFT=ISFTX
            LAI=LA(J,IAORD)
            NSOT(LAI)=NSOT(LAI)+1
            KSO=NSOT(LAI)
            ICS=ICS+1
            DO 240 L=1,ICTU
              ISFT=ISFT+1
              USOTAO(ITRNAO(ISFT),KSO)=IGC(L,ICS,IGCS)
  240       CONTINUE
  250     CONTINUE
          ISFTX=ISFTX+ICTU
  260   CONTINUE
  270   CONTINUE
  275   CONTINUE
  280 CONTINUE
C
C     ----- PUT SO-TO-AO TRANSFORMATION MATRIX ON TAPE30
C           AS 29TH MATRIX, ITRNAO AS 30TH
C
      CALL WREADW(ITAP30,I10,200,101,JUNK)
      IEND=I10(1)
      MPOINT=I10(2)
      MCONST=I10(3)
      IF (MSFRU.NE.I10(18)) THEN
  700   FORMAT(///' IN SOTOAO, MSFRU=',I10,' ON TAPE30 IS',I10)
        WRITE(IOUT,700) MSFRU,I10(18)
        call qabort
      END IF
      IF (NUM.NE.I10(22)) THEN
  701   FORMAT(///' IN SOTOA, NUM=',I10,' ON TAPE30 IS',I10)
        WRITE(IOUT,701) NUM,I10(22)
        call qabort
      END IF
C
      JUNK=101+MCONST
      CALL WREADW(ITAP30,I10,MPOINT,JUNK,JUNK1)
      IF (I10(29).LE.0) THEN
        I10(29)=IEND
        CALL WWRITW(ITAP30,ISOTAO,INTOWP(NUM*MSFRU),IEND,IEND)
        I10(30)=IEND
        CALL WWRITW(ITAP30,ITRNAO,MSFRU,IEND,IEND)
C
C     ----- REWRITE POINTERS BACK TO TAPE30 -----
C
        CALL WWRITW(ITAP30,I10,MPOINT,JUNK,JUNK1)
C
C     ----- UPDATE IEND -----
C
        CALL WWRITW(ITAP30,IEND,1,101,JUNK1)
CSEL    CALL WEOF(ITAP30)
C
  703   FORMAT(/' SO-TO-AO TRANSFORMATION MATRIX WRITTEN TO ITAP',
     1    I2,', '/'    EXTENDING IT TO',I6,' WORDS OR',I5,' SECTORS'/)
        WRITE(ICHECK,703) ITAP30,IEND,I2SEC(IEND)
      END IF
C
C
C
      RETURN
      END
