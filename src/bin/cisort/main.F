      SUBROUTINE MAINST(IA,Z,MAXI,MAXR)
C***********************************************************************
      IMPLICIT INTEGER (A-Z)
C
CTJL  EXTENDED DUMMY IA,Z
C
      REAL*8 Z,X,REP,FZCORE,EGUESS,ECI,CNVERG,ACRCY,SQCDIF
      REAL*8 DRTVER,VER4X,SECS
      INTEGER FCB2(16),FCB8(16),FCB103(16),IVER(1)
C
      COMMON /TAPES/  ITAP52,ITAPE5,ITAPE6,ITAP58,ITAP12,ITAP99,ITAP04
     *,               ITAPE3,ITAP05,ITAP06
      COMMON /DIMS/   NBF,NSYM,NORBS,NROWS,NROWS4,NWKS,NWKS2,NLEVS
     *,               NROWOC,NROW4O,NWKSOC,NLEVOC,NORBOC,LEVFRM
     *,               NWKSMX,NLWKMX,NUWKMX,MAXB,NROOTS,LVFRM1,NREFS
      COMMON /INTS/   NMAX,NMAX2,NGROUP,NBLKOC,NUMIJ,SYMORB,INTSRT
      COMMON /DIAG/   REP,FZCORE,EGUESS,ECI,REFWLK,MXITER,CNVERG,ICNVG
     *,               ITER,SQCDIF,NROOT
      COMMON /LBLS/   LBLINT(26),LBLDRT(26),VER4X,DRTVER
      COMMON /XX4X/   NIJVIR
      COMMON /SORT/   IBLOCK,LNBUF,MAX
C
      DIMENSION ILBM(26),ILBN(26),III(3)
      DIMENSION IA(MAXI),Z(1)
C
      EQUIVALENCE (DRTVER,IVER)
C
      ITAPE3=3
      ITAPE6=6
      ITAP52=52
      ITAP58=58
      ITAP99=99
      CALL RFILE(ITAP52)
      CALL RFILE(ITAP58)
      CALL RFILE(ITAP99)
CTJL  OPEN (UNIT=ITAPE6,OPENMODE='A')
C
C
C
      CALL ZERO(Z,MAXR)
C
      VER4X=4.220782
C     WRITE(ITAPE3,911)
C     READ(3,912) ILNB
C     WRITE(ITAPE3,913) ILNB
C     WRITE(ITAPE6,913) ILNB
C     IF (ILNB.LE.0 .OR. ILNB.GT.30) ILNB=10
CTJL  ILNB=10
 911  FORMAT(/'  ENTER ILNB')
 912  FORMAT(I2)
 913  FORMAT(/'  USING ',I3,'  SECTORS FOR LNBUF')
CTJL  LNBUF=SEC2I(ILNB)
CTJL  MAX=LNBUF-2
      WRITE(ITAPE6,1)
    1 FORMAT(/,1H ,16X,'             PROGRAM CISORT ',/)
    5 FORMAT(/,1H ,16X,'>>>>>  CISORT CALCULATION COMPLETED  <<<<< ')
      WRITE(ITAPE6,10)
   10 FORMAT(1H ,12X,'SHAPE DRIVEN GRAPHICAL UNITARY GROUP CI PROGRAMS')
      WRITE(ITAPE6,11)
   11 FORMAT(1H ,12X,' FORM 3 & 4-EXTERNAL HAMILTONIAN MATRIX ELEMENTS')
      WRITE(ITAPE6,15) MAXR
   15 FORMAT(/,1H ,'DIMENSION OF REAL COMMON IS',I10)
CCRBR WRITE(ITAPE6,20)
CC 20 FORMAT(1H ,'READ IN DISTINCT ROW TABLE')
      CALL SREW(ITAP58)
C
C     ----- READ DIMENSIONS ETC FROM DRT TAPE -----
C
      CALL WREADW(ITAP58,IVER,INTOWP(1),1,END)
      CALL WREADW(ITAP58,LBLDRT,26,END,END)
      CALL WREADW(ITAP58,NBF,1,END,END)
      CALL WREADW(ITAP58,NSYM,1,END,END)
      CALL WREADW(ITAP58,NORBS,1,END,END)
      CALL WREADW(ITAP58,NROWS,1,END,END)
      END=END+1
      CALL WREADW(ITAP58,NLEVS,1,END,END)
      CALL WREADW(ITAP58,NREFS,1,END,END)
      END=END+2
      CALL WREADW(ITAP58,NWKS,1,END,END)
      END=END+2
      CALL WREADW(ITAP58,LVFRM1,1,END,END)
      CALL WREADW(ITAP58,SYMORB,1,END,END)
      CALL WREADW(ITAP58,NUMIJ,1,END,END)
      CALL WREADW(ITAP58,NGROUP,1,END,END)
      END=END+1
      CALL WREADW(ITAP58,NMAX,1,END,END)
      END=END+1
      CALL WREADW(ITAP58,NIJVIR,1,END,END)
      END=END+1
C
C
      NMAX2=INTOWP(NMAX)
      LEVFRM=LVFRM1+1
      NORBOC=NLEVOC-1
      WRITE(ITAPE6,31)LBLDRT
   31 FORMAT(1H ,'LABEL FROM DRT :        ',26A3,/)
      WRITE(ITAPE6,32)NWKS
   32 FORMAT(1H ,'NUMBER OF CONFIGURATIONS     =',I10)
      WRITE(ITAPE6,33)NBF
   33 FORMAT(1H ,'NUMBER OF BASIS FUNCTIONS    =',I10)
      WRITE(ITAPE6,34) NORBS
   34 FORMAT(1H ,'NUMBER OF ALLOWED ORBITALS   =',I10)
      WRITE(ITAPE6,35)LVFRM1
   35 FORMAT(1H ,'FERMI LEVEL IS ',I5 )
      CALL SREW(ITAP52)
C     CALCULATE POINTERS INTO BLANK COMMON
      IJXX=1
      KLXX=IJXX+NUMIJ
      NKLXX=KLXX+NIJVIR
      IJWW=NKLXX+NSYM
      KLWW=IJWW+NUMIJ
      NKLWW=KLWW+NIJVIR
      IJADD=NKLWW+NSYM
      IJGRP=IJADD+NUMIJ
      KADD=IJGRP+NUMIJ
      LADD=KADD+SYMORB
      NINGRP=LADD+SYMORB
      NBLKMN=NINGRP+NGROUP
      NBLKMX=NBLKMN+NGROUP
      ORBSYM=NBLKMX+NGROUP
CTJL  IAD=ORBSYM+NORBS
CTJL  LENI=IAD+NGROUP*LNBUF
      WRITE(ITAPE3,41) LENI
   41 FORMAT(' LENGTH OF INTEGER COMMON IS ',I8)
CTJL  IF(LENI.GT.MAXI) GO TO 930   TURNED BACK ON --- RBR
      IF(LENI.GT.MAXI) GO TO 930
      WRITE(ITAPE3,42)
   42 FORMAT(' READ DRT FILE')
      CALL GETDRT(        IA(KADD),IA(LADD),IA(IJADD),IA(IJGRP)
     #,                                                  IA(NINGRP)
     #,        IA(ORBSYM),IA(NBLKMN),IA(NBLKMX)
     #,        IA(IJXX),IA(KLXX),IA(NKLXX),IA(IJWW),IA(KLWW),IA(NKLWW)
     #,           END)
C
      IINTS = ORBSYM + NORBS
      IF((IINTS/2)*2.NE.IINTS) IINTS = IINTS + 1
      INTS = IADTWP(IINTS)
      IINTS = WPADTI(INTS)
      H3 = INTS + NMAX
      IAD = WPADTI(H3+NIJVIR)
      SPACE = MAXI - IAD
      SPACE = SPACE/(1+INTOWP(1))
      LNBUF = SPACE/NGROUP
      LNBUF = (LNBUF/SEC2I(1))*SEC2I(1)
      WRITE(ITAPE3,*) ' LNBUF = ',LNBUF
      MAX = LNBUF - 2
      IF(LNBUF.LT.SEC2I(1)) THEN
      WRITE(ITAPE6,941)
  941 FORMAT(5X,'INSUFFICIENT SPACE TO SORT INTS')
cjrt 3/15/94
      CALL mabort
cjrt  STOP
cjrt  change stop to explicit abort so psi will not continue needlessly
      END IF
      IVAL = IAD + NGROUP*LNBUF
      VAL = IADTWP(IVAL)
      LENR = VAL + NGROUP*LNBUF
      IF(LENR.GT.MAXR) GO TO 940
CTJL  INTS=IADTWP(LENI)
C
C     ----- INTEGER EQUIVALENT
C
CTJL  IINTS=WPADTI(INTS)
C
      CALL GETINT(ACRCY,ILBM,ILBN,IA(IINTS))
C
CTJL  H3=INTS+NMAX
CTJL  VAL=H3+NIJVIR
C
C     ----- INTEGER EQUIVALENT -----
C
CTJL  IVAL=WPADTI(VAL)
C
CTJL  LENR=VAL+NGROUP*LNBUF
CTJL  IF(LENR.GT.MAXR) GO TO 940
C
      WRITE (ITAPE6,50)
   50 FORMAT (1H ,'ABOUT TO INITIALIZE SORTING ROUTINES')
      CALL INSORT(IA(IAD),Z(VAL),Z(INTS),IA(IVAL),IA(IINTS))
C
      CALL INOUT(Z(INTS),IA(IJXX),IA(KLXX),IA(IJWW),IA(KLWW),IA(IJGRP)
     #,          IA(IINTS),IA(IAD),Z(VAL),IA(IVAL))
C
      WRITE (ITAPE6,51)
   51 FORMAT (1H ,'STARTING TO FORM 3 & 4-EXTERNAL CONTRIBUTIONS')
C
      CALL XXINT(Z(INTS),Z(H3),IA(ORBSYM),IA(IJGRP),IA(IJADD)
     #,          IA(KADD),IA(LADD),IA(IINTS),ACRCY,ILBM,ILBN
     #,          IA(IJXX),IA(KLXX),IA(IJWW),IA(KLWW),
     #           IA(IAD),Z(VAL),IA(IVAL))
C
      WRITE (ITAPE6,52)
   52 FORMAT (1H ,'CHAIN BACK THROUGH SORT TAPE TO FINISH',/)
      CALL FINSRT(IA(IAD),Z(VAL),Z(INTS),IA(IVAL),IA(IINTS))
C
C
C
CTJL  CALL CPUTIM(SECS)
CTJL  MIN=SECS/60
CTJL  SECS=SECS-MIN*60
CTJL  WRITE (ITAPE6,53) MIN,SECS
CTJ53 FORMAT (//,'      CPUTIME USED: ',I3,':',F6.3,/)
C
      WRITE(ITAPE6,5)
      RETURN
C
C^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ERRORS
C
C 920 WRITE(ITAPE6,925)NORBS,NORB2
C 925 FORMAT(' NUMBER OF ORBITALS DOES NOT MATCH ',2I10)
CCCCC CALL EXIT  >>>>>>>  THERE IS NO GO TO 920 OR ANYOTHER NORB2
  930 WRITE(ITAPE6,935)LENI
  935 FORMAT(' INSUFFICIENT SPACE IN INTEGER BLANK COMMON NEED',I10,
     *' WORDS.')
      CALL mabort
  940 WRITE(ITAPE6,945)LENR
  945 FORMAT(' INSUFFICIENT SPACE IN BLANK COMMON NEED',I10,' WORDS.')
      CALL mabort
      END
