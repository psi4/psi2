      SUBROUTINE CISORT(BKTPNT,START,ILAST,BKTSZ,NBKT,RESRT,INTOFF,MOARR
     1,MOBKT,MOLBL,MOSRT,MOVAL,SRTAR,LENMO,BKTR,LCIBUF,SRTI,IRESRT)
C
C
C
      IMPLICIT INTEGER (A-Z)
C
C
      integer lenmo,bktr,nmax
      INTEGER TIME,STARTT,ENDD
      INTEGER ILAST(NBKT),INTOFF(NBKT),MOBKT(LENMO),MOLBL(LENMO)
      INTEGER MOARR(BKTSZ),SRTI(1),IRESRT(1)
      REAL*8 MOSRT(LENMO),MOVAL(BKTR),RESRT(NMAX),VAL,SEC,SRTAR(1)
      REAL*8 UPTOL
CDB   REAL*8 SUM
C
      COMMON /TAPES/  IT34,IT58,IT47,IT52,IT91,IT93,IT95
      COMMON /OUT/    IOUT6,ICHECK,IDBG,ICNT
      COMMON /SRT/    VAL,ILBL,IBKT,IADBK,MNBK,MXBK
      COMMON /DIMS/   SYMORB,NUMIJ,NIJ,NBF,NORBS,NMAX,NBFORB,NSYM0
C
      DIMENSION BKTPNT(1),START(1)
C
C
C
C
      WRITE(IOUT6,709)
  709 FORMAT (/,' STARTING THE FINAL SORT OF THE INTEGRALS TO GUGA '
     #,       'ORDER')
C
      IERIN=0
      IEOUT=0
      UPTOL=1.0D+10
      IADBK=NBKT
      MNBK=1
      MXBK=NBKT
      LENIN=I2SEC(LENMO*4+2)
      LENOUT=I2SEC(INTOWP(NMAX))
      SRIN=0
      SWOUT=0
      CALL SREW(IT93)
      CALL SREW(IT91)
      CALL SRTONE(BKTPNT,START,ILAST,BKTSZ,NBKT,SRTAR,SRTI,INTOFF,
     1IT93)
C     PRINT,'  BACK FROM SRTONE'
 10   CALL RGETSA(IT91,IX)
      CALL SREAD(IT91,MOARR,LENMO*4+2)
C
CDB   SUM=0.0D+00
      SRIN=SRIN+LENIN
C     CALL BUBY(MOLBL,MOBKT,MOSRT,MOARR(2))
      IADR=MOARR(1)
C     WRITE(IOUT6,1101) IADR,MOARR(2),IX
C1101 FORMAT('  IADR=',I8,'  NUMINTS=',I8,'  FROM=',I8)
      DO 1 II=1,MOARR(2)
           VAL=MOSRT(II)
C     IF (DABS(VAL) .GT. UPTOL) THEN
C     IERIN=IERIN+1
C     IF (IERIN .LE. 100) THEN
C     WRITE(IOUT6,911) II,IERIN,VAL
C911  FORMAT('  ERROR IN:',2I6,G20.10)
C     END IF
C     END IF
CDB   SUM=SUM+ABS(VAL)
           ILBL=MOLBL(II)
           IBKT=MOBKT(II)
C     IF (II .LT. 10  .OR.  II .GT. (MOARR(2)-10)) THEN
C     PRINT *,'  VAL=',VAL,'  ILBL=',ILBL,'  IBKT=',IBKT
C     WRITE(IOUT6,702) VAL,ILBL,IBKT,II
C 702 FORMAT (' VAL ',E18.8,' ILBL ',I6,' IBKT ',I4,'  II',I5)
C     END IF
           CALL SRTOUT(BKTPNT,START,ILAST,BKTSZ,NBKT,
     *     SRTAR,SRTI,INTOFF,IT93)
    1 CONTINUE
C
CDB   WRITE(IOUT6,'(' --CISORT FIRST SUM IS',G20.10)') SUM
C
      IF (IADR. NE. -1) GOTO 10
      CALL SRTLST(BKTPNT,START,ILAST,BKTSZ,NBKT,
     *SRTAR,SRTI,INTOFF,IT93)
CTJL
      CALL RCLOSE(IT91,4)
CTJL
C
      INTF=INTOFF(1)
      DO 5 IBKT=1,NBKT
C     PRINT *,'  IBKT=',IBKT
           DO 2 JJ=1,NMAX
                RESRT(JJ)=0.0D+00
    2      CONTINUE
           IADR=ILAST(IBKT)
           IF (IADR.EQ.-1) GO TO 21
 20        CALL RREAD(IT93,MOARR,BKTSZ,IADR)
           IADR=MOARR(1)
C     PRINT,'  BEFORE LOOP, RESRT(15)=',RESRT(15)
           DO 3 II=1,MOARR(2)
                RESRT(MOARR(II+2))=MOVAL(II+INTF)
C     IF (II.LT.10 .OR. II.GT.(MOARR(2)-10)) THEN
C     WRITE(IOUT6,804) II,RESRT(MOARR(II+2))
C804  FORMAT(I6,G18.8)
C     END IF
C     IF (DABS(MOVAL(II+INTF)) .GT. UPTOL) THEN
C     IEROUT=IEROUT+1
C     IF (IEROUT .LE. 100) THEN
C     WRITE(IOUT6,912) II,IEROUT,MOVAL(II+INTF)
C912  FORMAT('  ERROR OUT:',2I6,G20.10)
C     END IF
C     END IF
    3      CONTINUE
           IF (IADR. NE. -1 ) GOTO 20
   21      CONTINUE
           CALL RGETSA(IT52,IX)
           CALL SWRIT(IT52,IRESRT,NMAX*2)
           SWOUT=SWOUT+LENOUT
C
CDB   SUM=0.0D+00
CDB   DO 101 IQ=1,NMAX
CDB      SUM=SUM+ABS(RESRT(IQ))
CD101 CONTINUE
CDB   WRITE(IOUT6,'(' --IN CISORT, SUM IS',G20.10)') SUM
C
CDB   PRINT,'  WRITTEN TO IT52, IADR=',IX,'  WORDS=',NMAX*2
C     WRITE(IOUT6,'(7G18.8)') (RESRT(IOP),IOP=1,NMAX)
    5 CONTINUE
C
      WRITE(IOUT6,701) SRIN,IT91,SWOUT,IT52
  701 FORMAT (5X,I8,' SECTORS  READ FROM TAPE ',I3,/
     #,       5X,I8,' SECTORS WRITTEN TO TAPE ',I3)
C
C     WRITE(IOUT6,913) IERIN,IEROUT,UPTOL
 913  FORMAT('  IERIN,IEROUT,UPTOL:',2I6,G20.10)
      RETURN
      END
