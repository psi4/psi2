       SUBROUTINE HDIAG(H,U,X,N,IQ,IORDER)
       IMPLICIT DOUBLE PRECISION (A-H,O-Z)
       DIMENSION H(N,N),U(N,N),X(N),IQ(N)
       TWO = 2.0 D+00
       ONE = 1.0 D+00
       ZERO = 0.0 D+00
       DO 14 I=1,N
       DO 14 J=1,N
       IF(I-J) 12,11,12
   11  U(I,J)=1.0D+00
       GO TO 14
   12  U(I,J)=0.0D+00
   14  CONTINUE
   15  NR=0
       IF(N-1) 1000,1000,17
   17  NMI1=N-1
       DO 30 I=1,NMI1
       X(I)=ZERO
       ILP1=I+1
       DO 30 J=ILP1,N
       IF(X(I)-ABS(H(I,J))) 20,20,30
   20  X(I)=ABS(H(I,J))
       IQ(I)=J
   30  CONTINUE
       RAP=1.0D-9
       HDTES=1.0E30
   40  DO 70 I=1,NMI1
       IF(I-1) 60,60,45
   45  IF(XMAX-X(I)) 60,70,70
   60  XMAX=X(I)
       IPIV=I
       JPIV=IQ(I)
   70  CONTINUE
       IF(XMAX) 1000,1000,80
   80  IF(HDTES) 90,90,85
   85  IF(XMAX-HDTES) 90,90,148
   90  HDIMT=ABS(H(1,1))
       DO 110 I=2,N
       IF(HDIMT-ABS(H(I,I))) 110,110,100
  100  HDIMT=ABS(H(I,I))
  110  CONTINUE
       HDTES=HDIMT*RAP
       IF(HDTES-XMAX) 148,1000,1000
  148  NR=NR+1
  150  IF(H(IPIV,IPIV)-H(JPIV,JPIV)) 1152,1151,1152
 1151  THETA= ATAN(1.0)
       THETA=SIGN(THETA,H(IPIV,JPIV))
       THETA=SIGN(THETA,(H(IPIV,IPIV)-H(JPIV,JPIV)))
       GO TO 1153
 1152  TANG=TWO*H(IPIV,JPIV)/(H(IPIV,IPIV)-H(JPIV,JPIV))
       THETA= ATAN(TANG)
       THETA=THETA/TWO
 1153  COSIN= COS(THETA)
       SINE= SIN(THETA)
       TANG=SINE/COSIN
       HII=H(IPIV,IPIV)
       H(IPIV,IPIV)=COSIN**2*(HII+TANG*(TWO*H(IPIV,JPIV)+TANG*H(JPIV,
     1   JPIV)))
       H(JPIV,JPIV)=COSIN**2*(H(JPIV,JPIV)-TANG*(TWO*H(IPIV,JPIV)-
     1   TANG*HII))
       H(IPIV,JPIV)=ZERO
       IF(IORDER.EQ.1) GO TO 153
       IF(H(IPIV,IPIV)-H(JPIV,JPIV))153,153,152
  152  HTEMP=H(IPIV,IPIV)
       H(IPIV,IPIV)=H(JPIV,JPIV)
       H(JPIV,JPIV)=HTEMP
       HTEMP=SIGN(ONE,-SINE)*COSIN
       COSIN=ABS(SINE)
       SINE=HTEMP
  153  CONTINUE
       DO 350 I=1,NMI1
       IF(I-IPIV) 210,350,200
  200  IF(I-JPIV) 210,350,210
  210  IF(IQ(I)-IPIV) 230,240,230
  230  IF(IQ(I)-JPIV) 350,240,350
  240  K=IQ(I)
  250  HTEMP=H(I,K)
       H(I,K)=ZERO
       IPL1=I+1
       X(I)=ZERO
       DO 320 J=IPL1,N
       IF(X(I)-ABS(H(I,J))) 300,300,320
  300  X(I)=ABS(H(I,J))
       IQ(I)=J
  320  CONTINUE
       H(I,K)=HTEMP
  350  CONTINUE
       X(IPIV)=ZERO
       X(JPIV)=ZERO
       DO 530 I=1,N
       IF(I-IPIV) 370,530,420
  370  HTEMP=H(I,IPIV)
       H(I,IPIV)=COSIN*HTEMP+SINE*H(I,JPIV)
       IF(X(I)-ABS(H(I,IPIV))) 380,390,390
  380  X(I)=ABS(H(I,IPIV))
       IQ(I)=IPIV
  390  H(I,JPIV)=-SINE*HTEMP+COSIN*H(I,JPIV)
       IF(X(I)-ABS(H(I,JPIV))) 400,530,530
  400  X(I)=ABS(H(I,JPIV))
       IQ(I)=JPIV
       GO TO 530
  420  IF(I-JPIV) 430,530,480
  430  HTEMP=H(IPIV,I)
       H(IPIV,I)=COSIN*HTEMP+SINE*H(I,JPIV)
       IF(X(IPIV)-ABS(H(IPIV,I))) 440,450,450
  440  X(IPIV)=ABS(H(IPIV,I))
       IQ(IPIV)=I
  450  H(I,JPIV)=-SINE*HTEMP+COSIN*H(I,JPIV)
       IF (X(I)-ABS(H(I,JPIV))) 400,530,530
  480  HTEMP=H(IPIV,I)
       H(IPIV,I)=COSIN*HTEMP+SINE*H(JPIV,I)
       IF(X(IPIV)-ABS(H(IPIV,I))) 490,500,500
  490  X(IPIV)=ABS(H(IPIV,I))
       IQ(IPIV)=I
  500  H(JPIV,I)=-SINE*HTEMP+COSIN*H(JPIV,I)
       IF(X(JPIV)-ABS(H(JPIV,I))) 510,530,530
  510  X(JPIV)=ABS(H(JPIV,I))
       IQ(JPIV)=I
  530  CONTINUE
  540  DO 550 I=1,N
       HTEMP=U(I,IPIV)
       U(I,IPIV)=COSIN*HTEMP+SINE*U(I,JPIV)
  550  U(I,JPIV)=-SINE*HTEMP+COSIN*U(I,JPIV)
       GO TO 40
 1000  DO 1010 I=1,NMI1
       ILP1=I+1
       DO 1010 J=ILP1,N
 1010  H(J,I)=H(I,J)
       RETURN
       END
