      SUBROUTINE SOLVED(FSAVE,ERROR,FC,FO,BMAT,NNPBLK,NFOCK,NDIIS,N,M,
     #                  MNDIIS,MXDIIS,DETERM,DETCUT,IPRINT,IOUT)
C
C***PURPOSE: TO SET UP AND SOLVE THE DIIS EQUATIONS
C
      IMPLICIT INTEGER (A-Z)
C
      REAL*8 FSAVE(NNPBLK,NFOCK,NDIIS),ERROR(NNPBLK,NDIIS)
      REAL*8 FC(NNPBLK),FO(NNPBLK),BMAT(N,M)
      REAL*8 DETERM,SDOT,NORM,DETCUT
      logical btest
C
C     ----- SET UP THE SMALL MATRIX -----
C
      DO 1 I=1,N
         BMAT(I,1)=-1.0D+00
         BMAT(1,I)=-1.0D+00
    1 CONTINUE
      BMAT(1,1)=0.0D+00
      NORM=SDOT(NNPBLK,ERROR(1,MNDIIS),1,ERROR(1,MNDIIS),1)
      BMAT(2,2)=1.0D+00
      DO 3 I=3,N
         IPT=MNDIIS+I-2
         IF (IPT.GT.NDIIS) IPT=IPT-NDIIS
         DO 2 J=2,I
            JPT=MNDIIS+J-2
            IF (JPT.GT.NDIIS) JPT=JPT-NDIIS
            BMAT(I,J)=SDOT(NNPBLK,ERROR(1,IPT),1,ERROR(1,JPT),1)/NORM
            BMAT(J,I)=BMAT(I,J)
    2    CONTINUE
    3 CONTINUE
C
      BMAT(1,M)=-1.0D+00
      DO 4 I=2,N
         BMAT(I,M)=0.0D+00
    4 CONTINUE
C
      IF (BTEST(IPRINT,10)) THEN
C        WRITE (IOUT,15)
C  15    FORMAT (/,' DIIS MATRIX:')
CPWS     CALL MATOUT(BMAT,N,M,N,M,IOUT)
      END IF
C
C     ----- SOLVE THE SMALL EQUATIONS -----
C
      CALL FLIN2 (BMAT,N,N,1,DETERM)
CTJL  WRITE(IOUT,11112) DETERM
C1112 FORMAT(' DETERM RETURNED BY FLIN2 =',E20.12)
C        CALL MATOUT(BMAT,N,M,N,M,IOUT)
C
C     ----- RETURN IF PROBLEMS SOLVING -----
C
      IF (ABS(DETERM).LT.DETCUT) RETURN
C
      IF (BTEST(IPRINT,11)) THEN
C        WRITE (IOUT,16) (BMAT(I,M),I=2,N)
C  16    FORMAT (/,' THE DIIS SOLUTION VECTOR:',/,(1X,10F7.4))
      END IF
C
C     ----- FORM THE NEW FOCK MATRICES -----
C
      CALL ZERO(FC,NNPBLK)
      IF (NFOCK.EQ.2) CALL ZERO(FO,NNPBLK)
      DO 6 I=2,N
         IPT=MNDIIS+I-2
         IF (IPT.GT.NDIIS) IPT=IPT-NDIIS
         CALL SAXPY(NNPBLK,BMAT(I,M),FSAVE(1,1,IPT),1,FC,1)
         IF (NFOCK.EQ.2) CALL SAXPY(NNPBLK,BMAT(I,M),FSAVE(1,2,IPT),1,
     #                              FO,1)
    6 CONTINUE
C     WRITE (3,30)
C  30 FORMAT (' THE DIISED FOCK MATRICES')
C     CALL BRINT(FC,7,7,IOUT)
C     CALL BRINT(FO,7,7,IOUT)
C
C
      RETURN
      END
