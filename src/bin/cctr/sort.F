C
C                         ********************
C-------------------------******  SORT  ******-------------------------
C                         ********************
C
      SUBROUTINE SORT(BKT,IBKT,LBLI,PKI,IBKTSP,INBUFS,NBUCK,JOUT,ITAP34
     .           ,ITRI,ITAP77,MCHAIN,MAXBKT,NIOBF,LENGTH,MAXVAL,IWRIT)
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION LBLI(INBUFS*2),PKI(INBUFS),MCHAIN(MAXBKT)
      DIMENSION BKT(IBKTSP),IBKT(IBKTSP*2)
      COMMON/SIGNS/IOFF(256),IPRNT
      COMMON/SYMMS/IDEG(10),NDEG(10),LSYM(10)
      COMMON/PAKQ/I1,I2,I3
      DATA A0 / 0.0D+00 /
    1 FORMAT(2X,' ILSTI = ',I5/
     1       2X,' NBUF  = ',I5/)
    2 FORMAT(2X,9I5,3F15.7)
   11 FORMAT ('                                                ')
   12 FORMAT ('************************************************')
      MINSEC=10
      CALL ZERO(BKT,IBKTSP)
C
CC    IF (NIOBF.LT.MINSEC) THEN
CC       WRITE (JOUT,13)
CC 13    FORMAT (' INSUFFICIENT CC TO SORT 2 ELECTRON INTEGRALS')
CC       CALL MABORT
CC    END IF
C
      INTLEN=(INTOWP(LENGTH)-2)/INTOWP(1)
      MAXVAL=INTOWP(INTLEN)/(1+INTOWP(1))
CTJL  IVOFF=(MAXVAL+2)/INTOWP(1)
      IVOFF=(MAXVAL+3)/INTOWP(1)
      IWRIT=0
C
      IBUFSZ=INBUFS*2
      IBUFQT=(INBUFS-1)/2+1
      IBL=0
      INTI=0
      INTO=0
      NBLI=0
      NBLO=0
      NINT=0
  201 NBLI=NBLI+1
      CALL SREAD(ITAP34,LBLI,IBUFSZ)
      ILSTI=LBLI(1)
      NBUF=LBLI(2)
      IF(IPRNT.GE.5)
     *WRITE(6,1) ILSTI,NBUF
C***  WRITE(8,15) NBUF
C**15 FORMAT(I5)
c     WRITE (JOUT,*) ' ENTERING SORTLOOP'
C
      DO 101 I=1,NBUF
      LOR=ISHFT(LBLI(I+I+2),-2)
      LSM=ISHFT(LOR,-8)
      KOR=ISHFT(LSM,-3)
      KSM=ISHFT(KOR,-8)+1
      KOR=IAND(KOR,255)
      LSM=IAND(LSM,7)+1
      LOR=IAND(LOR,255)
      III=IAND(LBLI(I+I+2),3)
      JSM=ISHFT(LBLI(I+I+1),-8)
      IOR=ISHFT(JSM,-3)
      ISM=ISHFT(IOR,-8)+1
      IOR=IAND(IOR,255)
      JSM=IAND(JSM,7)+1
      JOR=IAND(LBLI(I+I+1),255)
      II=IOR+IDEG(ISM)
      JJ=JOR+IDEG(JSM)
      KK=KOR+IDEG(KSM)
      LL=LOR+IDEG(LSM)
      PKII=PKI(I+IBUFQT)
C
C     WRITE(6,678)II,JJ,KK,LL,PKII
C 678 FORMAT (4I6,F20.12)
C
      IJ=IOFF(II)+JJ
      KL=IOFF(KK)+LL
      IF (IJ.EQ.KL) GOTO 1111
      IBUCK1=((IJ-1)/ITRI)+1
      NOFF1=(IBUCK1-1)*LENGTH
      IFILL1=IBKT(INTOWP(NOFF1)+2)+1
      IF (IFILL1.GT.MAXVAL) THEN
C        WRITE (JOUT,11)
C        WRITE (JOUT,12)
C        WRITE (JOUT,*) ' IBUCK1=',IBUCK1
C        WRITE (JOUT,11)
C        WRITE (JOUT,12)
CC       CALL MATOUT(BKT(NOFF1+1),LENGTH,1,LENGTH,1,JOUT)
C        DO 14 M=1,MAXVAL
C           I3=IBKT(INTOWP(NOFF1)+2+M)
C           CALL UNPAK
C           IJ=I1
C           KL=I2
C       WRITE (JOUT,*) IBKT(INTOWP(NOFF1)+2+M),IJ,KL,BKT(NOFF1+IVOFF+M)
C  14    CONTINUE
         CALL BKTDMP(BKT(NOFF1+1),LENGTH,ITAP77,ICHAN1)
         IWRIT=IWRIT+1
C        WRITE (JOUT,*) ' ICHAN1=',ICHAN1
         CALL ZERO(BKT(NOFF1+1),LENGTH)
         IBKT(INTOWP(NOFF1)+1)=ICHAN1
         IFILL1=1
      END IF
      I1=IJ
      I2=KL
      CALL PAK
      IBKT(INTOWP(NOFF1)+2+IFILL1)=I3
      BKT(IVOFF+NOFF1+IFILL1)=PKII
CTJL
C     IF(IVOFF+IFILL1.GE.1.OR.IVOFF+IFILL1.LE.10) THEN
C     WRITE(*,*) ' IN SORT:IJ,KL,VAL=',IJ,KL,PKII
C     END IF
CTJL
      IBKT(INTOWP(NOFF1)+2)=IFILL1
CC    WRITE (JOUT,*) ' IBUCK=',IBUCK1
CC    WRITE (JOUT,*) ' ICHAN=',IBKT(INTOWP(NOFF1)+1)
CC    WRITE (JOUT,*) ' IFILL=',IBKT(INTOWP(NOFF1)+2)
 1111 IBUCK2=((KL-1)/ITRI)+1
      NOFF2=(IBUCK2-1)*LENGTH
      IFILL2=IBKT(INTOWP(NOFF2)+2)+1
      IF (IFILL2.GT.MAXVAL) THEN
C        WRITE (JOUT,11)
C        WRITE (JOUT,12)
C        WRITE (JOUT,*) ' IBUCK2=',IBUCK2
C        WRITE (JOUT,11)
C        WRITE (JOUT,12)
C        CALL MATOUT(BKT(NOFF2+1),LENGTH,1,LENGTH,1,JOUT)
C        DO 24 M=1,MAXVAL
C           I3=IBKT(INTOWP(NOFF2)+2+M)
C           CALL UNPAK
C           IJ=I2
C           KL=I1
C       WRITE (JOUT,*) IBKT(INTOWP(NOFF2)+2+M),IJ,KL,BKT(NOFF2+IVOFF+M)
C  24    CONTINUE
         CALL BKTDMP(BKT(NOFF2+1),LENGTH,ITAP77,ICHAN2)
         IWRIT=IWRIT+1
C        WRITE (JOUT,*) ' ICHAN2=',ICHAN2
         CALL ZERO(BKT(NOFF2+1),LENGTH)
         IBKT(INTOWP(NOFF2)+1)=ICHAN2
         IFILL2=1
      END IF
      I1=KL
      I2=IJ
      CALL PAK
      IBKT(INTOWP(NOFF2)+2+IFILL2)=I3
      BKT(IVOFF+NOFF2+IFILL2)=PKII
      IBKT(INTOWP(NOFF2)+2)=IFILL2
CC    WRITE (JOUT,*) ' IBUCK=',IBUCK2
CC    WRITE (JOUT,*) ' ICHAN=',IBKT(INTOWP(NOFF2)+1)
CC    WRITE (JOUT,*) ' IFILL=',IBKT(INTOWP(NOFF2)+2)
  101 CONTINUE
      INTI=INTI+NBUF
      IF(ILSTI.EQ.0) GO TO 201
C
      DO 22 KBKT=1,NBUCK
         NOFF=(KBKT-1)*LENGTH
C        WRITE (JOUT,11)
C        WRITE (JOUT,12)
C        WRITE (JOUT,*) ' IBUCK=',KBKT
C        WRITE (JOUT,11)
C        WRITE (JOUT,12)
C        DO 34 M=1,MAXVAL
C           I3=IBKT(INTOWP(NOFF)+2+M)
C           CALL UNPAK
C           IJ=I1
C           KL=I2
C        WRITE (JOUT,*) IBKT(INTOWP(NOFF)+2+M),IJ,KL,BKT(NOFF+IVOFF+M)
C  34    CONTINUE
         CALL BKTDMP(BKT(NOFF+1),LENGTH,ITAP77,ICHAN)
         IWRIT=IWRIT+1
         MCHAIN(KBKT)=ICHAN
C        WRITE (JOUT,*) ' ICHAN=',ICHAN
C        WRITE(JOUT,79)KBKT,MCHAIN(KBKT)
   79    FORMAT (' MCHAIN(',I5,')=',I5)
   22 CONTINUE
      CALL ZERO(BKT,IBKTSP)
      CALL ZERO(PKI,INBUFS)
C
      RETURN
      END
