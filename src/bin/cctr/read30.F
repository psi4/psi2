C
C                         ********************
C-------------------------****** READ30 ******-------------------------
C                         ********************
C
      SUBROUTINE READ30(ITAP30,MPOINT,MCONST,MCALCS,NCALCS,NBF,NBFAO,
     .                  NSYMHF,MXCOEF,EIGVEC,EIGVAL,NLAMDA,ITEMP,XVEC,
     .                  JOUT,NC,NO,PTOCC,WTEMP,ITYP,NIRRED,FLOV,ORBSYM,
     .                  NTRI,NUMSYM,IWRK,KLPNT,IJPNT,IOFF1,IOFF2)
C
      IMPLICIT REAL*8 (A-H,O-Z)
C
      CHARACTER*4 CHAR,LABEL(20)
      INTEGER NORD
      REAL*8 EIGVEC(NBFAO,NBF),EIGVAL(NBF),XVEC(MXCOEF),WTEMP(NBF,NBF)
      CHARACTER*4 ITYP(NSYMHF),ICSYM,CSYM1,CSYM2
      INTEGER NLAMDA(NSYMHF),ITEMP(MCALCS),NC(NSYMHF),PTOCC(NBF),
     .        FLOV(NIRRED,2),ORBSYM(NBF),NUMSYM(NIRRED),IWRK(NIRRED),
     .        KLPNT(NTRI),IJPNT(NTRI),IOFF1(NTRI),IOFF2(NTRI),
     .        symorb
      integer errcod,frdc,prcntr
C     DATA CSYM1 /4HA'  /, CSYM2 /4HA"  /
C
      JPOINT = 101 + MCONST + MPOINT
C
c     write(6,*)'in read30 arrive safely!'
c     write(6,*)'nbf=',nbf
c     call flush(6)
c
      IC=0
      DO 88 I=1,NBF
      DO 88 J=1,I
         IC=IC+1
         IOFF1(IC)=I
         IOFF2(IC)=J
   88 CONTINUE
C
      CALL WREADW (ITAP30,ITEMP,MCALCS,JPOINT,JPOINT)
      LOCCAL = ITEMP(NCALCS)
      JPOINT = LOCCAL + 60
      CALL WREADW (ITAP30,LOCVEC,1,JPOINT,JPOINT)
      CALL WREADW (ITAP30,XVEC,INTOWP(MXCOEF),LOCVEC,LOCVEC)
      CALL WREADW (ITAP30,EIGVAL,INTOWP(NBF),LOCVEC,LOCVEC)
      CALL WREADW (ITAP30,ITYP,NSYMHF,LOCVEC,LOCVEC)
C     WRITE(6,*) 'ITYP',ITYP
c     DO 333 I =1,NBF
c     WRITE(6,*)'I=',I,'E(I)=',EIGVAL(I)
c     call flush(6)
c333  continue
C     LOCVEC = LOCVEC + NSYMHF
C     WRITE(6,*) ' LOCVEC,MXCOEF = ',LOCVEC,MXCOEF
      CALL WREADW (ITAP30,NLAMDA,NSYMHF,LOCVEC,LOCVEC)
C     WRITE(6,*) '  NLAMDA ',NLAMDA
      CALL WREADW (ITAP30,NC,NSYMHF,LOCVEC,LOCVEC)
      NO=0
c     DO 555 I=1,NSYMHF
c        NO=NO+NC(I)
c        WRITE (JOUT,*) ' NC=',NC(I)
c        call flush(6)
c 555 CONTINUE
      ICNT=0
      IOF = 0
      DO 558 I=1,NSYMHF
      IF(I.NE.1) IOF = IOF + NLAMDA(I-1)
      NOI=NC(I)
      DO 557 J=1,NOI
      ICNT=ICNT+1
      IPT=IOF+J
C     WRITE(6,*)'IPT=',IPT,ICNT
  557 PTOCC(IPT)=ICNT
  558 CONTINUE
      IOF = 0
      DO 658 I=1,NSYMHF
      IF(I.NE.1) IOF = IOF + NLAMDA(I-1)
      NVI=NLAMDA(I)-NC(I)
      DO 657 J=1,NVI
      ICNT=ICNT+1
      IPT=IOF+NC(I) + J
C     WRITE(6,*)'IPT=',IPT,ICNT
  657 PTOCC(IPT)=ICNT
  658 CONTINUE
      DO 559 I=1,NBF
      IPT=PTOCC(I)
  559 WTEMP(IPT,1)=EIGVAL(I)
      DO 569 I=1,NBF
      EIGVAL(I)=WTEMP(I,1)
C     WRITE(6,*)'I=',I,'E(I)=',EIGVAL(I)
  569 CONTINUE
      CALL ZERO(WTEMP,NBF*NBF)
C
C LET'S SYMMETRY BLOCK THE EIGENVECTORS
C
      IOF = 0
      IJ = 0
      DO 1001 ISYM = 1,NSYMHF
      N = NLAMDA(ISYM)
      DO 1002 J = 1,N
      DO 1003 I = 1,N
      IJ = IJ + 1
      EIGVEC(IOF+I,IOF+J) = XVEC(IJ)
 1003 CONTINUE
 1002 CONTINUE
      IOF = IOF + N
 1001 CONTINUE
C     DO 1765 I=1,NBFAO
C     DO 1765 J=1,NBF
C     JPT=PTOCC(J)
C1765 EIGVEC(I,JPT)=WTEMP(I,J)
C
C     WRITE(JOUT,*)
C     WRITE(JOUT,*) ' THE SCF EIGENVECTORS '
C     WRITE(JOUT,*)
C     CALL MATOUT (EIGVEC,NBFAO,NBF,NBFAO,NBF,JOUT)
C
      DO 805 ISYM = 1,NIRRED
      FLOV(ISYM,1) = 0
      FLOV(ISYM,2) = -1
  805 CONTINUE
C
C     GET SYMMETRY LABEL FROM INPUT
C
      CALL LOCATE (5,'# INPUT ###',IERR)
      IF(IERR.NE.0) THEN
         errcod = frdc('SYMMETRY',char)
         if (errcod.ne.0) then
           write(6,*) 'ERROR: Could not find ''SYMMETRY'' in input'
           call fioflu(6)
           call pabort
           call qabort
           endif
         call consym(char,nord)
      ELSE
         write(6,*) 'WARNING: using ''# INPUT ###'' for symmetry'
      READ(5,6004)LABEL
      READ(5,6004)LABEL
 6004 FORMAT(20A4)
 6005 FORMAT(A4,5X,I1)
      READ(5,6005)CHAR,NORD
      WRITE(6,6024)CHAR,NORD
 6024 FORMAT(//,'SYMMETRY LABEL FROM INPUT',/,A4,5X,I1)
      END IF
C
      ICNT=0
      DO 705 ISYM=1,NSYMHF
      ICSYM=ITYP(ISYM)
      ICNTH=ICNT+1
      NBFI=NLAMDA(ISYM)
      DO 700 I=1,NBFI
      ICNT=ICNT+1
c
      ORBSYM(ICNT)=ISYM-1
c
c     IF(ICSYM.EQ.'A1  ')ORBSYM(ICNT)=0
c     IF(ICSYM.EQ.'A2  ')ORBSYM(ICNT)=1
c     IF(ICSYM.EQ.'B1  ')ORBSYM(ICNT)=2
c     IF(ICSYM.EQ.'B2  ')ORBSYM(ICNT)=3
c     IF(ICSYM.EQ.'A   ')ORBSYM(ICNT)=0
c     IF(ICSYM.EQ.'B   ')ORBSYM(ICNT)=1
c     IF(ICSYM.EQ.'A''  ')ORBSYM(ICNT)=0
c     IF(ICSYM.EQ.'A"  ')ORBSYM(ICNT)=1
c     IF(ICSYM.EQ.'AG  ')ORBSYM(ICNT)=0
c     IF(ICSYM.EQ.'B1G ')ORBSYM(ICNT)=1
c     IF(ICSYM.EQ.'B2G ')ORBSYM(ICNT)=2
c     IF(ICSYM.EQ.'B3G ')ORBSYM(ICNT)=3
c     IF(ICSYM.EQ.'AU  ')ORBSYM(ICNT)=4
c     IF(ICSYM.EQ.'B1U ')ORBSYM(ICNT)=5
c     IF(ICSYM.EQ.'B2U ')ORBSYM(ICNT)=6
c     IF(ICSYM.EQ.'B3U ')ORBSYM(ICNT)=7
c     IF(NIRRED.GT.4) GO TO 690
c     IF(ICSYM.EQ.'AG  ')ORBSYM(ICNT)=0
c     IF(ICSYM.EQ.'BG  ')ORBSYM(ICNT)=1
c     IF(ICSYM.EQ.'AU  ')ORBSYM(ICNT)=2
c     IF(ICSYM.EQ.'BU  ')ORBSYM(ICNT)=3
c 690 CONTINUE
c     IF(CHAR.EQ.'DN  '.AND.NORD.EQ.2)THEN
c     IF(ICSYM.EQ.'A1  ')ORBSYM(ICNT)=0
c     IF(ICSYM.EQ.'B1  ')ORBSYM(ICNT)=1
c     IF(ICSYM.EQ.'B2  ')ORBSYM(ICNT)=2
c     IF(ICSYM.EQ.'B3  ')ORBSYM(ICNT)=3
c     ENDIF
  700 CONTINUE
      IF(ICNTH-1.NE.ICNT) THEN
      SYMORB = ORBSYM(ICNT) + 1
      FLOV(SYMORB,1)=ICNTH
      FLOV(SYMORB,2)=ICNT
      END IF
      if (prcntr('IS_ON BRIEF').eq.0)
     &  WRITE(6,*)'ISYM',ISYM,FLOV(ISYM,1),flov(isym,2)
  705 CONTINUE
      if (prcntr('IS_ON BRIEF').eq.0) then
        WRITE(6,*)'ORBSYM'
        WRITE(6,*) ORBSYM
        endif
C
      DO 122 I=1,NIRRED
         IWRK(I)=0
         NUMSYM(I)=0
  122 CONTINUE
      DO 123 I=1,NTRI
         KLPNT(I)=0
  123 CONTINUE
      IJ=0
      DO 124 I=1,NBF
         ISYM=ORBSYM(I)
      DO 124 J=1,I
         JSYM=ORBSYM(J)
         IJSYM=IEOR(ISYM,JSYM)
         IJ=IJ+1
         DO 125 IRR=1,NIRRED
            IF (IJSYM.EQ.(IRR-1)) NUMSYM(IRR)=NUMSYM(IRR)+1
  125    CONTINUE
         IWRK(IJSYM+1)=IWRK(IJSYM+1)+1
         KLPNT(IJ)=IWRK(IJSYM+1)
  124 CONTINUE
      IJLEN=NUMSYM(1)
      DO 126 I=1,NTRI
         IJPNT(I)=0
  126 CONTINUE
      IJ=0
      DO 127 I=2,NBF
         ISYM=ORBSYM(I)
      DO 127 J=1,I
         IJ=IJ+1
         JSYM=ORBSYM(J)
         IJSYM=IEOR(ISYM,JSYM)
         IJPNT(IJ)=IJPNT(IJ-1)+IJLEN
         IJLEN=NUMSYM(IJSYM+1)
  127 CONTINUE
C     WRITE (JOUT,*) ' PTOCC',PTOCC
C     WRITE (JOUT,*) ' NUMSYM',NUMSYM
C     WRITE (JOUT,*) ' IJPNT',IJPNT
C     WRITE (JOUT,*) ' KLPNT',KLPNT
      RETURN
      END
