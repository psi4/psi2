      SUBROUTINE SCFGR(EIG,OCC,ESO,UAS,EAO,U,T,H,DC,FC,FM,FF,EE,EZ,
     1                 LBLI,BUFI,CC)
      IMPLICIT REAL*8 (A-H,O-Z)
      integer nbatri,nbasis,nbfao,nbfso,maxbf4,maxbf2
      DIMENSION H(NBATRI),DC(NBATRI),FC(NBATRI),FM(NBATRI),FF(NBATRI)
      DIMENSION EIG(NBASIS),OCC(NBASIS)
      DIMENSION U(NBFAO,NBFAO),T(NBFAO,NBFAO)
      DIMENSION ESO(NBFSO,NBASIS),EAO(NBFAO,NBASIS),UAS(NBFAO,NBFSO)
      DIMENSION EE(NBFAO,NBFAO),EZ(NBFAO,NBFAO)
clj080889 The MIPS f77 2.0 comp cannot handle the cc dimension decl
clj080889      DIMENSION LBLI(MAXBF4),BUFI(MAXBF2),CC(NBFAO*4)
      DIMENSION LBLI(MAXBF4),BUFI(MAXBF2),CC(1)
      COMMON/BASIS/NBASIS,NTRI,NSYM,NBFAO,NBFSO,NBATRI
      COMMON/FUNCS/NTYPES,NATOMS,N3N
      COMMON/GRSCF/FOCC(10),NSORB(10)
      COMMON/LIMIT/MAXBAS,MAXBUF,MAXBF2,MAXBF4
      COMMON/SIGNS/IOFF(256),IPRNT
      COMMON/TAPES/ITAP34,ITAP36
      COMMON/CI101/IOPEN,IOCC,JOCC,KOCC
      DATA ZERO,HALF,ONE,TWO,THREE,FOUR / 0.0D+00 , 0.5D+00 , 1.0D+00 ,
     1                                    2.0D+00 , 3.0D+00 , 4.0D+00 /
C
    1 FORMAT(//,
     1 2X,'******************************************'/
     2 2X,'***THE AVERAGED FOCK GENERATING ROUTINE***'/
     3 2X,'******************************************'/)
    2 FORMAT(//,2X,' SORTED PITZER MO (SO BASIS)'/)
    3 FORMAT(//,2X,' DC MATRIX (SO BASIS)'/)
    4 FORMAT(2X,6I5,F15.8)
    5 FORMAT(//,2X,' TWO ELECTRON CONTRIBUTION FOR SO FOCK (F )'/)
    6 FORMAT(//,2X,' H MATRIX (SO BASIS)'/)
    7 FORMAT(//,2X,' MO FOCK MATRIX'/)
    8 FORMAT(//,2X,' TRANSFORMATION MATRIX'/)
    9 FORMAT(//,2X,' GENERAL OPEN-SHELL MO''S (SO BASIS)'/)
   10 FORMAT(//,2X,' GENERAL OPEN-SHELL MO''S (AO BASIS)'/)
C
      WRITE(6,1)
      IF(IPRNT.LE.2) GO TO 301
      WRITE(6,2)
      CALL EIGOUT(ESO,EIG,OCC,NBFSO,NBASIS,NBASIS,NBASIS,6)
C
C  CREATE AVERAGED DENSITY MATRIX IN SO BASIS
  301 IJ=0
      DO 102 I=1,NBASIS
      DO 102 J=1,I
      IJ=IJ+1
      VALU=ZERO
      DO 101 K=1,JOCC
  101 VALU=VALU+ESO(I,K)*ESO(J,K)*OCC(K)*HALF
      DC(IJ)=VALU
  102 CONTINUE
      IF(IPRNT.LE.2) GO TO 302
      WRITE(6,3)
      CALL PRINT(DC,NBATRI,NBASIS,6)
C
C   CREATE FOCK MATRIX USING SO INTEGRALS
C
C   TWO ELECTRON PART
  302 CALL SREW(ITAP36)
      DO 105 I=1,NTRI
  105 FC(I)=ZERO
C
  500 CALL SREAD(ITAP36,LBLI,MAXBF4)
      DO 110 I=1,MAXBUF
      IBA=LBLI(I+I-1)
      IBB=LBLI(I+I)
      IF(IBA.EQ.0) GO TO 501
      CALL UNPACK(II,JJ,KK,LL,IX,IBA,IBB)
      VALINT=BUFI(MAXBUF+I)
C     IF(IPRNT.LE.5) GO TO 305
C     WRITE(6,4) I,II,JJ,KK,LL,IX,VALINT
C
  305 GO TO (201,202,203,204,205,206,207,208,209,210,211,212,212,212),IX
C
C (II/II)   1=(11/11)
C
  201 IIII=IOFF(II+1)
      FC(IIII)=FC(IIII)+DC(IIII)*VALINT
      GO TO 110
C
C  (II/KK)  2=(22/11)
C
  202 IIII=IOFF(II+1)
      KKKK=IOFF(KK+1)
      IIKK=IOFF(II)+KK
      FC(IIII)=FC(IIII)+DC(KKKK)*VALINT*TWO
      FC(KKKK)=FC(KKKK)+DC(IIII)*VALINT*TWO
      FC(IIKK)=FC(IIKK)-DC(IIKK)*VALINT
      GO TO 110
C
C  (II/IL)  3=(22/21)
C
  203 IIII=IOFF(II+1)
      IILL=IOFF(II)+LL
      FC(IIII)=FC(IIII)+DC(IILL)*VALINT*TWO
      FC(IILL)=FC(IILL)+DC(IIII)*VALINT
      GO TO 110
C
C  (IJ/JJ)  4=(21/11)
C
  204 IIJJ=IOFF(II)+JJ
      JJJJ=IOFF(JJ+1)
      FC(IIJJ)=FC(IIJJ)+DC(JJJJ)*VALINT
      FC(JJJJ)=FC(JJJJ)+DC(IIJJ)*VALINT*TWO
      GO TO 110
C
C  (IJ/IJ)  5=(21/21)
C
  205 IIJJ=IOFF(II)+JJ
      IIII=IOFF(II+1)
      JJJJ=IOFF(JJ+1)
      FC(IIJJ)=FC(IIJJ)+DC(IIJJ)*VALINT*THREE
      FC(IIII)=FC(IIII)-DC(JJJJ)*VALINT
      FC(JJJJ)=FC(JJJJ)-DC(IIII)*VALINT
      GO TO 110
C
C  (II/KL)  6=(33/21)
C
  206 IIII=IOFF(II+1)
      KKLL=IOFF(KK)+LL
      IIKK=IOFF(II)+KK
      IILL=IOFF(II)+LL
      FC(IIII)=FC(IIII)+DC(KKLL)*VALINT*FOUR
      FC(KKLL)=FC(KKLL)+DC(IIII)*VALINT*TWO
      FC(IIKK)=FC(IIKK)-DC(IILL)*VALINT
      FC(IILL)=FC(IILL)-DC(IIKK)*VALINT
      GO TO 110
C
C  (IJ/KK)  7=(32/11)
C
  207 IIJJ=IOFF(II)+JJ
      KKKK=IOFF(KK+1)
      IIKK=IOFF(II)+KK
      JJKK=IOFF(JJ)+KK
      FC(IIJJ)=FC(IIJJ)+DC(KKKK)*VALINT*TWO
      FC(KKKK)=FC(KKKK)+DC(IIJJ)*VALINT*FOUR
      FC(IIKK)=FC(IIKK)-DC(JJKK)*VALINT
      FC(JJKK)=FC(JJKK)-DC(IIKK)*VALINT
      GO TO 110
C
C  (IJ/KK)  8=(31/22)
C
  208 IIJJ=IOFF(II)+JJ
      KKKK=IOFF(KK+1)
      IIKK=IOFF(II)+KK
      JJKK=JJ+IOFF(KK)
      FC(IIJJ)=FC(IIJJ)+DC(KKKK)*VALINT*TWO
      FC(KKKK)=FC(KKKK)+DC(IIJJ)*VALINT*FOUR
      FC(IIKK)=FC(IIKK)-DC(JJKK)*VALINT
      FC(JJKK)=FC(JJKK)-DC(IIKK)*VALINT
      GO TO 110
C
C (IJ/IL)  9=(32/31)
C
  209 IIJJ=IOFF(II)+JJ
      IILL=IOFF(II)+LL
      IIII=IOFF(II+1)
      JJLL=IOFF(JJ)+LL
      FC(IIJJ)=FC(IIJJ)+DC(IILL)*VALINT*THREE
      FC(IILL)=FC(IILL)+DC(IIJJ)*VALINT*THREE
      FC(IIII)=FC(IIII)-DC(JJLL)*VALINT*TWO
      FC(JJLL)=FC(JJLL)-DC(IIII)*VALINT
      GO TO 110
C
C  (IJ/JL)  10=(32/21)
C
  210 IIJJ=IOFF(II)+JJ
      JJLL=IOFF(JJ)+LL
      IILL=IOFF(II)+LL
      JJJJ=IOFF(JJ+1)
      FC(IIJJ)=FC(IIJJ)+DC(JJLL)*VALINT*THREE
      FC(JJLL)=FC(JJLL)+DC(IIJJ)*VALINT*THREE
      FC(IILL)=FC(IILL)-DC(JJJJ)*VALINT
      FC(JJJJ)=FC(JJJJ)-DC(IILL)*VALINT*TWO
      GO TO 110
C
C  (IJ/KJ)  11=(31/21)
C
  211 IIJJ=IOFF(II)+JJ
      KKJJ=IOFF(KK)+JJ
      IIKK=IOFF(II)+KK
      JJJJ=IOFF(JJ+1)
      FC(IIJJ)=FC(IIJJ)+DC(KKJJ)*VALINT*THREE
      FC(KKJJ)=FC(KKJJ)+DC(IIJJ)*VALINT*THREE
      FC(IIKK)=FC(IIKK)-DC(JJJJ)*VALINT
      FC(JJJJ)=FC(JJJJ)-DC(IIKK)*VALINT*TWO
      GO TO 110
C
C  (IJ/KL)     12=(43/21)
C  (IJ/KL)     13=(42/31)
C
  212 IIJJ=IOFF(II)+JJ
      KKLL=IOFF(KK)+LL
      IIKK=IOFF(II)+KK
      JJLL=IOFF(MAX0(JJ,LL))+MIN0(JJ,LL)
      IILL=IOFF(II)+LL
      JJKK=IOFF(MAX0(JJ,KK))+MIN0(JJ,KK)
      FC(IIJJ)=FC(IIJJ)+DC(KKLL)*VALINT*FOUR
      FC(KKLL)=FC(KKLL)+DC(IIJJ)*VALINT*FOUR
      FC(IIKK)=FC(IIKK)-DC(JJLL)*VALINT
      FC(JJLL)=FC(JJLL)-DC(IIKK)*VALINT
      FC(IILL)=FC(IILL)-DC(JJKK)*VALINT
      FC(JJKK)=FC(JJKK)-DC(IILL)*VALINT
C
  110 CONTINUE
      GO TO 500
C
  501 CALL SREW(ITAP36)
C
      IF(IPRNT.LE.2) GO TO 306
      WRITE(6,5)
      CALL PRINT(FC,NBATRI,NBASIS,6)
C
C   ADD ONE ELECTRON PART
  306 CONTINUE
      CALL MREAD(H,15)
      IF(IPRNT.LE.2) GO TO 307
      WRITE(6,6)
      CALL PRINT(H,NBATRI,NBASIS,6)
C
  307 CONTINUE
      DO 111 I=1,NTRI
  111 FC(I)=FC(I)+H(I)
      CALL MOCONV(FC,NBATRI,FM,NBATRI,ESO,U,T)
C
      IF(IPRNT.LE.2) GO TO 308
      WRITE(6,7)
      CALL PRINT(FM,NBATRI,NBASIS,6)
C
  308 CONTINUE
      IC1=1
      IC2=IC1+NBFAO
      IC3=IC2+NBFAO
      IC4=IC3+NBFAO
C
C   ROTATE FM MATRIX
      DO 112 I=1,NBASIS
      DO 112 J=1,NBASIS
  112 EE(I,J)=ZERO
C
      NSTR=0
      NEND=0
      DO 115 ITYP=1,NTYPES+1
      NN=NSORB(ITYP)
      IF(NN.EQ.0) GO TO 115
      NSTR=NEND+1
      NEND=NSTR+NN-1
      IF(NN.EQ.1) GO TO 309
      DO 113 I=NSTR,NEND
      DO 113 J=I,NEND
      IJ=IOFF(MAX0(I,J))+MIN0(I,J)
      II=I-NSTR+1
      JJ=J-NSTR+1
      IIJJ=IOFF(MAX0(II,JJ))+MIN0(II,JJ)
      FF(IIJJ)=FM(IJ)
  113 CONTINUE
      CALL ROTATE(EIG,OCC,FF,EE,EZ,CC(IC1),CC(IC2),CC(IC3),CC(IC4),
     1            NSTR-1,NN)
      GO TO 115
  309 EE(NSTR,NSTR)=ONE
  115 CONTINUE
C
      IF(IPRNT.LE.2) GO TO 311
      WRITE(6,8)
      CALL EIGOUT(EE,EIG,OCC,NBFAO,NBFAO,NBASIS,NBASIS,6)
C
C   TRANSFORM EIGENVECTORS FROM SO TO GENERAL OPEN-SHELL BASIS
  311 DO 121 I=1,NBASIS
      DO 121 J=1,NBASIS
      VALU=ZERO
      DO 120 K=1,NBASIS
  120 VALU=VALU+ESO(I,K)*EE(K,J)
      EZ(I,J)=VALU
  121 CONTINUE
      DO 122 I=1,NBASIS
      DO 122 J=1,NBASIS
  122 ESO(I,J)=EZ(I,J)
      IF(IPRNT.LE.2) GO TO 312
      WRITE(6,9)
      CALL EIGOUT(ESO,EIG,OCC,NBFSO,NBASIS,NBASIS,NBASIS,6)
C
C   TRANSFORM EIGENVECTORS FROM GENERAL SO TO GENERAL AO BASIS
  312 DO 124 I=1,NBFAO
      DO 124 J=1,NBASIS
      VALU=ZERO
      DO 123 K=1,NBFSO
  123 VALU=VALU+UAS(I,K)*ESO(K,J)
  124 EAO(I,J)=VALU
      IF(IPRNT.LE.2) GO TO 315
      WRITE(6,10)
      CALL EIGOUT(EAO,EIG,OCC,NBFAO,NBASIS,NBFAO,NBASIS,6)
C
  315 RETURN
      END
