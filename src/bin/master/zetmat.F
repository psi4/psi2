      SUBROUTINE ZETMAT(EIG,OCC,ESO,EAO,U,T,H,ALPA,BETA,DA,DB,ZT,ZETA,
     1                  EPS,EPA,DT,XA,LBLI,BUFI)
      IMPLICIT REAL*8 (A-H,O-Z)
      integer nbasis,nbfso,nbfao,nbatri,ntypes,maxbf4,maxbf2
      DIMENSION EIG(NBASIS),OCC(NBASIS)
      DIMENSION ESO(NBFSO,NBASIS),EAO(NBFAO,NBASIS)
      DIMENSION U(NBFAO,NBFAO),T(NBFAO,NBFAO)
      DIMENSION H(NBATRI),ALPA(NBATRI),BETA(NBATRI)
      DIMENSION DA(NBATRI,NTYPES),DB(NBATRI,NTYPES)
      DIMENSION ZT(NBATRI,NTYPES),ZETA(NBATRI,NTYPES)
      DIMENSION EPS(NBATRI),EPA(NBATRI),DT(NBATRI),XA(NBATRI)
      DIMENSION LBLI(MAXBF4),BUFI(MAXBF2)
      CHARACTER*8 SCFTYP,CITYP,DERTYP
      COMMON/BASIS/NBASIS,NTRI,NSYM,NBFAO,NBFSO,NBATRI
      COMMON/COUPL/ALPC(15),BETC(15),ALPT(15),BETT(15)
      COMMON/ENRGY/ESCF,ENUC
      COMMON/FUNCS/NTYPES,NATOMS,N3N
      COMMON/GRSCF/FOCC(10),NSORB(10)
      COMMON/LIMIT/MAXBAS,MAXBUF,MAXBF2,MAXBF4
      COMMON/SIGNS/IOFF(256),IPRNT
      COMMON/TAPES/ITAP34,ITAP36
      COMMON/TEMPS/I30(400)
      COMMON/TYPES/SCFTYP,CITYP,DERTYP
      COMMON/CI101/IOPEN,IOCC,JOCC,KOCC
      DATA ZERO,HALF,TWO / 0.0D+00 , 0.5D+00 , 2.0D+00 /
    1 FORMAT(//,2X,' GENERAL OPEN-SHELL MO (SO BASIS)'/)
    2 FORMAT(//,2X,' DA MATRIX (SO BASIS), ITYP = ',I5/)
    3 FORMAT(//,2X,' DB MATRIX (SO BASIS), ITYP = ',I5/)
    4 FORMAT(//,2X,' ZETA MATRIX (SO BASIS) ONE ELECTRON PART, ITYP = ',
     1 I5/)
    5 FORMAT(//,2X,' ZETA MATRIX (MO BASIS) ONE ELECTRON PART, ITYP = ',
     1 I5/)
    6 FORMAT(2X,6I5,F15.8)
    7 FORMAT(//,2X,' ZETA MATRIX (SO BASIS), ITYP = ',I5/)
    8 FORMAT(//,2X,' ZETA MATRIX (MO BASIS), ITYP = ',I5/)
    9 FORMAT(//,2X,' LAGRANGIAN MATRIX (MO BASIS)'/)
   10 FORMAT(//,2X,' LAGRANGIAN MATRIX (AO BASIS)'/)
   11 FORMAT(//,2X,' DENSITY MATRIX (AO BASIS), ITYP = ',I5/)
C
      IF(IPRNT.LE.2) GO TO 301
      WRITE(6,1)
      CALL EIGOUT(ESO,EIG,OCC,NBFSO,NBASIS,NBASIS,NBASIS,6)
C
C   CALCULATE SO DENSITY MATRICES
  301 IT=1
      DO 105 ITYP=1,NTYPES
      IF(ITYP.EQ.1) GO TO 302
      IT=IT+NSORB(ITYP-1)
  302 IJ=0
      DO 102 I=1,NBASIS
      DO 102 J=1,I
      IJ=IJ+1
      VALUA=ZERO
      VALUB=ZERO
      DO 101 K=1,JOCC
      ITK=IOFF(IT)+K
      IF(IT.LT.K) ITK=IT+IOFF(K)
      VALUA=VALUA+ALPA(ITK)*ESO(I,K)*ESO(J,K)
      VALUB=VALUB+BETA(ITK)*ESO(I,K)*ESO(J,K)
  101 CONTINUE
      DA(IJ,ITYP)=VALUA
      DB(IJ,ITYP)=VALUB
  102 CONTINUE
      IF(IPRNT.LE.4) GO TO 105
      WRITE(6,2) ITYP
      CALL PRINT(DA(1,ITYP),NBATRI,NBASIS,6)
      WRITE(6,3) ITYP
      CALL PRINT(DB(1,ITYP),NBATRI,NBASIS,6)
  105 CONTINUE
C
C:::::::::::::::::::::::::::::::::::::::
C:::FORM LAGRANGIAN AND ZETA MATRICES:::
C:::::::::::::::::::::::::::::::::::::::
C
C   ONE ELECTRON PART
      CALL MREAD(H,15)
      IT=1
      DO 108 ITYP=1,NTYPES
      IF(ITYP.EQ.1) GO TO 303
      IT=IT+NSORB(ITYP-1)
  303 FAC=OCC(IT)*HALF
      DO 106 I=1,NTRI
      ZT(I,ITYP)=H(I)*FAC
  106 CONTINUE
      IF(IPRNT.LE.3) GO TO 108
      WRITE(6,4) ITYP
      CALL PRINT(ZT(1,ITYP),NBATRI,NBASIS,6)
  108 CONTINUE
C
C   TWO ELECTRON PART
      CALL SREW(ITAP36)
C
  500 CALL SREAD(ITAP36,LBLI,MAXBF4)
      DO 130 I=1,MAXBUF
      IBA=LBLI(I+I-1)
      IBB=LBLI(I+I)
      IF(IBA.EQ.0) GO TO 501
      VALU=BUFI(MAXBUF+I)
      CALL UNPACK(II,JJ,KK,LL,IX,IBA,IBB)
C     IF(IPRNT.LE.5) GO TO 304
C     WRITE(6,6) I,II,JJ,KK,LL,IX,VALU
  304 GO TO (201,202,203,204,205,206,207,208,209,210,211,212,212,212),IX
C
C (II/II)   1=(11/11)
C
  201 IIII=IOFF(II+1)
      DO 111 ITYP=1,NTYPES
      ZT(IIII,ITYP)=ZT(IIII,ITYP)+(DA(IIII,ITYP)+DB(IIII,ITYP))*VALU
  111 CONTINUE
      GO TO 130
C
C  (II/KK)  2=(22/11)
C
  202 IIII=IOFF(II+1)
      KKKK=IOFF(KK+1)
      IIKK=IOFF(II)+KK
      DO 112 ITYP=1,NTYPES
      ZT(IIII,ITYP)=ZT(IIII,ITYP)+DA(KKKK,ITYP)*VALU
      ZT(KKKK,ITYP)=ZT(KKKK,ITYP)+DA(IIII,ITYP)*VALU
      ZT(IIKK,ITYP)=ZT(IIKK,ITYP)+DB(IIKK,ITYP)*VALU
  112 CONTINUE
      GO TO 130
C
C  (II/IL)  3=(22/21)
C
  203 IIII=IOFF(II+1)
      IILL=IOFF(II)+LL
      DO 113 ITYP=1,NTYPES
      ZT(IIII,ITYP)=ZT(IIII,ITYP)+(DA(IILL,ITYP)+DB(IILL,ITYP))*VALU*TWO
      ZT(IILL,ITYP)=ZT(IILL,ITYP)+(DA(IIII,ITYP)+DB(IIII,ITYP))*VALU
  113 CONTINUE
      GO TO 130
C
C  (IJ/JJ)  4=(21/11)
C
  204 IIJJ=IOFF(II)+JJ
      JJJJ=IOFF(JJ+1)
      DO 114 ITYP=1,NTYPES
      ZT(IIJJ,ITYP)=ZT(IIJJ,ITYP)+(DA(JJJJ,ITYP)+DB(JJJJ,ITYP))*VALU
      ZT(JJJJ,ITYP)=ZT(JJJJ,ITYP)+(DA(IIJJ,ITYP)+DB(IIJJ,ITYP))*VALU*TWO
  114 CONTINUE
      GO TO 130
C
C  (IJ/IJ)  5=(21/21)
C
  205 IIJJ=IOFF(II)+JJ
      IIII=IOFF(II+1)
      JJJJ=IOFF(JJ+1)
      DO 115 ITYP=1,NTYPES
      ZT(IIJJ,ITYP)=ZT(IIJJ,ITYP)+(DA(IIJJ,ITYP)*TWO
     1                            +DB(IIJJ,ITYP))*VALU
      ZT(IIII,ITYP)=ZT(IIII,ITYP)+DB(JJJJ,ITYP)*VALU
      ZT(JJJJ,ITYP)=ZT(JJJJ,ITYP)+DB(IIII,ITYP)*VALU
  115 CONTINUE
      GO TO 130
C
C  (II/KL)  6=(33/21)
C
  206 IIII=IOFF(II+1)
      KKLL=IOFF(KK)+LL
      IIKK=IOFF(II)+KK
      IILL=IOFF(II)+LL
      DO 116 ITYP=1,NTYPES
      ZT(IIII,ITYP)=ZT(IIII,ITYP)+DA(KKLL,ITYP)*VALU*TWO
      ZT(KKLL,ITYP)=ZT(KKLL,ITYP)+DA(IIII,ITYP)*VALU
      ZT(IIKK,ITYP)=ZT(IIKK,ITYP)+DB(IILL,ITYP)*VALU
      ZT(IILL,ITYP)=ZT(IILL,ITYP)+DB(IIKK,ITYP)*VALU
  116 CONTINUE
      GO TO 130
C
C  (IJ/KK)  7=(32/11)
C
  207 IIJJ=IOFF(II)+JJ
      KKKK=IOFF(KK+1)
      IIKK=IOFF(II)+KK
      JJKK=IOFF(JJ)+KK
      DO 117 ITYP=1,NTYPES
      ZT(IIJJ,ITYP)=ZT(IIJJ,ITYP)+DA(KKKK,ITYP)*VALU
      ZT(KKKK,ITYP)=ZT(KKKK,ITYP)+DA(IIJJ,ITYP)*VALU*TWO
      ZT(IIKK,ITYP)=ZT(IIKK,ITYP)+DB(JJKK,ITYP)*VALU
      ZT(JJKK,ITYP)=ZT(JJKK,ITYP)+DB(IIKK,ITYP)*VALU
  117 CONTINUE
      GO TO 130
C
C  (IJ/KK)  8=(31/22)
C
  208 IIJJ=IOFF(II)+JJ
      KKKK=IOFF(KK+1)
      IIKK=IOFF(II)+KK
      JJKK=JJ+IOFF(KK)
      DO 118 ITYP=1,NTYPES
      ZT(IIJJ,ITYP)=ZT(IIJJ,ITYP)+DA(KKKK,ITYP)*VALU
      ZT(KKKK,ITYP)=ZT(KKKK,ITYP)+DA(IIJJ,ITYP)*VALU*TWO
      ZT(IIKK,ITYP)=ZT(IIKK,ITYP)+DB(JJKK,ITYP)*VALU
      ZT(JJKK,ITYP)=ZT(JJKK,ITYP)+DB(IIKK,ITYP)*VALU
  118 CONTINUE
      GO TO 130
C
C (IJ/IL)  9=(32/31)
C
  209 IIJJ=IOFF(II)+JJ
      IILL=IOFF(II)+LL
      IIII=IOFF(II+1)
      JJLL=IOFF(JJ)+LL
      DO 119 ITYP=1,NTYPES
      ZT(IIJJ,ITYP)=ZT(IIJJ,ITYP)+(DA(IILL,ITYP)*TWO
     1                            +DB(IILL,ITYP))*VALU
      ZT(IILL,ITYP)=ZT(IILL,ITYP)+(DA(IIJJ,ITYP)*TWO
     1                            +DB(IIJJ,ITYP))*VALU
      ZT(IIII,ITYP)=ZT(IIII,ITYP)+DB(JJLL,ITYP)*VALU*TWO
      ZT(JJLL,ITYP)=ZT(JJLL,ITYP)+DB(IIII,ITYP)*VALU
  119 CONTINUE
      GO TO 130
C
C  (IJ/JL)  10=(32/21)
C
  210 IIJJ=IOFF(II)+JJ
      JJLL=IOFF(JJ)+LL
      IILL=IOFF(II)+LL
      JJJJ=IOFF(JJ+1)
      DO 120 ITYP=1,NTYPES
      ZT(IIJJ,ITYP)=ZT(IIJJ,ITYP)+(DA(JJLL,ITYP)*TWO
     1                            +DB(JJLL,ITYP))*VALU
      ZT(JJLL,ITYP)=ZT(JJLL,ITYP)+(DA(IIJJ,ITYP)*TWO
     1                            +DB(IIJJ,ITYP))*VALU
      ZT(IILL,ITYP)=ZT(IILL,ITYP)+DB(JJJJ,ITYP)*VALU
      ZT(JJJJ,ITYP)=ZT(JJJJ,ITYP)+DB(IILL,ITYP)*VALU*TWO
  120 CONTINUE
      GO TO 130
C
C  (IJ/KJ)  11=(31/21)
C
  211 IIJJ=IOFF(II)+JJ
      KKJJ=IOFF(KK)+JJ
      IIKK=IOFF(II)+KK
      JJJJ=IOFF(JJ+1)
      DO 121 ITYP=1,NTYPES
      ZT(IIJJ,ITYP)=ZT(IIJJ,ITYP)+(DA(KKJJ,ITYP)*TWO
     1                            +DB(KKJJ,ITYP))*VALU
      ZT(KKJJ,ITYP)=ZT(KKJJ,ITYP)+(DA(IIJJ,ITYP)*TWO
     1                            +DB(IIJJ,ITYP))*VALU
      ZT(IIKK,ITYP)=ZT(IIKK,ITYP)+DB(JJJJ,ITYP)*VALU
      ZT(JJJJ,ITYP)=ZT(JJJJ,ITYP)+DB(IIKK,ITYP)*VALU*TWO
  121 CONTINUE
      GO TO 130
C
C  (IJ/KL)  12=(43/21)
C  (IJ/KL)  13=(42/31)
C  (IJ/KL)  14=(41/32)
C
  212 IIJJ=IOFF(II)+JJ
      KKLL=IOFF(KK)+LL
      IIKK=IOFF(II)+KK
      JJLL=IOFF(MAX0(JJ,LL))+MIN0(JJ,LL)
      IILL=IOFF(II)+LL
      JJKK=IOFF(MAX0(JJ,KK))+MIN0(JJ,KK)
      DO 122 ITYP=1,NTYPES
      ZT(IIJJ,ITYP)=ZT(IIJJ,ITYP)+DA(KKLL,ITYP)*VALU*TWO
      ZT(KKLL,ITYP)=ZT(KKLL,ITYP)+DA(IIJJ,ITYP)*VALU*TWO
      ZT(IIKK,ITYP)=ZT(IIKK,ITYP)+DB(JJLL,ITYP)*VALU
      ZT(JJLL,ITYP)=ZT(JJLL,ITYP)+DB(IIKK,ITYP)*VALU
      ZT(IILL,ITYP)=ZT(IILL,ITYP)+DB(JJKK,ITYP)*VALU
      ZT(JJKK,ITYP)=ZT(JJKK,ITYP)+DB(IILL,ITYP)*VALU
  122 CONTINUE
C
  130 CONTINUE
      GO TO 500
C
  501 CALL SREW(ITAP36)
C
C   TRANSFORM ZETA MATRICES FROM SO TO MO BASIS
      DO 165 ITYP=1,NTYPES
      CALL MOCONV(ZT(1,ITYP),NBATRI,ZETA(1,ITYP),NBATRI,ESO,U,T)
      CALL MWRIT(ZETA(1,ITYP),ITYP+26)
      IF(IPRNT.LE.2) GO TO 165
      WRITE(6,7) ITYP
      CALL PRINT(ZT(1,ITYP),NBATRI,NBASIS,6)
      WRITE(6,8) ITYP
      CALL PRINT(ZETA(1,ITYP),NBATRI,NBASIS,6)
  165 CONTINUE
C
C   FORM THE LAGRANGIAN MATRIX IN MO BASIS
      DO 170 I=1,NTRI
  170 EPS(I)=ZERO
C
      NSTR=0
      NEND=0
      DO 173 ITYP=1,NTYPES
      NN=NSORB(ITYP)
      IF(NN.LE.0) GO TO 173
      NSTR=NEND+1
      NEND=NSTR+NN-1
      DO 171 I=NSTR,NEND
      DO 171 J=1,I
      IJ=IOFF(I)+J
      EPS(IJ)=ZETA(IJ,ITYP)
  171 CONTINUE
  173 CONTINUE
      CALL MWRIT(EPS,25)
      IF(IPRNT.LE.2) GO TO 310
      WRITE(6,9)
      CALL PRINT(EPS,NBATRI,NBASIS,6)
C
C   TRANSFORM THE LAGRANGIAN MATRIX FROM MO TO AO BASIS
  310 CONTINUE
      DO 175 I=1,NBASIS
      DO 175 J=1,I
      IJ=IOFF(I)+J
      T(I,J)=EPS(IJ)
      T(J,I)=EPS(IJ)
  175 CONTINUE
      DO 177 I=1,NBASIS
      DO 177 JJ=1,NBFAO
      VALU=ZERO
      DO 176 J=1,NBASIS
      VALU=VALU+EAO(JJ,J)*T(I,J)
  176 CONTINUE
      U(I,JJ)=VALU
  177 CONTINUE
      DO 179 II=1,NBFAO
      DO 179 JJ=1,II
      IIJJ=IOFF(II)+JJ
      VALU=ZERO
      DO 178 I=1,NBASIS
      VALU=VALU+EAO(II,I)*U(I,JJ)
  178 CONTINUE
      EPA(IIJJ)=VALU*TWO
  179 CONTINUE
      CALL MWRIT(EPA,24)
      IF(IPRNT.LE.2) GO TO 315
      WRITE(6,10)
      CALL PRINT(EPA,NBATRI,NBFAO,6)
C
C   FORM DENSITY MATRICES IN AO BASIS
  315 CONTINUE
      DO 181 ITYP=1,NTYPES
      DO 180 I=1,NBATRI
  180 DA(I,ITYP)=ZERO
  181 CONTINUE
C
      NSTR=0
      NEND=0
      DO 185 ITYP=1,NTYPES
      NN=NSORB(ITYP)
      IF(NN.EQ.0) GO TO 185
      NSTR=NEND+1
      NEND=NSTR+NN-1
      IJ=0
      DO 183 I=1,NBFAO
      DO 183 J=1,I
      IJ=IJ+1
      VALU=ZERO
      DO 182 K=NSTR,NEND
  182 VALU=VALU+EAO(I,K)*EAO(J,K)
      DA(IJ,ITYP)=VALU
  183 CONTINUE
  185 CONTINUE
C
      IF(IPRNT.LE.2) GO TO 325
      DO 189 ITYP=1,NTYPES
      WRITE(6,11) ITYP
      CALL PRINT(DA(1,ITYP),NBATRI,NBFAO,6)
  189 CONTINUE
C
  325 CONTINUE
      RETURN
      END
