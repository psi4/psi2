      SUBROUTINE SYMD(FP,FM,NDIM)
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION FP(NDIM,NDIM),FM(NDIM,NDIM)
      DIMENSION D1T(3,150),DNU(3,150)
      COMMON/COM101/NATOM,N3N
      COMMON/COM104/NT,NCASE,ISPOT(150)
      COMMON/COM105/IOFF(256),IPRNT
      COMMON/COM106/PTR(3,3,48)
      COMMON/COM107/ICT(150,48)
      DATA A00,ONE / 0.0D+00 , 1.0D+00 /
      DATA XLIM / 1.0D-4 /
    1 FORMAT(//,2X,' FP MATRIX BEFORE SYMMETRIZATION'/)
    2 FORMAT(//,2X,' FM MATRIX BEFORE SYMMETRIZATION'/)
    3 FORMAT(//,2X,' FP BEFORE SYMMETRIZATION, IABC = ',I5/)
    4 FORMAT(//,2X,' FM BEFORE SYMMETRIZATION, IABC = ',I5/)
    5 FORMAT(//,2X,' GRADIENT AFTER SYMMETRIZATION, IT = ',I5/)
    6 FORMAT(//,2X,' FP MATRIX AFTER SYMMETRIZATION'/)
    7 FORMAT(//,2X,' FM MATRIX AFTER SYMMETRIZATION'/)
C
C*    IF(IPRNT.LE.2) GO TO 201
C*    WRITE(6,1)
C*    CALL MATOUT(FP,NDIM,NDIM,N3N,N3N,6)
C*    WRITE(6,2)
C*    CALL MATOUT(FM,NDIM,NDIM,N3N,N3N,6)
C
  201 CONTINUE
      DO 120 IABC=1,NCASE
      IPOS=ISPOT(IABC)
      IATOM=(IPOS+2)/3
      IXYZ=IPOS-(IATOM-1)*3
      IF(IPOS.GT.N3N) THEN
        IATOM=(IPOS-N3N+2)/3
        IXYZ=IPOS-N3N-(IATOM-1)*3
      END IF
C
C   POSITIVE PERTURBATIONS
      IF(IPOS.GT.N3N) GO TO 301
      DO 102 I=1,NATOM
      IADD=(I-1)*3
      D1T(1,I)=FP(IPOS,IADD+1)
      D1T(2,I)=FP(IPOS,IADD+2)
      D1T(3,I)=FP(IPOS,IADD+3)
  102 CONTINUE
      IF(IPRNT.LE.2) GO TO 202
      WRITE(6,3) IABC
      CALL MATOUT(D1T,3,NDIM,3,NATOM,6)
  202 CONTINUE
      GO TO 302
C   NEGATIVE PERTURBATIONS
  301 CONTINUE
      DO 103 I=1,NATOM
      IADD=(I-1)*3
      D1T(1,I)=FM(IPOS-N3N,IADD+1)
      D1T(2,I)=FM(IPOS-N3N,IADD+2)
      D1T(3,I)=FM(IPOS-N3N,IADD+3)
  103 CONTINUE
      IF(IPRNT.LE.2) GO TO 302
      WRITE(6,4) IABC
      CALL MATOUT(D1T,3,NDIM,3,NATOM,6)
C
  302 CONTINUE
      DO 110 IIT=1,NT
      JATOM=ICT(IATOM,IIT)
      XNU=PTR(IXYZ,IXYZ,IIT)
      IF(XNU.NE.ONE) GO TO 303
      IF(JATOM.NE.IATOM) GO TO 303
      GO TO 110
C
C   SYMMETRIZE GRADIENT VECTOR
  303 CONTINUE
      IT=IIT
      DO 104 IC=1,NATOM
      DEDX=A00
      DEDY=A00
      DEDZ=A00
      ICNU=ICT(IC,IT)
      DEDXP=D1T(1,IC)
      DEDYP=D1T(2,IC)
      DEDZP=D1T(3,IC)
      DEDX=DEDX+DEDXP*PTR(1,1,IT)+DEDYP*PTR(2,1,IT)+DEDZP*PTR(3,1,IT)
      DEDY=DEDY+DEDXP*PTR(1,2,IT)+DEDYP*PTR(2,2,IT)+DEDZP*PTR(3,2,IT)
      DEDZ=DEDZ+DEDXP*PTR(1,3,IT)+DEDYP*PTR(2,3,IT)+DEDZP*PTR(3,3,IT)
      DNU(1,ICNU)=DEDX
      DNU(2,ICNU)=DEDY
      DNU(3,ICNU)=DEDZ
  104 CONTINUE
      IF(IPRNT.LE.2) GO TO 203
      WRITE(6,5) IT
      CALL MATOUT(DNU,3,NDIM,3,NATOM,6)
C
  203 CONTINUE
      DO 105 I=1,3
      XNU=PTR(IXYZ,I,IT)
      IF(DABS(XNU).GT.XLIM) GO TO 304
  105 CONTINUE
  304 CONTINUE
      JXYZ=I
      JPOS=(JATOM-1)*3+JXYZ
      IF(IPOS.LE.N3N.AND.XNU.EQ.-ONE) JPOS=JPOS+N3N
      IF(IPOS.GT.N3N.AND.XNU.EQ.ONE) JPOS=JPOS+N3N
      IF(JPOS.GT.N3N) GO TO 305
C
C   POSITIVE PERTURBATION
      DO 107 I=1,NATOM
      IADD=(I-1)*3
      FP(JPOS,IADD+1)=DNU(1,I)
      FP(JPOS,IADD+2)=DNU(2,I)
      FP(JPOS,IADD+3)=DNU(3,I)
  107 CONTINUE
      GO TO 110
C
C   NEGATIVE PERTURBATION
  305 CONTINUE
      DO 108 I=1,NATOM
      IADD=(I-1)*3
      FM(JPOS-N3N,IADD+1)=DNU(1,I)
      FM(JPOS-N3N,IADD+2)=DNU(2,I)
      FM(JPOS-N3N,IADD+3)=DNU(3,I)
  108 CONTINUE
C
  110 CONTINUE
  120 CONTINUE
C
      WRITE(6,6)
      CALL MATOUT(FP,NDIM,NDIM,N3N,N3N,6)
      WRITE(6,7)
      CALL MATOUT(FM,NDIM,NDIM,N3N,N3N,6)
C
      RETURN
      end
