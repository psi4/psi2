      SUBROUTINE INITLP(int,c,s,ijadd,kadd,ladd,wtw,wtx,wty
     *,                 wab,ss)
      IMPLICIT REAL*8 (A-H,O-Z)
      INTEGER PUWK,ARR,REFWLK,PUWKT,PUWKS,OFFSET,SYMORB,BMAX,ORBFRM
      LOGICAL PAGEIN
      EQUIVALENCE (NLWKI,N1),(M,ITYPE),(N,LVFRM1)
      DIMENSION ITRAK(2,10),ITYPE1(4,4)
      COMMON /LOOPS/NUWK,PUWKT,IUWK,JUWK,ITRACK,IPT1,IPT2
      COMMON /TAPES/ITAP52,ITAPE5,ITAPE6,ITAP58,ITAP54,ITAP03,ITAP04
     *,             ITAPE3,ITAP05,ITAP06,ITAP56
      COMMON /IENT/ IDEN,IEXT,LOPIN,IALL,LOPEX,INTOD
      COMMON /ALL/  VAL1,VAL2,VAL3,ARR,ITR1,ITR2,IA,JA,ITYPE,ISEG
     *,             LVFRM1,NLWKI,NLWKJ,IMAX,IMIN
      COMMON /DIMS/ NBF,NSYM,NORBS,NROWS,NROWS4,NWKS,NWKS2,NLEVS
     *,             NROWOC,NROW4O,NWKSOC,NLEVOC,NORBOC,LEVFRM
     *,             NWKSMX,NLWKMX,NUWKMX,BMAX,NROOTS,ORBFRM
      COMMON /INTS/ NMAX,NMAX2,NGROUP,NBLKOC,NUMIJ,SYMORB,INTSRT
      COMMON /OPS/  IGUESS,IRSTRT,IROOTI,IROOTF
      COMMON /SYMM/ JSM,JFSYM,IFSYM,MAXSYM(8),MINSYM(8),ISMOFF(8)
     #,             NUMSYM(8)
       COMMON /DIAG/ REP,FZCORE,EGUESS,ECI,REFWLK,MXITER,CNVERG,ICNVG
     *,             ITER,SQCDIF,CZERO,NROOT
CTJL  COMMON /DIAG/ REP,FZCORE,EGUESS,ECI,SQCDIF,CNVERG,CZERO
CTJL *,             MXITER,ITER,ICNVG,NROOT,REFWLK
      COMMON /PAGE/ IWORD3,IWORD4,PAGEIN,NOFFI,NOFFJ,NPASS,NWORDL,IWORD6
      DATA ITRAK/1,0,2,0,3,0,1,3,3,2,3,2,3,1,0,0,1,2,2,1/
      DATA ITYPE1/1,4,8,-1,5,2,7,-1,6,9,3,10,11,12,13,17/
      NWKDV2=NWKSMX/2
      INTOD=0
      RETURN
      ENTRY LOOPIN(int,c,s,ijadd,kadd,ladd,wtw,wtx,wty,wab,ss)
CMC   WRITE(6,*) ' ENTRY LOOPIN'
      LOPIN=LOPIN+1
      PUWK=PUWKT
      ITR1=ITRAK(1,ITRACK)
      ITR2=ITRAK(2,ITRACK)
      IF(ITR2.EQ.0) VAL2=0.0D+00
      IF(ITRACK.EQ.6) VAL2=1.0D+00
      IF(ITRACK.EQ.7) VAL2=1.0D+00
      IF (IUWK .NE. JUWK) GOTO 25
      ITYPE=7
      JA=PUWKT+IUWK
      IF(PAGEIN) GO TO 21
      NLWKT=NLWKI
      JA=1
   20 IF(NLWKT.LE.0)RETURN
      NLWKI=MIN(NLWKT,NWKSMX)
      CALL PAGED(c)
      CALL DIAGON(int,c,ijadd,kadd,ladd,wtw,wtx,wty,wab,ss)
      CALL PAGEOU(c)
      NLWKT=NLWKT-NLWKI
      IUWK=IUWK+NLWKI
      GO TO 20
   21 JA=JA-NOFFJ
      CALL DIAGON(int,c,ijadd,kadd,ladd,wtw,wtx,wty,wab,ss)
      RETURN
  25  CONTINUE
      INTOD=INTOD+1
      ITYPE=18
      IF(ITRACK.EQ.8)ITYPE=19
      IA=PUWKT+IUWK
      JA=PUWKT+JUWK
      IF(PAGEIN) GO TO 27
      IA=1
      NLWKT=NLWKI
   26 IF(NLWKT.LE.0)RETURN
      NLWKI=MIN(NLWKT,NWKDV2)
      NLWKJ=NLWKI
      JA=NLWKI+1
      CALL PAGEO(c)
      CALL EXTERN(int,c,s,ijadd,kadd,ladd,wtw,wtx,wty,wab,ss)
      CALL PAGEOU(c)
      IUWK=IUWK+NLWKI
      JUWK=JUWK+NLWKI
      NLWKT=NLWKT-NLWKI
      GO TO 26
   27 JA=JA-NOFFJ
      IA=IA-NOFFI
      CALL EXTERN(int,c,s,ijadd,kadd,ladd,wtw,wtx,wty,wab,ss)
      RETURN
      ENTRY LOOPEX(int,c,s,ijadd,kadd,ladd,wtw,wtx,wty,wab,ss)
CMC   WRITE(6,*) ' ENTRY LOOPEX'
      LOPEX=LOPEX+1
      ITR1=ITRAK(1,ITRACK)
      ITR2=ITRAK(2,ITRACK)
      ITYPE=ITYPE1(IPT2,IPT1)
      IF(ITRACK.EQ.6) VAL2=1.0D+00
      IF(ITRACK.EQ.7) VAL2=1.0D+00
      IF(ITR2.EQ.0) VAL2=0.0D+00
      IF (IUWK .NE. JUWK) GOTO 40
      JA=PUWKT+JUWK-NOFFJ
      CALL DIAGON(int,c,ijadd,kadd,ladd,wtw,wtx,wty,wab,ss)
   35 CONTINUE
C   CALCULATE NON-DIAGONAL PARTIAL EXTERNALS
   40 CONTINUE
      IA=PUWKT+IUWK-NOFFI
      JA=PUWKT+JUWK-NOFFJ
      CALL EXTERN(int,c,s,ijadd,kadd,ladd,wtw,wtx,wty,wab,ss)
CMC   WRITE(6,*) ' JUST BEFORE RETURN BEFORE ALLEXT'
CMC   PRINT,' BEFORE'
CMC   IMIKE=1
CMC   IF (IMIKE.NE.1) GOTO 12345
      RETURN
CMC45 PRINT,' AFTER'
CMC   WRITE(6,*) ' JUST AFTER RETURN BEFORE ALLEXT'
C   CALCULATE ALL-EXTERNAL CONTRIBUTIONS
      ENTRY ALLEXT(int,c,s,ijadd,kadd,ladd,wtw,wtx,wty,wab,ss)
CMC   WRITE(6,*) ' ENTRY ALLEXT'
      IALL=IALL+1
CMC   WRITE(6,9011) ITYPE
CMC11 FORMAT(/' ITYPE =',I5)
      IKEEP=ITYPE
      ITYPE=ITYPE+3
      JA=PUWKT-NOFFI
      IA=JA
      CALL DIAGON(int,c,ijadd,kadd,ladd,wtw,wtx,wty,wab,ss)
CMC   WRITE(6,*) ' JUST RETURNED FROM DIAGONAL'
CMC   WRITE(6,9012) ITYPE,IKEEP
CMC12 FORMAT(/' ITYPE= ',I5,' IKEEP =',I5)
CMC   PRINT,' THIS IS THE TROUBLE SPOT'
   80 ITYPE=IKEEP
CMC   WRITE(6,9011) ITYPE
      ITYPE=ITYPE+13
      IA=PUWKT-NOFFI
      JA=PUWKT-NOFFJ
CMC   WRITE(6,*) ' ABOUT TO CALL FOURX FROM INITLP '
CMC   WRITE(6,9010) ITYPE
CMC10 FORMAT(/' ITYPE = ',I5)
      CALL FOURX(int,c,s,ijadd,kadd,ladd,wtw,wtx,wty,wab,ss)
   90 CONTINUE
      RETURN
      END
