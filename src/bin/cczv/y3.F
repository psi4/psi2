C
C-----------------------------------------------------------------------
C
      SUBROUTINE Y3(II,NHOV,NLVO,NLOV,NTIN,NO,NV,
     .              BUF,IBUF,INTBUF,DOFF,DUM1,DADD,DUM2,
     .              EOFF,NM,EADD,NONO,FOFF,NVNV,FADD,DUM3,
     .              FLOV,ORBSYM,ZLX,NIRRED,TAU,UOFF,VADD,NDIMT2,NTAU,
     .              ITR,NOV,ITV,DUM4,Z1O,Z2O,Z1,Z2,NO2,NTRV,ITAP97,
     .              TOFF,TADD,NT3,IOFF,NTR,ZOFF,FOCK,
     .              ITAP82,ITAP83,T2,NNT2,SORT,NIT,fzo,fzv)
      IMPLICIT INTEGER(A-Z)
      CHARACTER*4 SORT
      REAL*8 II(NTIN), TAU(NTAU),Z1(NO,NV),Z2(NDIMT2),T2(NNT2),
     .       Z1O(NO,NV),Z2O(NDIMT2),FOCK(NTR),BUF(INTBUF),VAL
      DIMENSION EOFF(NM),EADD(NONO),FOFF(NVNV),FADD(NM),
     .          FLOV(NIRRED,4),ORBSYM(NO+NV),ZLX(NV,NV),
     .          UOFF(NO,NO,2),VADD(NV,NV),ITR(NOV),ITV(NV),
     .          TOFF(NO,NO,2,NIRRED),TADD(NV,NV,NIRRED),NT3(NIRRED),
     .          DOFF(NM),DADD(NM),IOFF(NTR),ZOFF(NO,NO,2),IBUF(*),
     .          fzo(*),fzv(*)
C
C     T2 IS NEEDED ONLY IF SORT='YES '.
C
         IF(NIT.EQ.0)THEN
         WRITE(6,*)'ENTERING Y3 SUBROUTINE'
         WRITE(4,*)'ENTERING Y3 SUBROUTINE'
C         CALL TIMIT(4,6)
         ENDIF
C
C
C     FORM Y MATRIX.
C
C     ADD D INTS TO Y MATRIX
C
      CALL RDINTS(63,II,NHOV,BUF,IBUF,INTBUF,NO,NV,
     .            ITR,ITR,DOFF,DADD)
C
      I82=1
      DO 3190 A=1,NV
      if(fzv(a).eq.1)go to 3190
      ASYM=ORBSYM(A+NO)
      DO 3185 I=1,NO
      if(fzo(i).eq.1)go to 3185
      ISYM=ORBSYM(I)
      IASYM=IEOR(ISYM,ASYM)+1
      DIM=NT3(IASYM)
      CALL ZERO(TAU,DIM)
      IA=ITR(A)+I
C
      DO 3180 J=1,NO
      if(fzo(j).eq.1)go to 3180
      JSYM=ORBSYM(J)
      JA=ITR(A)+J
      BSYM=IEOR(IASYM-1,JSYM)+1
      FB=FLOV(BSYM,3)-NO
      LB=FLOV(BSYM,4)-NO
      DO 3175 B=FB,LB
      IB=ITR(B)+I
      JB=ITR(B)+J
      IAJB=DOFF(MAX0(IA,JB))+DADD(MIN0(IA,JB))
      IBJA=DOFF(MAX0(IB,JA))+DADD(MIN0(IB,JA))
      DO 3170 K=1,NO
      if(fzo(k).eq.1)go to 3170
      KSYM=ORBSYM(K)
      FC=FLOV(KSYM+1,3)-NO
      LC=FLOV(KSYM+1,4)-NO
      LC2=LC
      IF(LC2.GT.B)LC2=B
      DO 3165 C=FC,LC2
      JKBC=TOFF(J,K,1,IASYM)+TADD(B,C,IASYM)
      TAU(JKBC)=TAU(JKBC)-(II(IAJB)+II(IAJB)-II(IBJA))*Z1O(K,C)
 3165 CONTINUE
      FC2=FC
      IF(FC2.LT.B)FC2=B
      DO 3166 C=FC2,LC
      KJCB=TOFF(K,J,1,IASYM)+TADD(C,B,IASYM)
      TAU(KJCB)=TAU(KJCB)-(II(IAJB)+II(IAJB)-II(IBJA))*Z1O(K,C)
 3166 CONTINUE
 3170 CONTINUE
 3175 CONTINUE
C
      CSYM=IEOR(IASYM-1,JSYM)+1
      FC=FLOV(CSYM,3)-NO
      LC=FLOV(CSYM,4)-NO
      DO 3775 C=FC,LC
      IC=ITR(C)+I
      JC=ITR(C)+J
      IAJC=DOFF(MAX0(IA,JC))+DADD(MIN0(IA,JC))
      ICJA=DOFF(MAX0(IC,JA))+DADD(MIN0(IC,JA))
      DO 3770 K=1,NO
      if(fzo(k).eq.1)go to 3770
      KSYM=ORBSYM(K)
      FB=FLOV(KSYM+1,3)-NO
      LB=FLOV(KSYM+1,4)-NO
      FB2=FB
      IF(FB.LT.C)FB2=C
      DO 3765 B=FB2,LB
      JKBC=TOFF(J,K,1,IASYM)+TADD(B,C,IASYM)
      TAU(JKBC)=TAU(JKBC)+(II(IAJC)+II(IAJC)-II(ICJA))*Z1O(K,B)
 3765 CONTINUE
      LB2=LB
      IF(LB.GT.C)LB2=C
      DO 3767 B=FB,LB2
      KJCB=TOFF(K,J,1,IASYM)+TADD(C,B,IASYM)
      TAU(KJCB)=TAU(KJCB)+(II(IAJC)+II(IAJC)-II(ICJA))*Z1O(K,B)
 3767 CONTINUE
 3770 CONTINUE
 3775 CONTINUE
 3180 CONTINUE
C
CS    IF(SORT.NE.'YES ')THEN
      DO 3380 J=1,NO
      if(fzo(j).eq.1)go to 3380
      JSYM=ORBSYM(J)
      JA=ITR(A)+J
      DO 3375 B=1,NV
      if(fzv(b).eq.1)go to 3375
      BSYM=ORBSYM(B+NO)
      IBSYM=IEOR(ISYM,BSYM)
      JBSYM=IEOR(JSYM,BSYM)
      IB=ITR(B)+I
      JB=ITR(B)+J
      IAJBS=IEOR(IASYM-1,JBSYM)
      DO 3370 K=1,NO
      if(fzo(k).eq.1)go to 3370
      KSYM=ORBSYM(K)
      KASYM=IEOR(KSYM,ASYM)
      KA=ITR(A)+K
      KB=ITR(B)+K
      CSYM=IEOR(IAJBS,KSYM)
      KCSYM=IEOR(KSYM,CSYM)
      FC=FLOV(CSYM+1,3)-NO
      LC=FLOV(CSYM+1,4)-NO
      LC2=LC
      IF(LC.GT.B)LC2=B
      DO 3365 C=FC,LC2
      IC=ITR(C)+I
      JC=ITR(C)+J
      KC=ITR(C)+K
      VAL=0.0D0
      JBKAS=IEOR(JBSYM,KASYM)
      IF(JBKAS.EQ.0)THEN
      JBKA=DOFF(MAX0(JB,KA))+DADD(MIN0(JB,KA))
      JAKB=DOFF(MAX0(JA,KB))+DADD(MIN0(JA,KB))
      VAL=VAL+(II(JBKA)+II(JBKA)-II(JAKB))*Z1O(I,C)
      ENDIF
      JBKCS=IEOR(JBSYM,KCSYM)
      IF(JBKCS.EQ.0)THEN
      JBKC=DOFF(MAX0(JB,KC))+DADD(MIN0(JB,KC))
      JCKB=DOFF(MAX0(JC,KB))+DADD(MIN0(JC,KB))
      VAL=VAL-(II(JBKC)+II(JBKC)-II(JCKB))*Z1O(I,A)
      ENDIF
      KCIBS=IEOR(KCSYM,IBSYM)
      IF(KCIBS.EQ.0)THEN
      KCIB=DOFF(MAX0(KC,IB))+DADD(MIN0(KC,IB))
      KBIC=DOFF(MAX0(KB,IC))+DADD(MIN0(KB,IC))
      VAL=VAL+(II(KCIB)+II(KCIB)-II(KBIC))*Z1O(J,A)
      ENDIF
      KCIAS=IEOR(KCSYM,IASYM-1)
      IF(KCIAS.EQ.0)THEN
      KCIA=DOFF(MAX0(KC,IA))+DADD(MIN0(KC,IA))
      KAIC=DOFF(MAX0(KA,IC))+DADD(MIN0(KA,IC))
      VAL=VAL-(II(KCIA)+II(KCIA)-II(KAIC))*Z1O(J,B)
      ENDIF
      JKBC=TOFF(J,K,1,IASYM)+TADD(B,C,IASYM)
      TAU(JKBC)=TAU(JKBC)+VAL
 3365 CONTINUE
      FC2=FC
      IF(FC.LT.B)FC2=B
      DO 3366 C=FC2,LC
      IC=ITR(C)+I
      JC=ITR(C)+J
      KC=ITR(C)+K
      VAL=0.0D0
      JBKAS=IEOR(JBSYM,KASYM)
      IF(JBKAS.EQ.0)THEN
      JBKA=DOFF(MAX0(JB,KA))+DADD(MIN0(JB,KA))
      JAKB=DOFF(MAX0(JA,KB))+DADD(MIN0(JA,KB))
      VAL=VAL+(II(JBKA)+II(JBKA)-II(JAKB))*Z1O(I,C)
      ENDIF
      JBKCS=IEOR(JBSYM,KCSYM)
      IF(JBKCS.EQ.0)THEN
      JBKC=DOFF(MAX0(JB,KC))+DADD(MIN0(JB,KC))
      JCKB=DOFF(MAX0(JC,KB))+DADD(MIN0(JC,KB))
      VAL=VAL-(II(JBKC)+II(JBKC)-II(JCKB))*Z1O(I,A)
      ENDIF
      KCIBS=IEOR(KCSYM,IBSYM)
      IF(KCIBS.EQ.0)THEN
      KCIB=DOFF(MAX0(KC,IB))+DADD(MIN0(KC,IB))
      KBIC=DOFF(MAX0(KB,IC))+DADD(MIN0(KB,IC))
      VAL=VAL+(II(KCIB)+II(KCIB)-II(KBIC))*Z1O(J,A)
      ENDIF
      KCIAS=IEOR(KCSYM,IASYM-1)
      IF(KCIAS.EQ.0)THEN
      KCIA=DOFF(MAX0(KC,IA))+DADD(MIN0(KC,IA))
      KAIC=DOFF(MAX0(KA,IC))+DADD(MIN0(KA,IC))
      VAL=VAL-(II(KCIA)+II(KCIA)-II(KAIC))*Z1O(J,B)
      ENDIF
      KJCB=TOFF(K,J,1,IASYM)+TADD(C,B,IASYM)
      TAU(KJCB)=TAU(KJCB)+VAL
 3366 CONTINUE
 3370 CONTINUE
 3375 CONTINUE
 3380 CONTINUE
CS    ENDIF
C
      CALL WWRITW(ITAP82,TAU,INTOWP(DIM),I82,I82)
 3185 CONTINUE
 3190 CONTINUE
         IF(NIT.EQ.0)THEN
         WRITE(6,*)'END D INTS CONTRIBUTION TO Y3 MATRIX'
         WRITE(4,*)'END D INTS CONTRIBUTION TO Y3 MATRIX'
C         CALL TIMIT(4,6)
         ENDIF
C
C     ADD E INTS TO Y MATRIX.
C
      CALL RDINTS(64,II,NLOV,
     .            BUF,IBUF,INTBUF,NO,NV,
     .            ITR,ITR,EOFF,EADD)
      I82=1
      DO 2991 A=1,NV
      if(fzv(a).eq.1)go to 2991
      ASYM=ORBSYM(A+NO)
      DO 2981 I=1,NO
      if(fzo(i).eq.1)go to 2981
      ISYM=ORBSYM(I)
      IASYM=IEOR(ISYM,ASYM)+1
      IA=ITR(A)+I
      DIM=NT3(IASYM)
      CALL WREADW(ITAP82,TAU,INTOWP(DIM),I82,JUNK)
      DO 2971 J=1,NO
      if(fzo(j).eq.1)go to 2971
      JA=ITR(A)+J
      JSYM=ORBSYM(J)
      IJSYM=IEOR(ISYM,JSYM)
      JASYM=IEOR(JSYM,ASYM)
      DO 2961 B=1,NV
      if(fzv(b).eq.1)go to 2961
      JB=ITR(B)+J
      BSYM=ORBSYM(B+NO)
      ABSYM=IEOR(ASYM,BSYM)
      JBSYM=IEOR(JSYM,BSYM)
      ZLAB=ZLX(A,B)
      AB=IOFF(MAX0(A,B))+MIN0(A,B)
      BA=AB
C
      DO 2951 C=1,B
      if(fzv(c).eq.1)go to 2951
      CSYM=ORBSYM(C+NO)
      BCSYM=IEOR(BSYM,CSYM)
      ABCSYM=IEOR(ABSYM,CSYM)
      KSYM=IEOR(ABCSYM,IJSYM)
      KCSYM=IEOR(KSYM,CSYM)
      ICSYM=IEOR(ISYM,CSYM)
      KBSYM=IEOR(KSYM,BSYM)
      FK=FLOV(KSYM+1,1)
      LK=FLOV(KSYM+1,2)
      ZLAC=ZLX(A,C)
      ZLBC=ZLX(B,C)
      AC=IOFF(MAX0(A,C))+MIN0(A,C)
      CA=AC
      BC=IOFF(MAX0(B,C))+MIN0(B,C)
      CB=BC
      IC=ITR(C)+I
      JC=ITR(C)+J
      DO 2941 K=FK,LK
      KC=ITR(C)+K
      KA=ITR(A)+K
      KB=ITR(B)+K
      JKBC=TOFF(J,K,1,IASYM)+TADD(B,C,IASYM)
C
      LSYM=IEOR(KCSYM,ISYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3042 L=FL,LL
      LJAB=UOFF(L,J,ZLAB)+VADD(A,B)
      IL=ITR(MAX0(I,L))+MIN0(I,L)
      KL=ITR(MAX0(K,L))+MIN0(K,L)
      ILKC=EOFF(KC)+EADD(IL)
      ICKL=EOFF(IC)+EADD(KL)
      TAU(JKBC)=TAU(JKBC)+(II(ILKC)+II(ILKC)-II(ICKL))*Z2O(LJAB)
 3042 CONTINUE
C
      LSYM=IEOR(KBSYM,ISYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3043 L=FL,LL
      LJAC=UOFF(L,J,ZLAC)+VADD(A,C)
      IL=ITR(MAX0(I,L))+MIN0(I,L)
      ILKB=EOFF(KB)+EADD(IL)
      TAU(JKBC)=TAU(JKBC)-II(ILKB)*Z2O(LJAC)
 3043 CONTINUE
C
CS    IF(SORT.NE.'YES ')THEN
      LSYM=IEOR(IASYM-1,JSYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3142 L=FL,LL
      LKBC=UOFF(L,K,ZLBC)+VADD(B,C)
      IL=ITR(MAX0(I,L))+MIN0(I,L)
      JL=ITR(MAX0(J,L))+MIN0(J,L)
      JLIA=EOFF(IA)+EADD(JL)
      JAIL=EOFF(JA)+EADD(IL)
      TAU(JKBC)=TAU(JKBC)+(II(JLIA)+II(JLIA)-II(JAIL))*Z2O(LKBC)
 3142 CONTINUE
C
      LSYM=IEOR(ICSYM,JSYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3143 L=FL,LL
      LKBA=UOFF(K,L,ZLAB)+VADD(A,B)
      JL=ITR(MAX0(J,L))+MIN0(J,L)
      JLIC=EOFF(IC)+EADD(JL)
      TAU(JKBC)=TAU(JKBC)-II(JLIC)*Z2O(LKBA)
 3143 CONTINUE
C
      LSYM=IEOR(JBSYM,KSYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3242 L=FL,LL
      LICA=UOFF(I,L,ZLAC)+VADD(A,C)
      JL=ITR(MAX0(J,L))+MIN0(J,L)
      KL=ITR(MAX0(K,L))+MIN0(K,L)
      KLJB=EOFF(JB)+EADD(KL)
      KBJL=EOFF(KB)+EADD(JL)
      TAU(JKBC)=TAU(JKBC)+(II(KLJB)+II(KLJB)-II(KBJL))*Z2O(LICA)
 3242 CONTINUE
C
      LSYM=IEOR(JASYM,KSYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3243 L=FL,LL
      LICB=UOFF(I,L,ZLBC)+VADD(B,C)
      KL=ITR(MAX0(K,L))+MIN0(K,L)
      KLJA=EOFF(JA)+EADD(KL)
      TAU(JKBC)=TAU(JKBC)-II(KLJA)*Z2O(LICB)
 3243 CONTINUE
CS    ENDIF
C
 2941 CONTINUE
 2951 CONTINUE
C
      DO 2952 C=B,NV
      if(fzv(c).eq.1)go to 2952
      CSYM=ORBSYM(C+NO)
      BCSYM=IEOR(BSYM,CSYM)
      ABCSYM=IEOR(ABSYM,CSYM)
      KSYM=IEOR(ABCSYM,IJSYM)
      KCSYM=IEOR(KSYM,CSYM)
      ICSYM=IEOR(ISYM,CSYM)
      KBSYM=IEOR(KSYM,BSYM)
      FK=FLOV(KSYM+1,1)
      LK=FLOV(KSYM+1,2)
      ZLAC=ZLX(A,C)
      ZLBC=ZLX(B,C)
      AC=IOFF(MAX0(A,C))+MIN0(A,C)
      CA=AC
      BC=IOFF(MAX0(B,C))+MIN0(B,C)
      CB=BC
      IC=ITR(C)+I
      JC=ITR(C)+J
      DO 2942 K=FK,LK
      KC=ITR(C)+K
      KA=ITR(A)+K
      KB=ITR(B)+K
      KJCB=TOFF(K,J,1,IASYM)+TADD(C,B,IASYM)
C
      LSYM=IEOR(KCSYM,ISYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3044 L=FL,LL
      LJAB=UOFF(L,J,ZLAB)+VADD(A,B)
      IL=ITR(MAX0(I,L))+MIN0(I,L)
      KL=ITR(MAX0(K,L))+MIN0(K,L)
      ILKC=EOFF(KC)+EADD(IL)
      ICKL=EOFF(IC)+EADD(KL)
      TAU(KJCB)=TAU(KJCB)+(II(ILKC)+II(ILKC)-II(ICKL))*Z2O(LJAB)
 3044 CONTINUE
C
      LSYM=IEOR(KBSYM,ISYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3045 L=FL,LL
      LJAC=UOFF(L,J,ZLAC)+VADD(A,C)
      IL=ITR(MAX0(I,L))+MIN0(I,L)
      ILKB=EOFF(KB)+EADD(IL)
      TAU(KJCB)=TAU(KJCB)-II(ILKB)*Z2O(LJAC)
 3045 CONTINUE
C
CS    IF(SORT.NE.'YES ')THEN
      LSYM=IEOR(IASYM-1,JSYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3144 L=FL,LL
      LKBC=UOFF(L,K,ZLBC)+VADD(B,C)
      IL=ITR(MAX0(I,L))+MIN0(I,L)
      JL=ITR(MAX0(J,L))+MIN0(J,L)
      JLIA=EOFF(IA)+EADD(JL)
      JAIL=EOFF(JA)+EADD(IL)
      TAU(KJCB)=TAU(KJCB)+(II(JLIA)+II(JLIA)-II(JAIL))*Z2O(LKBC)
 3144 CONTINUE
C
      LSYM=IEOR(ICSYM,JSYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3145 L=FL,LL
      LKBA=UOFF(K,L,ZLAB)+VADD(A,B)
      JL=ITR(MAX0(J,L))+MIN0(J,L)
      JLIC=EOFF(IC)+EADD(JL)
      TAU(KJCB)=TAU(KJCB)-II(JLIC)*Z2O(LKBA)
 3145 CONTINUE
C
      LSYM=IEOR(JBSYM,KSYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3244 L=FL,LL
      LICA=UOFF(I,L,ZLAC)+VADD(A,C)
      JL=ITR(MAX0(J,L))+MIN0(J,L)
      KL=ITR(MAX0(K,L))+MIN0(K,L)
      KLJB=EOFF(JB)+EADD(KL)
      KBJL=EOFF(KB)+EADD(JL)
      TAU(KJCB)=TAU(KJCB)+(II(KLJB)+II(KLJB)-II(KBJL))*Z2O(LICA)
 3244 CONTINUE
C
      LSYM=IEOR(JASYM,KSYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3245 L=FL,LL
      LICB=UOFF(I,L,ZLBC)+VADD(B,C)
      KL=ITR(MAX0(K,L))+MIN0(K,L)
      KLJA=EOFF(JA)+EADD(KL)
      TAU(KJCB)=TAU(KJCB)-II(KLJA)*Z2O(LICB)
 3245 CONTINUE
CS    ENDIF
C
 2942 CONTINUE
 2952 CONTINUE
C
 2961 CONTINUE
 2971 CONTINUE
      CALL WWRITW(ITAP82,TAU,INTOWP(DIM),I82,I82)
 2981 CONTINUE
 2991 CONTINUE
         IF(NIT.EQ.0)THEN
         WRITE(6,*)'END E INTS CONTRIBUTION TO Y3 MATRIX'
         WRITE(4,*)'END E INTS CONTRIBUTION TO Y3 MATRIX'
C         CALL TIMIT(4,6)
         ENDIF
C
C     ADD F INTS TO Y MATRIX.
C
      CALL RDINTS(65,II,NLVO,BUF,IBUF,INTBUF,NO,NV,
     .            ITV,ITR,FOFF,FADD)
      I82=1
      DO 2990 A=1,NV
      if(fzv(a).eq.1)go to 2990
      ASYM=ORBSYM(A+NO)
      DO 2980 I=1,NO
      if(fzo(i).eq.1)go to 2980
      ISYM=ORBSYM(I)
      IASYM=IEOR(ISYM,ASYM)+1
      IA=ITR(A)+I
      DIM=NT3(IASYM)
      CALL WREADW(ITAP82,TAU,INTOWP(DIM),I82,JUNK)
      DO 2970 J=1,NO
      if(fzo(j).eq.1)go to 2970
      JA=ITR(A)+J
      JSYM=ORBSYM(J)
      IJSYM=IEOR(ISYM,JSYM)
      JASYM=IEOR(JSYM,ASYM)
      DO 2960 B=1,NV
      if(fzv(b).eq.1)go to 2960
      IB=ITR(B)+I
      JB=ITR(B)+J
      BSYM=ORBSYM(B+NO)
      JBSYM=IEOR(JSYM,BSYM)
      ABSYM=IEOR(ASYM,BSYM)
C
      DO 2955 C=1,B
      if(fzv(c).eq.1)go to 2955
      JC=ITR(C)+J
      IC=ITR(C)+I
      CSYM=ORBSYM(C+NO)
      ABCSYM=IEOR(ABSYM,CSYM)
      KSYM=IEOR(ABCSYM,IJSYM)
      KCSYM=IEOR(KSYM,CSYM)
      ICSYM=IEOR(ISYM,CSYM)
      KBSYM=IEOR(KSYM,BSYM)
      FK=FLOV(KSYM+1,1)
      LK=FLOV(KSYM+1,2)
      DO 2945 K=FK,LK
      KC=ITR(C)+K
      KA=ITR(A)+K
      KB=ITR(B)+K
      JKBC=TOFF(J,K,1,IASYM)+TADD(B,C,IASYM)
C
      DSYM=IEOR(KCSYM,ASYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3032 D=FD,LD
      DB=IOFF(MAX0(D,B))+MIN0(D,B)
      ZLDB=ZLX(D,B)
      IJDB=UOFF(I,J,ZLDB)+VADD(D,B)
      DA=ITV(MAX0(D,A))+MIN0(D,A)
      DC=ITV(MAX0(D,C))+MIN0(D,C)
      DAKC=FOFF(DA)+FADD(KC)
      DCKA=FOFF(DC)+FADD(KA)
      TAU(JKBC)=TAU(JKBC)-(II(DAKC)+II(DAKC)-II(DCKA))*Z2O(IJDB)
 3032 CONTINUE
C
      DSYM=IEOR(KBSYM,ASYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3033 D=FD,LD
      DC=IOFF(MAX0(D,C))+MIN0(D,C)
      ZLDC=ZLX(D,C)
      IJDC=UOFF(I,J,ZLDC)+VADD(D,C)
      AD=ITV(MAX0(D,A))+MIN0(D,A)
      ADKB=FOFF(AD)+FADD(KB)
      TAU(JKBC)=TAU(JKBC)+II(ADKB)*Z2O(IJDC)
 3033 CONTINUE
C
CS    IF(SORT.NE.'YES ')THEN
      DSYM=IEOR(IASYM-1,BSYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3132 D=FD,LD
      DC=IOFF(MAX0(D,C))+MIN0(D,C)
      ZLDC=ZLX(D,C)
      JKDC=UOFF(J,K,ZLDC)+VADD(D,C)
      DA=ITV(MAX0(D,A))+MIN0(D,A)
      DB=ITV(MAX0(D,B))+MIN0(D,B)
      DBIA=FOFF(DB)+FADD(IA)
      DAIB=FOFF(DA)+FADD(IB)
      TAU(JKBC)=TAU(JKBC)-(II(DBIA)+II(DBIA)-II(DAIB))*Z2O(JKDC)
 3132 CONTINUE
C
      DSYM=IEOR(ICSYM,BSYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3133 D=FD,LD
      DA=IOFF(MAX0(D,A))+MIN0(D,A)
      ZLDA=ZLX(D,A)
      JKDA=UOFF(J,K,ZLDA)+VADD(D,A)
      BD=ITV(MAX0(D,B))+MIN0(D,B)
      BDIC=FOFF(BD)+FADD(IC)
      TAU(JKBC)=TAU(JKBC)+II(BDIC)*Z2O(JKDA)
 3133 CONTINUE
C
      DSYM=IEOR(JBSYM,CSYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3232 D=FD,LD
      DA=IOFF(MAX0(D,A))+MIN0(D,A)
      ZLDA=ZLX(D,A)
      KIDA=UOFF(K,I,ZLDA)+VADD(D,A)
      DB=ITV(MAX0(D,B))+MIN0(D,B)
      DC=ITV(MAX0(D,C))+MIN0(D,C)
      DCJB=FOFF(DC)+FADD(JB)
      DBJC=FOFF(DB)+FADD(JC)
      TAU(JKBC)=TAU(JKBC)-(II(DCJB)+II(DCJB)-II(DBJC))*Z2O(KIDA)
 3232 CONTINUE
C
      DSYM=IEOR(JASYM,CSYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3233 D=FD,LD
      DB=IOFF(MAX0(D,B))+MIN0(D,B)
      ZLDB=ZLX(D,B)
      KIDB=UOFF(K,I,ZLDB)+VADD(D,B)
      CD=ITV(MAX0(D,C))+MIN0(D,C)
      JACD=FOFF(CD)+FADD(JA)
      TAU(JKBC)=TAU(JKBC)+II(JACD)*Z2O(KIDB)
 3233 CONTINUE
CS    ENDIF
 2945 CONTINUE
 2955 CONTINUE
C
      DO 2956 C=B,NV
      if(fzv(c).eq.1)go to 2956
      JC=ITR(C)+J
      IC=ITR(C)+I
      CSYM=ORBSYM(C+NO)
      ABCSYM=IEOR(ABSYM,CSYM)
      KSYM=IEOR(ABCSYM,IJSYM)
      KCSYM=IEOR(KSYM,CSYM)
      ICSYM=IEOR(ISYM,CSYM)
      KBSYM=IEOR(KSYM,BSYM)
      FK=FLOV(KSYM+1,1)
      LK=FLOV(KSYM+1,2)
      DO 2946 K=FK,LK
      KC=ITR(C)+K
      KA=ITR(A)+K
      KB=ITR(B)+K
      KJCB=TOFF(K,J,1,IASYM)+TADD(C,B,IASYM)
C
      DSYM=IEOR(KCSYM,ASYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3034 D=FD,LD
      DB=IOFF(MAX0(D,B))+MIN0(D,B)
      ZLDB=ZLX(D,B)
      IJDB=UOFF(I,J,ZLDB)+VADD(D,B)
      DA=ITV(MAX0(D,A))+MIN0(D,A)
      DC=ITV(MAX0(D,C))+MIN0(D,C)
      DAKC=FOFF(DA)+FADD(KC)
      DCKA=FOFF(DC)+FADD(KA)
      TAU(KJCB)=TAU(KJCB)-(II(DAKC)+II(DAKC)-II(DCKA))*Z2O(IJDB)
 3034 CONTINUE
C
      DSYM=IEOR(KBSYM,ASYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3035 D=FD,LD
      DC=IOFF(MAX0(D,C))+MIN0(D,C)
      ZLDC=ZLX(D,C)
      IJDC=UOFF(I,J,ZLDC)+VADD(D,C)
      AD=ITV(MAX0(D,A))+MIN0(D,A)
      ADKB=FOFF(AD)+FADD(KB)
      TAU(KJCB)=TAU(KJCB)+II(ADKB)*Z2O(IJDC)
 3035 CONTINUE
C
CS    IF(SORT.NE.'YES ')THEN
      DSYM=IEOR(IASYM-1,BSYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3134 D=FD,LD
      DC=IOFF(MAX0(D,C))+MIN0(D,C)
      ZLDC=ZLX(D,C)
      JKDC=UOFF(J,K,ZLDC)+VADD(D,C)
      DA=ITV(MAX0(D,A))+MIN0(D,A)
      DB=ITV(MAX0(D,B))+MIN0(D,B)
      DBIA=FOFF(DB)+FADD(IA)
      DAIB=FOFF(DA)+FADD(IB)
      TAU(KJCB)=TAU(KJCB)-(II(DBIA)+II(DBIA)-II(DAIB))*Z2O(JKDC)
 3134 CONTINUE
C
      DSYM=IEOR(ICSYM,BSYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3135 D=FD,LD
      DA=IOFF(MAX0(D,A))+MIN0(D,A)
      ZLDA=ZLX(D,A)
      JKDA=UOFF(J,K,ZLDA)+VADD(D,A)
      BD=ITV(MAX0(D,B))+MIN0(D,B)
      BDIC=FOFF(BD)+FADD(IC)
      TAU(KJCB)=TAU(KJCB)+II(BDIC)*Z2O(JKDA)
 3135 CONTINUE
C
      DSYM=IEOR(JBSYM,CSYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3234 D=FD,LD
      DA=IOFF(MAX0(D,A))+MIN0(D,A)
      ZLDA=ZLX(D,A)
      KIDA=UOFF(K,I,ZLDA)+VADD(D,A)
      DB=ITV(MAX0(D,B))+MIN0(D,B)
      DC=ITV(MAX0(D,C))+MIN0(D,C)
      DCJB=FOFF(DC)+FADD(JB)
      DBJC=FOFF(DB)+FADD(JC)
      TAU(KJCB)=TAU(KJCB)-(II(DCJB)+II(DCJB)-II(DBJC))*Z2O(KIDA)
 3234 CONTINUE
C
      DSYM=IEOR(JASYM,CSYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3235 D=FD,LD
      DB=IOFF(MAX0(D,B))+MIN0(D,B)
      ZLDB=ZLX(D,B)
      KIDB=UOFF(K,I,ZLDB)+VADD(D,B)
      CD=ITV(MAX0(D,C))+MIN0(D,C)
      JACD=FOFF(CD)+FADD(JA)
      TAU(KJCB)=TAU(KJCB)+II(JACD)*Z2O(KIDB)
 3235 CONTINUE
CS    ENDIF
 2946 CONTINUE
 2956 CONTINUE
C
 2960 CONTINUE
 2970 CONTINUE
      CALL WWRITW(ITAP82,TAU,INTOWP(DIM),I82,I82)
 2980 CONTINUE
 2990 CONTINUE
         IF(NIT.EQ.0)THEN
         WRITE(6,*)'END F INTS CONTRIBUTION TO Y3 MATRIX'
         WRITE(4,*)'END F INTS CONTRIBUTION TO Y3 MATRIX'
C         CALL TIMIT(4,6)
         ENDIF
C
C     DIVIDE BY MO ENERGIES
C
      I82=1
      DO 4490 A=1,NV
      if(fzv(a).eq.1)go to 4490
      ASYM=ORBSYM(A+NO)
      DO 4485 I=1,NO
      if(fzo(i).eq.1)go to 4485
      ISYM=ORBSYM(I)
      III=IOFF(I)+I
      IASYM=IEOR(ISYM,ASYM)+1
      DIM=NT3(IASYM)
      CALL WREADW(ITAP82,TAU,INTOWP(DIM),I82,JUNK)
      AA=IOFF(A+NO)+A+NO
      DO 4480 J=1,NO
      if(fzo(j).eq.1)go to 4480
      JJ=IOFF(J)+J
      JSYM=ORBSYM(J)
      IAJSYM=IEOR(IASYM-1,JSYM)
      DO 4475 B=1,NV
      if(fzv(b).eq.1)go to 4475
      BSYM=ORBSYM(B+NO)
      BB=IOFF(B+NO)+B+NO
      DO 4470 K=1,NO
      if(fzo(k).eq.1)go to 4470
      KK=IOFF(K)+K
      KSYM=ORBSYM(K)
      KBSYM=IEOR(KSYM,BSYM)
      CSYM=IEOR(IAJSYM,KBSYM)+1
      FC=FLOV(CSYM,3)-NO
      LC=FLOV(CSYM,4)-NO
      LC2=LC
      IF(LC.GT.B)LC2=B
      DO 4465 C=FC,LC2
      CC=IOFF(C+NO)+C+NO
      VAL=FOCK(III)+FOCK(JJ)+FOCK(KK)-FOCK(AA)-FOCK(BB)-FOCK(CC)
      JKBC=TOFF(J,K,1,IASYM)+TADD(B,C,IASYM)
      TAU(JKBC)=TAU(JKBC)/VAL
 4465 CONTINUE
 4470 CONTINUE
 4475 CONTINUE
 4480 CONTINUE
      CALL WWRITW(ITAP82,TAU,INTOWP(DIM),I82,I82)
 4485 CONTINUE
 4490 CONTINUE
         IF(NIT.EQ.0)THEN
         WRITE(6,*)'ENDING MO ENERGY DIVISION'
         WRITE(4,*)'ENDING MO ENERGY DIVISION'
C         CALL TIMIT(4,6)
         ENDIF
C
C     FORM Y TILDE
C
      IF(SORT.EQ.'YES ')
     .CALL SORTT(TAU,T2,NTAU,ORBSYM,NO,NV,FLOV,NIRRED,NT3,TOFF,TADD,
     .           ITAP82,ITAP97,ZLX)
C
C
C     ADD CCSDT TERMS TO Z2 EQUATION. F INTS.
C
      CALL RDINTS(65,II,NLVO,
     .            BUF,IBUF,INTBUF,NO,NV,
     .            ITV,ITR,FOFF,FADD)
      I82=1
      DO 6290 A=1,NV
      if(fzv(a).eq.1)go to 6290
      ASYM=ORBSYM(A+NO)
      DO 6285 I=1,NO
      if(fzo(i).eq.1)go to 6285
      ISYM=ORBSYM(I)
      IASYM=IEOR(ISYM,ASYM)+1
      DIM=NT3(IASYM)
      CALL WREADW (ITAP82,TAU,INTOWP(DIM),I82,I82)
      DO 6280 B=1,NV
      if(fzv(b).eq.1)go to 6280
      BSYM=ORBSYM(B+NO)
      BESYM=IEOR(IASYM-1,BSYM)
      FBE=FLOV(BESYM+1,3)-NO
      LBE=FLOV(BESYM+1,4)-NO
      DO 6275 BE=FBE,LBE
      IA=ITR(A)+I
      BEB=ITV(MAX0(BE,B))+MIN0(BE,B)
      IABEB=FOFF(BEB)+FADD(IA)
      DO 6270 U=1,NO
      if(fzo(u).eq.1)go to 6270
      USYM=ORBSYM(U)
      DO 6265 V=1,NO
      if(fzo(v).eq.1)go to 6265
      VSYM=ORBSYM(V)
      UVSYM=IEOR(USYM,VSYM)
      GASYM=IEOR(UVSYM,BESYM)+1
      FGA=FLOV(GASYM,3)-NO
      LGA=FLOV(GASYM,4)-NO
C
      LGA2=LGA
      IF(LGA.GT.BE)LGA2=BE
      DO 6230 GA=FGA,LGA2
      UVBEGA=UOFF(U,V,1)+VADD(BE,GA)
      ZLBGA=ZLX(B,GA)
      UVBGA=TOFF(U,V,ZLBGA,IASYM)+TADD(B,GA,IASYM)
      Z2(UVBEGA)=Z2(UVBEGA)+TAU(UVBGA) *II(IABEB)
 6230 CONTINUE
C
      FGA2=FGA
      IF(FGA.LT.BE)FGA2=BE
      DO 6231 GA=FGA2,LGA
      VUGABE=UOFF(V,U,1)+VADD(GA,BE)
      ZLBGA=ZLX(B,GA)
      UVBGA=TOFF(U,V,ZLBGA,IASYM)+TADD(B,GA,IASYM)
      Z2(VUGABE)=Z2(VUGABE)+TAU(UVBGA)*II(IABEB)
 6231 CONTINUE
C
 6265 CONTINUE
 6270 CONTINUE
 6275 CONTINUE
 6280 CONTINUE
 6285 CONTINUE
 6290 CONTINUE
         IF(NIT.EQ.0)THEN
         WRITE(6,*)'END F INTS CONTRIBUTION TO Z2'
         WRITE(4,*)'END F INTS CONTRIBUTION TO Z2'
C         CALL TIMIT(4,6)
         ENDIF
C
C
C     ADD CCSDT TERMS TO Z2 EQUATION. E INTS.
C
      CALL RDINTS(64,II,NLOV,
     .            BUF,IBUF,INTBUF,NO,NV,
     .            ITR,ITR,EOFF,EADD)
      I82=1
      DO 3290 A=1,NV
      if(fzv(a).eq.1)go to 3290
      ASYM=ORBSYM(A+NO)
      DO 3285 I=1,NO
      if(fzo(i).eq.1)go to 3285
      ISYM=ORBSYM(I)
      IASYM=IEOR(ISYM,ASYM)+1
      DIM=NT3(IASYM)
      CALL WREADW (ITAP82,TAU,INTOWP(DIM),I82,I82)
      DO 3280 V=1,NO
      if(fzo(v).eq.1)go to 3280
      VSYM=ORBSYM(V)
      JSYM=IEOR(IASYM-1,VSYM)+1
      FJ=FLOV(JSYM,1)
      LJ=FLOV(JSYM,2)
      DO 3275 J=FJ,LJ
      VJ=ITR(MAX0(V,J))+MIN0(V,J)
      IA=ITR(A)+I
      IAVJ=EOFF(IA)+EADD(VJ)
      DO 3270 U=1,NO
      if(fzo(u).eq.1)go to 3270
      USYM=ORBSYM(U)
      UVSYM=IEOR(USYM,VSYM)
      DO 3265 BE=1,NV
      if(fzv(be).eq.1)go to 3265
      BESYM=ORBSYM(BE+NO)
      GASYM=IEOR(UVSYM,BESYM)+1
      FGA=FLOV(GASYM,3)-NO
      LGA=FLOV(GASYM,4)-NO
C
      LGA2=LGA
      IF(LGA.GT.BE)LGA2=BE
      DO 3260 GA=FGA,LGA2
      UVBEGA=UOFF(U,V,1)+VADD(BE,GA)
      JUGABE=TOFF(J,U,2,IASYM)+TADD(GA,BE,IASYM)
      Z2(UVBEGA)=Z2(UVBEGA)-TAU(JUGABE)*II(IAVJ)
 3260 CONTINUE
C
      FGA2=FGA
      IF(FGA.LT.BE)FGA2=BE
      DO 3261 GA=FGA2,LGA
      VUGABE=UOFF(V,U,1)+VADD(GA,BE)
      JUGABE=TOFF(J,U,1,IASYM)+TADD(GA,BE,IASYM)
      Z2(VUGABE)=Z2(VUGABE)-TAU(JUGABE)*II(IAVJ)
 3261 CONTINUE
C
 3265 CONTINUE
 3270 CONTINUE
 3275 CONTINUE
 3280 CONTINUE
 3285 CONTINUE
 3290 CONTINUE
         IF(NIT.EQ.0)THEN
         WRITE(6,*)'END E INTS CONTRIBUTION TO Z2'
         WRITE(4,*)'END E INTS CONTRIBUTION TO Z2'
C
         ENDIF
C
      RETURN
      END
