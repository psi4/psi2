      SUBROUTINE DAB(DS,DST,DF,DFT,Q4)
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION DS(NBATRI,NTYPEP),DST(NBATRI)
      DIMENSION DF(NBATRI,3,NTYPEP),DFT(NBATRI,3),DFAC(10)
      COMMON/ABDEN/ABDENS(1296,10)
      COMMON/BASIS/NBASIS,NBFAO,NBATRI,NBATR2
      COMMON/CALCS/ISTYPE,ICTYPE
      COMMON/COUPL/ALP(5,5),BET(5,5)
      COMMON/FUNCS/NTYPES,NTYPEP,NTREAD,NATOM,N3N,NATRI,NSYM
      COMMON/MAXDS/NMAXD
      COMMON/PARA4/MMIJ,MMKL,ISAME(100)
      COMMON/POSIX/IPOS(100),JPOS(100),KPOS(100),LPOS(100),IMUL(100)
      COMMON/SIGNS/IOFF(256),IPRNT
      COMMON/TCSCF/SOCC1,SOCC2,SOCC12
      DATA ZERO,HALF,ONE,TWO,FOUR / 0.0D+00 , 0.5D+00 , 1.0D+00 ,
     *                              2.0D+00 , 4.0D+00 /
      DATA DLIM / 1.0D-10 /
C
      DMAX=ZERO
C
      NN=0
      DO 110 II=1,MMIJ
      IT=IPOS(II)
      JT=JPOS(II)
      NFAC=IMUL(II)
      DO 109 JJ=1,MMKL
      KT=KPOS(JJ)
      LT=LPOS(JJ)
      NN=NN+1
      IJT=IOFF(MAX0(IT,JT))+MIN0(IT,JT)
      KLT=IOFF(MAX0(KT,LT))+MIN0(KT,LT)
      IF(IJT.LT.KLT) GO TO 301
      I=MAX0(IT,JT)
      J=MIN0(IT,JT)
      K=MAX0(KT,LT)
      L=MIN0(KT,LT)
      GO TO 302
  301 CONTINUE
      I=MAX0(KT,LT)
      J=MIN0(KT,LT)
      K=MAX0(IT,JT)
      L=MIN0(IT,JT)
C
  302 CONTINUE
      MIJ=IOFF(MAX0(I,J))+MIN0(I,J)
      MKL=IOFF(MAX0(K,L))+MIN0(K,L)
      MIK=IOFF(MAX0(I,K))+MIN0(I,K)
      MJL=IOFF(MAX0(J,L))+MIN0(J,L)
      MIL=IOFF(MAX0(I,L))+MIN0(I,L)
      MJK=IOFF(MAX0(J,K))+MIN0(J,K)
C
      FACT=ONE
      IF(I.EQ.J) FACT=FACT*HALF
      IF(K.EQ.L) FACT=FACT*HALF
      FACT=FACT*Q4*dble(NFAC)
C
      GO TO (201,202,202,210),ISTYPE
C
C     ----- CLOSED SHELL SCF -----
C
  201 CONTINUE
      IFG=0
      DO 101 IXYZ=1,3
      DO 101 JXYZ=1,3
      IFG=IFG+1
      DFAC(IFG)=DFT(MIJ,IXYZ)*DFT(MKL,JXYZ)*FOUR
     1         -DFT(MIK,IXYZ)*DFT(MJL,JXYZ)-DFT(MIL,IXYZ)*DFT(MJK,JXYZ)
  101 CONTINUE
      DFAC(NMAXD)=DST(MIJ)*DST(MKL)*FOUR
     1           -DST(MIK)*DST(MJL)-DST(MIL)*DST(MJK)
      GO TO 210
C
C     ----- GENERAL OPEN SHELL SCF -----
C
  202 CONTINUE
      IFG=0
      DO 103 IXYZ=1,3
      DO 103 JXYZ=1,3
      IFG=IFG+1
      DFAC1=ZERO
      DFAC2=ZERO
      DO 102 ITYP=1,NTYPES
      DO 102 JTYP=1,NTYPES
      DFAC1=DFAC1+DF(MIJ,IXYZ,ITYP)*DF(MKL,JXYZ,JTYP)*ALP(ITYP,JTYP)
      DFAC2=DFAC2+(DF(MIK,IXYZ,ITYP)*DF(MJL,JXYZ,JTYP)
     1            +DF(MIL,IXYZ,ITYP)*DF(MJK,JXYZ,JTYP))*BET(ITYP,JTYP)
  102 CONTINUE
      DFAC(IFG)=DFAC1*TWO+DFAC2
  103 CONTINUE
      DFAC1=ZERO
      DFAC2=ZERO
      DO 105 ITYP=1,NTYPES
      DO 105 JTYP=1,NTYPES
      DFAC1=DFAC1+DS(MIJ,ITYP)*DS(MKL,JTYP)*ALP(ITYP,JTYP)
      DFAC2=DFAC2+(DS(MIK,ITYP)*DS(MJL,JTYP)+DS(MIL,ITYP)*DS(MJK,JTYP))
     1                                     *BET(ITYP,JTYP)
  105 CONTINUE
      DFAC(NMAXD)=DFAC1*TWO+DFAC2
C
  210 CONTINUE
C
      DO 107 IX=1,NMAXD
      DX=DFAC(IX)*FACT
      IF(DABS(DX).GT.DMAX) DMAX=DABS(DX)
      ABDENS(NN,IX)=DX
  107 CONTINUE
C
  109 CONTINUE
  110 CONTINUE
C
      IF(DMAX.LT.DLIM) Q4=ZERO
C
      RETURN
      END
