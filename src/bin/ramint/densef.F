      SUBROUTINE DENSEF(EAO,DF,DFT,UF)
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION EAO(NBFAO,NBASIS),UF(NBASIS,NBASIS,3)
      DIMENSION DF(NBATRI,3,NTYPEP),DFT(NBATRI,3)
      COMMON/BASIS/NBASIS,NBFAO,NBATRI,NBATR2
      COMMON/CALCS/ISTYPE,ICTYPE
      COMMON/FUNCS/NTYPES,NTYPEP,NTREAD,NATOM,N3N,NATRI,NSYM
      COMMON/MFSEC/MASTER,NSECT
      COMMON/SIGNS/IOFF(256),IPRNT
      COMMON/START/FOCC(10),NSORB(10),NSTR(10),NEND(10),MOTYP(256)
      COMMON/TAPES/ITAP30,ITAP44
      COMMON/CI101/IOPEN,IOCC,JOCC,KOCC
      DATA ZERO,TWO / 0.0D+00 , 2.0D+00 /
    1 FORMAT(//,2X,' UF MATRIX , IXYZ = ',I5/)
    2 FORMAT(//,2X,' DFT MATRIX , IXYZ = ',I5/)
    3 FORMAT(//,2X,' DF MATRIX'/)
C
C   ISTYPE = 1 : CLSCF
C   ISTYPE = 2 : GRSCF
C   ISTYPE = 3 : TCSCF
C   ISTYPE = 4 : MCSCF
C
C   READ UF MATRICES
      N3NP3=N3N+3
      NTRIL=((NBATR2-1)/NSECT+1)
      NBASQ=NBASIS*NBASIS*2
      NBASQL=((NBASQ-1)/NSECT+1)
      N3TRL=N3NP3*NTRIL
      N3QRL=N3NP3*NBASQL
      NADD=N3TRL*4
      IF(ISTYPE.EQ.2) NADD=NADD+N3QRL
C
      CALL RFILE(ITAP44)
      DO 101 IXYZ=1,3
      IFG=(IXYZ+N3N-1)*NBASQL+NADD+1
      CALL RREAD(ITAP44,UF(1,1,IXYZ),NBASQ,IFG)
      IF(IPRNT.LE.3) GO TO 101
      WRITE(6,1) IXYZ
      CALL MATOUT(UF(1,1,IXYZ),NBASIS,NBASIS,NBASIS,NBASIS,6)
  101 CONTINUE
C
C   CALCULATE THE FIELD WEIGHTED DENSITY MATRICES
      DO 105 IXYZ=1,3
      IJ=0
      DO 103 I=1,NBFAO
      DO 103 J=1,I
      IJ=IJ+1
      VALU=ZERO
      DO 102 K=1,JOCC
      DO 102 L=1,NBASIS
      FAC=EAO(I,K)*EAO(J,L)+EAO(I,L)*EAO(J,K)
      VALU=VALU+UF(L,K,IXYZ)*FAC
  102 CONTINUE
      DFT(IJ,IXYZ)=VALU*TWO
  103 CONTINUE
      IF(IPRNT.LE.3) GO TO 105
      WRITE(6,2) IXYZ
      CALL PRINT(DFT(1,IXYZ),NBATRI,NBASIS,6)
  105 CONTINUE
C
C   FORM THE FILED WEIGHTED SHELL DENSITY MATRICES
      DO 110 ITYP=1,NTYPES
      IJ=0
      COEF=FOCC(ITYP)
CCC   IF(ISTYPE.EQ.2.AND.ITYP.GT.1) COEF=COEF*FOCC(ITYP)
      IST=NSTR(ITYP)
      IED=NEND(ITYP)
      DO 108 I=1,NBFAO
      DO 108 J=1,I
      IJ=IJ+1
      DO 107 IXYZ=1,3
      VALU=ZERO
      DO 106 K=1,NBASIS
      DO 106 L=IST,IED
      FAC=EAO(I,K)*EAO(J,L)+EAO(I,L)*EAO(J,K)
      VALU=VALU+UF(K,L,IXYZ)*FAC
  106 CONTINUE
      DF(IJ,IXYZ,ITYP)=VALU*COEF
  107 CONTINUE
  108 CONTINUE
  110 CONTINUE
      DO 115 IXYZ=1,3
      DO 115 I=1,NTRI
      DF(I,IXYZ,NTYPEP)=ZERO
  115 CONTINUE
      IF(IPRNT.LE.2) GO TO 201
      WRITE(6,3)
      CALL MATOUT(DF,NBATRI,NTYPEP*3,NBATRI,NTYPEP*3,6)
C
  201 CONTINUE
      CALL SREW(ITAP44)
      RETURN
      END
